if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Config)OpenGeoportal.Config={};else if("object"!==typeof OpenGeoportal.Config)throw Error("OpenGeoportal.Config already exists and is not an object");
if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.OgpConfig=Backbone.Model.extend({url:"config/general"});OpenGeoportal.Config.General=new OpenGeoportal.Models.OgpConfig;
OpenGeoportal.Config.General.set({searchUrl:OpenGeoportal.Config.searchUrl,analyticsId:OpenGeoportal.Config.analyticsId,loginConfig:{repositoryId:OpenGeoportal.Config.loginRepository,type:OpenGeoportal.Config.loginType,url:OpenGeoportal.Config.loginUrl,secureDomain:OpenGeoportal.Config.sd}});OpenGeoportal.Config.ProxyCollection=Backbone.Collection.extend({idAttribute:"repositoryId",url:"config/proxy"});OpenGeoportal.Config.Proxies=new OpenGeoportal.Config.ProxyCollection;OpenGeoportal.Config.Proxies.fetch();
OpenGeoportal.Config.getWMSProxy=function(c,d){var a=OpenGeoportal.Config.Proxies.findWhere({repositoryId:c.toLowerCase()});if("undefined"!==typeof a&&-1<jQuery.inArray(d.toLowerCase(),a.get("accessLevels"))){var a=a.get("serverMapping"),b;for(b in a)if("wms"===a[b].type)return a[b].externalUrl}return!1};OpenGeoportal.Config.RepositoryCollection=Backbone.Collection.extend({url:"config/repositories"});OpenGeoportal.Config.Repositories=new OpenGeoportal.Config.RepositoryCollection;OpenGeoportal.Config.Repositories.fetch();
OpenGeoportal.Config.DataTypeCollection=Backbone.Collection.extend({});OpenGeoportal.Config.DataTypes=new OpenGeoportal.Config.DataTypeCollection([{value:"Point",displayName:"Point",uiClass:"pointIcon",selected:!0},{value:"Line",displayName:"Line",uiClass:"lineIcon",selected:!0},{value:"Polygon",displayName:"Polygon",uiClass:"polygonIcon",selected:!0},{value:"Raster",displayName:"Raster",uiClass:"rasterIcon",selected:!0},{value:"Paper+Map",displayName:"Scanned Map",uiClass:"mapIcon",selected:!0}]);
OpenGeoportal.Config.TopicCollection=Backbone.Collection.extend({});
OpenGeoportal.Config.IsoTopics=new OpenGeoportal.Config.TopicCollection([{topic:"",label:"None",selected:!0},{topic:"farming",label:"Agriculture and Farming"},{topic:"biota",label:"Biology and Ecology"},{topic:"boundaries",label:"Administrative and Political Boundaries"},{topic:"climatologyMeteorologyAtmosphere",label:"Atmospheric and Climatic"},{topic:"economy",label:"Business and Economic"},{topic:"elevation",label:"Elevation and Derived Products"},{topic:"environment",label:"Environment and Conservation"},
{topic:"geoscientificinformation",label:"Geological and Geophysical"},{topic:"health",label:"Human Health and Disease"},{topic:"imageryBaseMapsEarthCover",label:"Imagery and Base Maps"},{topic:"intelligenceMilitary",label:"Military"},{topic:"inlandWaters",label:"Inland Water Resources"},{topic:"location",label:"Locations and Geodetic Networks"},{topic:"oceans",label:"Oceans and Estuaries"},{topic:"planningCadastre",label:"Cadastral"},{topic:"society",label:"Cultural, Society, and Demographics"},{topic:"structure",
label:"Facilities and Structure"},{topic:"transportation",label:"Transportation Networks"},{topic:"utilitiesCommunication",label:"Utilities and Communication"}]);if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Utility)OpenGeoportal.Utility={};else if("object"!==typeof OpenGeoportal.Utility)throw Error("OpenGeoportal.Utility already exists and is not an object");OpenGeoportal.Utility.ImageLocation="resources/media/";OpenGeoportal.Utility.CssLocation="resources/css/";OpenGeoportal.Utility.JspfLocation="jspf/";
OpenGeoportal.Utility.InitSet=!1;OpenGeoportal.Utility.getImage=function(a){return OpenGeoportal.Utility.ImageLocation+a};OpenGeoportal.Utility.CurrentTab=0;OpenGeoportal.Utility.rgb2hex=function(a){function b(a){return("0"+parseInt(a).toString(16)).slice(-2)}a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return"#"+b(a[1])+b(a[2])+b(a[3])};OpenGeoportal.Utility.hexFromRGB=function(a,b,c){var d=[a.toString(16),b.toString(16),c.toString(16)];jQuery.each(d,function(a,b){1==b.length&&(d[a]="0"+b)});return d.join("").toUpperCase()};
OpenGeoportal.Utility.escapeQuotes=function(a){return a.replace("'","\\'").replace('"','\\"')};OpenGeoportal.Utility.stripExtraSpaces=function(a){return a.replace("\n","").replace(/\s+/g," ")};OpenGeoportal.Utility.loadIndicatorStatus=[];OpenGeoportal.Utility.getIndicatorStatus=function(a,b){var c=OpenGeoportal.Utility.loadIndicatorStatus,d;for(d in c)if(c[d].selector===a&&c[d].loadType===b)return c[d];return{}};
OpenGeoportal.Utility.showLoadIndicator=function(a,b,c){var d=Spinners.get(a);0===d.items().length&&(d={radius:5,height:5,width:5,dashes:8,color:"#4E4E4F"},"undefined"!==typeof c&&(d=jQuery.extend(d,c)),d=Spinners.create(a,d));d.play();c=OpenGeoportal.Utility.getIndicatorStatus(a,b);"undefined"===typeof c.currentRequests?OpenGeoportal.Utility.loadIndicatorStatus.push({selector:a,loadType:b,currentRequests:1}):c.currentRequests++;jQuery(a).fadeIn()};
OpenGeoportal.Utility.hideLoadIndicator=function(a,b){var c=OpenGeoportal.Utility.getIndicatorStatus(a,b);"undefined"!==typeof c.currentRequests&&0<c.currentRequests&&c.currentRequests--;if("undefined"===typeof c.currentRequests||0===c.currentRequests)jQuery(a).fadeOut(),c=Spinners.get(a),0!==c.items().length&&c.stop()};OpenGeoportal.Utility.checkAddress=function(a){var b=a.split("@");if(2>b.length)return!1;a=b[1].split(".");b=b[0];return 2>a.length||3>a[0].length+a[1].length+b.length?!1:!0};
OpenGeoportal.Utility.pluralSuffix=function(a){return 1<a?"s":""};OpenGeoportal.Utility.doPrint=function(){window.print()};OpenGeoportal.Utility.elementFlash=function(a,b){"undefined"===typeof b&&(b="#0755AC");var c=a.css("color");a.animate({color:b},125).animate({color:c},125).animate({color:b},125).animate({color:c},125)};
OpenGeoportal.Utility.getScrollbarWidth=function(){if(!OpenGeoportal.Utility.requiresScrollbarAdjustment())return 0;var a,b;a=document.createElement("div");b=a.style;b.position="absolute";b.width="100px";b.height="100px";b.overflow="scroll";b.top="-9999px";document.body.appendChild(a);b=a.offsetWidth-a.clientWidth;document.body.removeChild(a);return b};OpenGeoportal.Utility.requiresScrollbarAdjustment=function(){return 0<window.navigator.userAgent.indexOf("Macintosh")?!1:!0};
OpenGeoportal.Utility.removeParams=function(a,b){var c=a.split("?"),d=c[1].split("\x26"),e;for(e in d)for(var f in b)0===d[e].indexOf(b[f])&&(d[e]="");return c[0]+"?"+d.join("\x26")};OpenGeoportal.Utility.compareUrls=function(a,b,c){a=OpenGeoportal.Utility.removeParams(a,c);b=OpenGeoportal.Utility.removeParams(b,c);return a===b?!0:!1};OpenGeoportal.Utility.hasOneOf=function(a,b){var c=!1,d;for(d in b)_.has(b,d)&&(c=c||_.has(a,b[d]));return c};
OpenGeoportal.Utility.getLocationValue=function(a,b){var c=null,d;for(d in b)if(_.has(b,d)&&_.has(a,b[d])){c=a[b[d]];break}_.isArray(c)&&(c=c[0]);return c};OpenGeoportal.Utility.getArrayToLower=function(a){var b=[];_.each(a,function(a){b.push(a.toLowerCase())});return b};OpenGeoportal.Utility.arrayContainsIgnoreCase=function(a,b){var c=OpenGeoportal.Utility.getArrayToLower(a),d=b.toLowerCase();return 0<=_.indexOf(c,d)};
OpenGeoportal.Utility.hasLocationValueIgnoreCase=function(a,b){var c=OpenGeoportal.Utility.getArrayToLower(_.keys(a)),d=OpenGeoportal.Utility.getArrayToLower(b),e=!1,f;for(f in d)_.has(d,f)&&0<=_.indexOf(c,d[f])&&(e=!0);return e};OpenGeoportal.Utility.hasLocationValue=function(a,b){return!_.isNull(OpenGeoportal.Utility.getLocationValue(a,b))};OpenGeoportal.Utility.calculateTextAreaRows=function(a){a=a.length;var b=1;75<a&&(b=Math.floor(a/40));return b};
OpenGeoportal.Utility.anchorsToNiceScroll=function(a,b){jQuery("#"+a+" a.niceScroll").click(function(c){c.preventDefault();c=jQuery(this).attr("href");jQuery("#"+a).scrollTo(jQuery(c),{offset:b})})};if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Template=function(){this.cartHeader=_.template('\x3cdiv id\x3d"optionDetails" class\x3d"shadowDown"\x3e\x3cdiv id\x3d"optionText"\x3e\x3c/div\x3e\x3c/div\x3e');var a;a='\x3cdiv class\x3d"tableHeaders"\x3e\x3c% _.each(headers, function(col) { %\x3e\x3cdiv class\x3d"tableCell \x3c%\x3d col.columnClass %\x3e"\x3e\x3c%\x3d col.header %\x3e\x3c/div\x3e\x3c% }); %\x3e\x3c/div\x3e';this.tableHeader=_.template(a);this.tableView=_.template('\x3cdiv class\x3d"tableWrapper"\x3e\x3c%\x3d tableHeader %\x3e\x3cdiv class\x3d"rowContainer"\x3e\x3c%\x3d tableFooter %\x3e\x3c/div\x3e\x3c/div\x3e');
this.genericDiv=_.template('\x3cdiv id\x3d"\x3c%\x3d elId %\x3e" class\x3d"\x3c%\x3d elClass %\x3e" \x3e\x3c/div\x3e');this.divNoId=_.template('\x3cdiv class\x3d"\x3c%\x3d elClass %\x3e" \x3e\x3c/div\x3e');a='\x3cdiv id\x3d"\x3c%\x3d mapId %\x3eOLMap"\x3e'+this.genericDiv({elId:"nwCorner",elClass:"corner slideHorizontal"})+this.genericDiv({elId:"neCorner",elClass:"corner"})+this.genericDiv({elId:"swCorner",elClass:"corner slideHorizontal"})+this.genericDiv({elId:"seCorner",elClass:"corner"})+"\x3c/div\x3e";
this.map=_.template('\x3cdiv id\x3d"mapToolBar"\x3e\x3cdiv id\x3d"ogpMapButtons"\x3e\x3c/div\x3e\x3c/div\x3e'+a);this.mapButton=_.template('\x3cbutton class\x3d"mapStyledButton \x3c%\x3d displayClass %\x3e" title\x3d"\x3c%\x3d title %\x3e" \x3e\x3c%\x3d buttonText %\x3e\x3c/button\x3e');this.basemapMenu=_.template('\x3cdiv id\x3d"basemapMenu"\x3e\x3c/div\x3e');this.loadIndicator=_.template('\x3cdiv class\x3d"loadIndicator"\x3e\x3c/div\x3e');this.requestIndicator=_.template('\x3cdiv class\x3d"raised"\x3e\x3cdiv id\x3d"processingIndicator" class\x3d"loadIndicator"\x3e\x3c/div\x3e\x3cdiv id\x3d"requestTicker" class\x3d"loadInfo"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e');
this.styledSelectBody=_.template('\x3cdiv class\x3d"styledSelect"\x3e\x3cdiv\x3e\x3cbutton class\x3d"select"\x3e\x3c%\x3d obj.buttonLabel %\x3e\x3c/button\x3e\x3c%\x3d obj.caption %\x3e\x3c/div\x3e\x3cul\x3e\x3c%\x3d obj.menuHtml %\x3e\x3c/ul\x3e\x3c/div\x3e');this.selectAllCaption=_.template('\x3cdiv class\x3d"showAll offsetColor button"\x3eselect all\x3c/div\x3e');this.simpleMenuItem=_.template('\x3cli\x3e\x3ca class\x3d"\x3c%\x3d className %\x3e"\x3e\x3c%\x3d name %\x3e\x3c/a\x3e\x3cinput type\x3d"hidden" value\x3d"\x3c%\x3d value %\x3e" /\x3e\x3c/li\x3e');
this.showOnlyControl=_.template('\x3cdiv class\x3d"showOnly button offsetColor"\x3eonly\x3c/div\x3e');this.controlMenuItem=_.template('\x3cli\x3e\x3ca class\x3d"\x3c%\x3d className %\x3e"\x3e\x3c%\x3d icon %\x3e\x3cdiv class\x3d"selectText"\x3e\x3c%\x3d name %\x3e\x3c/div\x3e\x3c%\x3d control %\x3e\x3c/a\x3e\x3cinput type\x3d"hidden" value\x3d"\x3c%\x3d value %\x3e" /\x3e\x3c/li\x3e');this.genericButton=_.template('\x3cbutton id\x3d"\x3c%\x3d buttonId %\x3e" class\x3d"button"\x3e\x3c%\x3d buttonLabel %\x3e\x3c/button\x3e');
this.dialogHeaderButton=_.template('\x3cbutton id\x3d"\x3c%\x3d buttonId %\x3e" class\x3d"\x3c%\x3d displayClass %\x3e button"\x3e\x3c%\x3d buttonLabel %\x3e\x3c/button\x3e');this.previewToolsContainer=_.template('\x3ctr class\x3d"controls"\x3e\x3ctd class\x3d"previewTools" colspan\x3d"\x3c%\x3dcolspan%\x3e"\x3e\x3cdiv\x3e\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e');this.cartPreviewToolsContainer=_.template('\x3cdiv class\x3d"controls"\x3e\x3cdiv class\x3d"previewTools" \x3e\x3cdiv\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e');
this.previewTools=_.template('\x3cdiv class\x3d"previewControls"\x3e\x3c%\x3dtoolsMarkup%\x3e\x3c/div\x3e');a='\x3cdiv class\x3d"\x3c%\x3dcontrolClass%\x3e"\x3e\x3cdiv class\x3d"sliderControl"\x3e\x3cdiv class\x3d"sliderDisplay"\x3e';a+='\x3cspan class\x3d"sliderLabel"\x3e\x3c%\x3dlabel%\x3e:\x3c/span\x3e';a+='\x3cspan class\x3d"sliderValue"\x3e\x3c%\x3dvalue%\x3e\x3c/span\x3e';a+='\x3cspan class\x3d"sliderUnits"\x3e\x3c%\x3dunits%\x3e\x3c/span\x3e';a+="\x3c/div\x3e";a+='\x3cdiv class\x3d"sliderArrow button"\x3e\x3c/div\x3e';
a+='\x3cdiv class\x3d"controlContainer"\x3e';a+='\x3cdiv class\x3d"previewToolsSlider" title\x3d"\x3c%\x3dtooltip%\x3e"\x3e\x3c/div\x3e';a+="\x3c/div\x3e";a+="\x3c/div\x3e\x3c/div\x3e";this.sliderControl=_.template(a);this.colorControl=_.template('\x3cdiv class\x3d"colorControlCell"\x3e\x3cdiv class\x3d"colorControl button" title\x3d"Change the layer color" style\x3d"background-color:\x3c%\x3dcolor%\x3e"\x3e\x3c/div\x3e\x3c/div\x3e');this.zoomControl=_.template('\x3cdiv class\x3d"button zoomToLayerControl" title\x3d"Zoom to geographic extent of layer"\x3e\x3c/div\x3e');
this.getFeatureControl=_.template('\x3cdiv class\x3d"button attributeInfoControl \x3c%\x3dtoolClass%\x3e" title\x3d"Click a previewed feature on the map to view its attributes"\x3e\x3c/div\x3e');this.genericControl=_.template('\x3cdiv class\x3d"button \x3c%\x3d controlClass %\x3e \x3c%\x3ddisplayClass%\x3e" title\x3d"\x3c%\x3d tooltip %\x3e"\x3e\x3c%\x3d text %\x3e\x3c/div\x3e');this.genericIcon=_.template('\x3cdiv class\x3d"\x3c%\x3d controlClass %\x3e \x3c%\x3d displayClass %\x3e" title\x3d"\x3c%\x3d tooltip %\x3e"\x3e\x3c%\x3d text %\x3e\x3c/div\x3e');
this.genericDialogShell=_.template('\x3cdiv id\x3d"\x3c%\x3d elId %\x3e" class\x3d"dialog"\x3e\x3c/div\x3e');this.genericIframe=_.template('\x3ciframe class\x3d"\x3c%\x3d iframeClass%\x3e" src\x3d"\x3c%\x3d iframeSrc %\x3e" /\x3e');this.toMetadataTop=_.template('\x3cdiv id\x3d"toMetadataTop"\x3e\x3c/div\x3e');this.metadataContent=_.template('\x3cdiv id\x3d"metadataContent"\x3e\x3c/div\x3e\x3cdiv id\x3d"metadataFooter"\x3e\x3c%\x3d layerId %\x3e\x3c/div\x3e');this.iframeDownload=_.template('\x3ciframe class\x3d"\x3c%\x3d iframeClass%\x3e" src\x3d"\x3c%\x3d iframeSrc %\x3e" onload\x3d"jQuery(document).trigger(\'iframeload\')"/\x3e');
this.defaultDownloadCheckbox=_.template('\x3cinput type\x3d"checkbox" class\x3d"cartCheckBox" \x3c% if ( isChecked ) { %\x3echecked\x3c% } %\x3e /\x3e');this.emptyTable=_.template('\x3cdiv class\x3d"emptyTable"\x3e\x3c%\x3d message %\x3e\x3c/div\x3e');this.attributeTable=_.template('\x3ctable class\x3d"attributeInfo"\x3e\x3ccaption class\x3d"getFeatureTitle offsetColor" title\x3d"\x3c%\x3d layerId %\x3e"\x3e\x3c%\x3d title %\x3e\x3c/caption\x3e\x3c% _.each(tableContent, function(rowObj) { %\x3e\x3ctr\x3e\x3ctd class\x3d"attributeName" \x3e\x3c%\x3d rowObj.header %\x3e\x3c/td\x3e\x3c%  _.each(rowObj.values, function(value) { %\x3e\x3ctd\x3e\x3c%\x3d value %\x3e\x3c/td\x3e \x3c% }); %\x3e\x3c/tr\x3e\x3c% }); %\x3e\x3c/table\x3e');
this.tableCell=_.template('\x3ctd class\x3d"\x3c%\x3d colClass %\x3e"\x3e\x3cdiv class\x3d"cellWrapper"\x3e\x3c%\x3d contents %\x3e\x3c/div\x3e\x3c/td\x3e');this.textTableCell=_.template('\x3ctd class\x3d"\x3c%\x3d colClass %\x3e"\x3e\x3cdiv class\x3d"cellWrapper" title\x3d"\x3c%\x3d contents %\x3e"\x3e\x3c%\x3d contents %\x3e\x3c/div\x3e\x3c/td\x3e');this.cartCell=_.template('\x3cdiv class\x3d"tableCell \x3c%\x3d colClass %\x3e"\x3e\x3c%\x3d contents %\x3e\x3c/div\x3e');this.textCartCell=_.template('\x3cdiv class\x3d"tableCell \x3c%\x3d colClass %\x3e" title\x3d"\x3c%\x3d contents %\x3e"\x3e\x3cdiv class\x3d"cellWrapper"\x3e\x3c%\x3d contents %\x3e\x3c/div\x3e\x3c/div\x3e');
a='\x3clabel for\x3d"\x3c%\x3d controlId %\x3e" class\x3d"\x3c%\x3d controlClass %\x3e"\x3e\x3c%\x3d controlLabel %\x3e\x3c/label\x3e\x3cselect id\x3d"\x3c%\x3d controlId %\x3e" class\x3d"\x3c%\x3d controlClass %\x3e"\x3e\x3c% _.each(formats, function(formatEl) { %\x3e\x3coption value\x3d"\x3c%\x3d formatEl.formatType %\x3e"\x3e\x3c%\x3d formatEl.formatDisplay %\x3e\x3c/option\x3e\x3c% }); %\x3e';a+="\x3c/select\x3e\x3cbr/\x3e";this.formatSelectionControl=_.template(a);this.clipControl=_.template('\x3cinput id\x3d"checkClip" type\x3d"checkbox" checked\x3d"checked" /\x3e\x3clabel for\x3d"checkClip" id\x3d"checkClipLabel"\x3eClip data to map extent\x3c/label\x3e\x3cbr/\x3e \n');
a='\x3cdiv\x3e\x3clabel for\x3d"emailAddress"\x3eYou have selected some layers that require an email address. Please enter your email to receive a download link:\x3c/label\x3e\x3cbr /\x3e\n\x3cinput id\x3d"emailAddress" type\x3d"text" /\x3e\x3c/div\x3e\n\x3cspan id\x3d"emailValidationError" class\x3d"warning"\x3e\x3c/span\x3e';this.requireEmailAddress=_.template(a);a="\x3cdiv\x3eYou have selected \x3c%\x3d total %\x3e layer\x3c% if ( plural ) { %\x3es\x3c% } %\x3e for download.\x3c/div\x3e\x3c% if (downloadCount \x3e 0){ if ( emailCount \x3d\x3d\x3d 0){%\x3e\x3cdiv\x3eA zip file will be generated with your layers. \x3c% } else { %\x3e\x3cdiv\x3eA zip file will be generated with layers directly downloadable by the OpenGeoportal site. \x3c% } %\x3e";
a+="It may take several minutes to process your layers.\x3cbr /\x3e ";a+='\x3cspan class\x3d"notice"\x3eDo not close the OpenGeoportal website until the process is complete, or you will lose your download.\x3c/span\x3e\x3c/div\x3e\x3c%}';a+=" if (emailCount \x3e 0){ if ( downloadCount \x3d\x3d\x3d 0) {%\x3e\x3cbr/\x3e\x3cdiv\x3eYou will be emailed a link to your layers within the next few minutes. \x3c/div\x3e\x3c% } else { %\x3e";a+="\x3cbr/\x3e\x3cdiv\x3eYou will be emailed a link to layers not directly downloadable by the OpenGeoportal site within the next few minutes. \x3c/div\x3e\x3c% }} %\x3e";
this.layerDownloadNotice=_.template(a);a='\x3cspan class\x3d"sub_headerTitle"\x3e\x3c%\x3d wmc.title %\x3e\x3c/span\x3e\x3cbr/\x3e\x3cspan\x3e\x3c%\x3d wmc.caption %\x3e\x3c/span\x3e\x3cdiv class\x3d"owsServicesLinkContainer"\x3e\x3clabel for\x3d"\x3c%\x3d wmc.preferenceElId %\x3e"\x3e\x3c%\x3d wmc.preferenceText %\x3e\x3c/label\x3e\x3cselect id\x3d"\x3c%\x3d wmc.preferenceElId %\x3e"\x3e';a+='\x3c% _.each(wmc.preference, function(type) { %\x3e\x3coption value\x3d"\x3c%\x3d type.value %\x3e"\x3e\x3c%\x3d type.label %\x3e\x3c/option\x3e\x3c% }); %\x3e\x3c/select\x3e';
a+='\x3cdiv id\x3d"\x3c%\x3d wmc.generateButtonId %\x3e" class\x3d"button"\x3eGenerate WMC\x3c/div\x3e';a+="\x3cbr/\x3e\x3c/div\x3e\x3cbr/\x3e";var b;b='\x3c% _.each(webservices, function(serviceInfo){ %\x3e\x3cspan class\x3d"sub_headerTitle"\x3e\x3c%\x3d serviceInfo.title %\x3e\x3c/span\x3e\x3cbr/\x3e\x3cspan\x3e\x3c%\x3d serviceInfo.caption %\x3e\x3c/span\x3e\x3cdiv class\x3d"owsServicesLinkContainer"\x3e\x3ctextarea class\x3d"shareServicesText linkText" \x3e\x3c%\x3d serviceInfo.url %\x3e\x3c/textarea\x3e \x3cbr /\x3e\x3c/div\x3e\x3cbr/\x3e\x3c% }); %\x3e';
b='\x3cdiv id\x3d"owsServicesArea"\x3e'+b;b+=a;this.webServicesDialogContent=_.template(b+"\x3c/div\x3e");this.infoBubble=_.template('\x3cdiv id\x3d"\x3c%\x3d elId %\x3e" class\x3d"infoBubbleBackground triangle-isoscelesBackground \x3c%\x3d arrowDirection %\x3eBackground"\x3e\x3cdiv class\x3d"infoBubbleText triangle-isosceles \x3c%\x3d arrowDirection %\x3e"\x3e\x3cbutton class\x3d"closeBubble button"\x3e\x3c/button\x3e\x3c%\x3d content %\x3e\x3clabel\x3e\x3cinput type\x3d"checkbox"/\x3eDo not show this screen again\x3c/label\x3e\x3c/div\x3e\x3c/div\x3e');
this.welcomeText=_.template('\x3cdiv id\x3d"welcomeText" class\x3d"welcomeText"\x3e\x3ch1\x3eWelcome\x3c/h1\x3e\x3cp\x3eThere are two ways to begin your search:\x3c/p\x3e\x3col\x3e\x3cli\x3eEnter information using one or both search fields.\x3c/li\x3e\x3cli\x3eZoom in on a location using the map.\x3c/li\x3e\x3c/ol\x3e\x3c/div\x3e');this.directionsText=_.template('\x3cdiv id\x3d"directionsText" class\x3d"directionsText"\x3e\x3cspan\x3eYou can preview layers by clicking on the \'View\' checkbox.\x3c/span\x3e\x3cbr/\x3e\x3cbr/\x3e\x3cspan\x3eLayers can be added to the \'Cart\' by clicking on the \x3c/span\x3e\x3cdiv class\x3d"saveControl notInCart exampleControl"\x3e\x3c/div\x3e\x3cspan\x3e button.\x3c/span\x3e\x3c/div\x3e')};if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Analytics=function(){function c(){var a=OpenGeoportal.Config.General.get("analyticsId");if(a){window._gaq.push(["_setAccount",a]);window._gaq.push(["_trackPageview"]);a=document.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}}var b;window._gaq||(window._gaq=[]);return function(){b||(b=c()||!0);
this.track=function(){var a=["_trackEvent"],a=a.concat(Array.prototype.slice.call(arguments,0,4));window._gaq.push(a)}}}();if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Widgets=function(){this.template=OpenGeoportal.ogp.template;this.appendButton=function(a,b,c,d){c=this.template.genericButton({buttonId:b,buttonLabel:c});jQuery(c).appendTo(a).hide();a=jQuery("#"+b);a.button({create:function(a,b){jQuery(this).show()}}).on("click",d);return a};this.prependButton=function(a,b,c,d){c=this.template.genericButton({buttonId:b,buttonLabel:c});jQuery(c).prependTo(a).hide();a=jQuery("#"+b);a.button({create:function(a,b){jQuery(this).show()}}).on("click",d);return a};
this.genericModalDialog=function(a,b){var c="genericModalDialog"+jQuery(".genericModalDialog").size(),d;d='\x3cdiv id\x3d"'+c+'" class\x3d"dialog genericModalDialog"\x3e'+a;d+="\x3c/div\x3e";jQuery("#dialogs").append(d);jQuery("#"+c).dialog({zIndex:2999,title:b,resizable:!0,modal:!0,minWidth:415,autoOpen:!1});return jQuery("#"+c).dialog("open")};this.dialogTemplate=function(a,b,c,d){"undefined"===typeof jQuery("#"+a)[0]?(b='\x3cdiv id\x3d"'+a+'" class\x3d"dialog"\x3e \n'+b,b+="\x3c/div\x3e\n",jQuery("#dialogs").append(b),
jQuery("#"+a).dialog({zIndex:3E3,autoOpen:!1,width:"auto",title:c,resizable:!0,buttons:d})):(jQuery("#"+a).html(b),jQuery("#"+a).dialog("option","buttons",d));jQuery("#"+a).dialog("open")};this.iframeDownload=function(a,b){var c=this.template.iframeDownload({iframeClass:a,iframeSrc:b}),d=jQuery(c).appendTo("#iframes");jQuery(document).on("iframeload",d,function(){setTimeout(function(){d.remove()},12E4)})}};if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Geocoder=function(){this.geocoder=new google.maps.Geocoder;this.getGeocodePromise=function(d){var c=new jQuery.Deferred,e=this;this.geocoder.geocode({address:d},function(f,b){var a=e.processGeocoderResults(f,b);c.resolve(a)});return c.promise()};this.processGeocoderResults=function(d,c){var e={labels:[],values:[]};if("OK"===c)for(var f in d){var b=d[f].geometry.viewport,a=[];a.push(b.getSouthWest().lng());a.push(b.getSouthWest().lat());a.push(b.getNorthEast().lng());a.push(b.getNorthEast().lat());
var b=a.join(),a=d[f].formatted_address,g={};g.name=a;g.bbox=b;g.fullResponse=d[f];e.values.push(g);e.labels.push(a)}else"ZERO_RESULTS"===c?e.labels.push("No results found."):e.labels.push("Error retrieving results.");return e};this.geocodeAutocomplete=function(d){var c={},e=this;d.autocomplete({source:function(f,b){geocodePromise=e.getGeocodePromise(f.term);jQuery.when(geocodePromise).then(function(a){c=a;b(c.labels)})},minLength:3,delay:200,select:function(f,b){for(var a in c.values)if(c.values[a].name===
b.item.value){d.data({geocode:c.values[a]});break}},open:function(){jQuery(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){jQuery(this).removeClass("ui-corner-top").addClass("ui-corner-all")}});d.autocomplete().data("ui-autocomplete")._renderMenu=function(c,b){var a=this;jQuery.each(b,function(b,d){a._renderItemData(c,d)});jQuery('\x3cli class\x3d"searchAttribution"\x3e\x3cdiv class\x3d"poweredByGoogleAttr"\x3e\x3c/div\x3e\x3c/li\x3e').appendTo(c).removeClass("ui-widget-content ui-menu-divider")}}};if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.MetadataViewer=function(){this.template=OpenGeoportal.ogp.template;this.viewMetadata=function(a){var c=a.get("Location");a=a.get("LayerId");var b=["metadataLink","purl","libRecord"];OpenGeoportal.Utility.hasLocationValue(c,b)?(c=OpenGeoportal.Utility.getLocationValue(c,b),this.viewExternalMetadata(a,c)):this.viewMetadataFromOgp(a)};this.viewExternalMetadata=function(a,c){var b=this.template.genericIframe({iframeSrc:c,iframeClass:"metadataIframe"});this.renderMetadataDialog(a,b).dialog("open")};
this.viewMetadataFromOgp=function(a){try{var c=null;jQuery.ajax({url:"getMetadata",data:{id:a},async:!1,success:function(a){c=a}});var b=this.renderMetadataDialog(a,c);this.addMetadataDownloadButton(b,a);this.addScrollMetadataToTop();b.dialog("open")}catch(d){throw console.log(d),Error("Error opening the metadata dialog.");}};this.renderMetadataDialog=function(a,c){"undefined"==typeof jQuery("#metadataDialog")[0]&&jQuery("#dialogs").append(this.template.genericDialogShell({elId:"metadataDialog"}));
var b=jQuery("#metadataDialog");b.html(this.template.metadataContent({layerId:a})).find("#metadataContent").append(c);try{b.dialog("destroy")}catch(d){}b.dialog({zIndex:9999,width:630,height:400,title:"Metadata",autoOpen:!1});return b};this.addScrollMetadataToTop=function(){var a=jQuery("#metadataContent");a.prepend(this.template.toMetadataTop());a[0].scrollTop=0;a.find("a").click(function(c){var b=jQuery(this).attr("href");0==b.indexOf("#")&&(c.preventDefault(),b=b.substring(1),a.scrollTo(jQuery('[name\x3d"'+
b+'"]')))});jQuery("#toMetadataTop").on("click",function(){jQuery("#metadataContent")[0].scrollTop=0})};this.addMetadataDownloadButton=function(a,c){0==jQuery("#metadataDownloadButton").length&&(a.parent().find(".ui-dialog-titlebar").first().prepend(this.template.dialogHeaderButton({displayClass:"ui-titlebar-button",buttonId:"metadataDownloadButton",buttonLabel:"Download Metadata (XML)"})),jQuery("#metadataDownloadButton").button());jQuery("#metadataDownloadButton").off();var b=this;jQuery("#metadataDownloadButton").on("click",
function(){b.downloadMetadata(c)})};this.downloadMetadata=function(a){this.iframeDownload("metadataDownloadIframe","getMetadata/xml?download\x3dtrue\x26id\x3d"+a)};this.iframeDownload=function(a,c){var b=this.template.iframeDownload({iframeClass:a,iframeSrc:c}),d=jQuery(b).appendTo("#iframes");jQuery(document).on("iframeload",d,function(){setTimeout(function(){d.remove()},12E4)})};this.viewMetadataJsonpError=function(){throw Error("The attempt to retrieve metadata for this layer failed.");};this.goToExternal=
function(a){window.open(a)}};if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.TableItems=function(){var d=OpenGeoportal.ogp.template;this.renderTypeIcon=function(a){var b=OpenGeoportal.Config.DataTypes,c={controlClass:"typeIcon"};"undefined"==typeof a||null===a?(c.displayClass="undefinedType",c.tooltip="Unspecified",c.text="?"):("Paper Map"==a&&(a="Paper+Map"),a=b.findWhere({value:a}),"undefined"==typeof a?(c.displayClass="undefinedType",c.tooltip="Unspecified",c.text="?"):(c.displayClass=a.get("uiClass"),c.tooltip=a.get("displayName"),c.text=""));return d.genericIcon(c)};
this.renderExpandControl=function(a){var b={text:"",controlClass:"expandControl"};a?(b.displayClass="expanded",b.tooltip="Hide preview controls"):(b.displayClass="notExpanded",b.tooltip="Show preview controls");return d.genericControl(b)};this.renderPreviewControl=function(a,b,c,d){return a?b?this.renderCheckboxPreviewControl(d):c?this.renderLoginPreviewControl():this.renderLinkControl():""};this.renderLinkControl=function(){return d.genericControl({controlClass:"previewLink",text:"",tooltip:"Preview layer at external site.",
displayClass:""})};this.renderLoginPreviewControl=function(){return d.genericControl({controlClass:"loginButton",text:"",tooltip:"Login to access this layer",displayClass:"login"})};this.renderCheckboxPreviewControl=function(a){var b={controlClass:"previewControl",text:""};switch(a){case !1:b.tooltip="Preview layer on the map";b.displayClass="checkOff";break;case !0:b.tooltip="Turn off layer preview on the map",b.displayClass="checkOn"}return d.genericControl(b)};this.renderDate=function(a){if("undefined"===
typeof a)return"";4<a.length&&(a=a.substr(0,4));"0001"===a&&(a="?");return a};this.renderRepositoryIcon=function(a){if("undefined"===typeof a||null===a||0===a.length)return"";a=a.toLowerCase();var b={tooltip:"",displayClass:"undefinedInstitution",controlClass:"repositoryIcon",text:"?"};a=OpenGeoportal.Config.Repositories.get(a);"undefined"!==typeof a&&(b.tooltip=a.get("fullName"),b.displayClass=a.get("iconClass"),b.text="");return d.genericIcon(b)};this.renderSaveControl=function(a){var b={controlClass:"saveControl",
text:""};!0===a?(b.tooltip="Remove this layer from your cart.",b.displayClass="inCart"):(b.tooltip="Add this layer to your cart for download.",b.displayClass="notInCart");return d.genericControl(b)};this.renderMetadataControl=function(){return d.genericControl({controlClass:"infoControl",text:"",displayClass:"viewMetadataControl",tooltip:"Show metadata"})};this.renderDownloadControl=function(a){return d.defaultDownloadCheckbox({isChecked:a})}};if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Solr=function(){this.getServerName=function(){var a=OpenGeoportal.Config.General.get("searchUrl").split(",")[0];0==a.indexOf("http://")||0==a.indexOf("https://")||(a="http://"+a);!1==("select"==a.substring(a.length-6))&&(a+="select");return a};this.getShardServerNames=function(){var a=OpenGeoportal.Config.General.get("searchUrl").split(","),b="";if(1==a.length)return b;for(var c=0;c<a.length;c++)0==a[c].indexOf("http://")&&(a[c]=a[c].substr(7)),!0==("select"==a[c].substring(a[c].length-
6))&&(a[c]=a[c].substring(0,a[c].length-6)),0<b.length&&(b+=","),b+=a[c];return"shards\x3d"+b};this.ignoreSpatial=!1;this.setIgnoreSpatial=function(a){this.ignoreSpatial=a};this.getSearchParams=function(){this.textParams=this.getOgpTextSearchParams();this.spatialParams={};this.ignoreSpatial||(this.spatialParams=this.getOgpSpatialQueryParams(this.bounds));this.baseParams={wt:"json",defType:"edismax",fl:this.getReturnedColumns(this.SearchRequest),sort:this.getSortClause()};return this.combineParams(this.baseParams,
this.spatialParams,this.textParams)};this.combineParams=function(){var a={},b;for(b in arguments){var c=arguments[b],d;for(d in c)if("undefined"===typeof a[d]||0===a[d].length)a[d]=c[d];else if(jQuery.isArray(a[d]))if(jQuery.isArray(c[d]))for(var e in c[d])a[d].push(c[d][e]);else a[d].push(c[d]);else a[d]=c[d]}return a};this.SortAscending="asc";this.SortOrder=this.SortDescending="desc";this.SortColumn="score";this.setSort=function(a,b){"asc"!==b&&"desc"!==b&&(b=this.SortOrder);null===a?a=this.SortColumn:
_.contains(["score","ContentDate","Access"],a)||(a+="Sort");this.SortColumn=a;this.SortOrder=b};this.getSortClause=function(){return this.SortColumn+" "+this.SortOrder};this.SearchRequest="Search";this.MetadataRequest="FgdcText";this.CountRequest="CountOnly";this.SearchRequestColumns="Name Institution Access DataType LayerDisplayName Publisher GeoReferenced Originator Location MinX MaxX MinY MaxY ContentDate LayerId score WorkspaceName CollectionId Availability".split(" ");this.getReturnedColumns=
function(a){var b="";return b=a==this.MetadataRequest?"LayerId,FgdcText":a==this.CountRequest?"":a==this.SearchRequest?this.SearchRequestColumns.join():"error in this.getReturnedColumnsClause did not understand passed requestType "+a};this.getURL=function(){var a=jQuery.param(this.getSearchParams(),!0);return this.getServerName()+"?"+a};this.getOgpTextSearchParams=function(){var a=this.getTerms();return{qf:a.fields.join(" "),q:a.userTerms||"*",fq:this.filters}};this.SearchType="basic";this.setSearchType=
function(a){this.SearchType=a};this.getTerms=function(){var a=this.SearchType,b={};if("advanced"===a)b.userTerms=this.getAdvancedKeywords(),b.fields=this.getAdvancedKeywordTermsArr();else if("basic"===a)b.userTerms=this.what,b.fields=this.getBasicKeywordTermsArr();else throw Error("Search type '"+a+"' is unsupported.");return b};this.setWhat=function(a){this.what=a};this.setWhere=function(a){this.where=a};this.AdvancedKeywordString=null;this.setAdvancedKeywords=function(a){this.AdvancedKeywordString=
a};this.getAdvancedKeywords=function(){return this.AdvancedKeywordString};this.LayerDisplayNameTerm={basic:{term:"LayerDisplayNameSynonyms",boost:0.2},advanced:{term:"LayerDisplayNameSynonyms",boost:0.2}};this.ThemeKeywordsTerm={term:"ThemeKeywordsSynonymsLcsh",boost:0.1};this.PlaceKeywordsTerm={term:"PlaceKeywordsSynonyms",boost:0.1};this.PublisherTerm={term:"Publisher",boost:0.1};this.OriginatorTerm={term:"Originator",boost:0.1};this.IsoTopicTerm={term:"ThemeKeywordsSynonymsIso",boost:0.1};this.BasicKeywordTerms=
[this.LayerDisplayNameTerm,this.IsoTopicTerm,this.ThemeKeywordsTerm,this.PlaceKeywordsTerm,this.PublisherTerm,this.OriginatorTerm];this.AdvancedKeywordTerms=[this.LayerDisplayNameTerm,this.ThemeKeywordsTerm,this.PlaceKeywordsTerm];this.getKeywordTerms=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.hasOwnProperty(b)&&(e=e[b]);c.push(e.term+"^"+e.boost)}return c};this.getBasicKeywordTermsArr=function(){return this.getKeywordTerms(this.BasicKeywordTerms,"basic")};this.getAdvancedKeywordTermsArr=
function(){return this.getKeywordTerms(this.AdvancedKeywordTerms,"advanced")};this.filters=[];this.createFilter=function(a,b,c,d){if("undefined"===typeof b||0===b.length)return"";jQuery.isArray(b)||(b=[b]);var e=[];for(c=0;c<b.length;c++)e.push(a+":"+b[c]);if("undefined"===typeof d)d="OR";else if("OR"!=d&&"AND"!=d)throw Error("clause must be joined with 'AND' or 'OR'.");return e.join(" "+d+" ")};this.createRangeFilter=function(a,b,c,d){"undefined"===typeof d&&(d="");return d+(a+":["+b+" TO "+c+"]")};
this.addFilter=function(a){0<a.length&&this.filters.push(a)};this.createAccessFilter=function(a){a=this.createFilter("Institution",a);0<a.length&&(a+=" OR Access:Public");return a};this.filterDateValue=function(a){if(null==a||""==a)return"";if(!jQuery.isNumeric(a))throw Error("Year must be numeric");var b=a.length;if(4<b)throw Error("Year cannot be more than 4 digits.");return 4==b?a:3==b?"0"+a:2==b?"00"+a:1==b?"000"+a:""};this.createDateRangeFilter=function(a,b,c){b=this.filterDateValue(b);c=this.filterDateValue(c);
if((null==b||""==b)&&(null==c||""==c))return"";b=(b||"0001")+"-01-01T01:01:01Z";c=(c||"2100")+"-01-01T01:01:01Z";return this.createRangeFilter(a,b,c)};this.LayerWithinMap={term:"LayerWithinMap",boost:80};this.LayerMatchesScale={term:"LayerMatchesScale",boost:70};this.LayerMatchesCenter={term:"LayerMatchesCenter",boost:15};this.LayerAreaIntersection={term:"LayerAreaIntersection",boost:30};this.getOgpSpatialQueryParams=function(a){return{bf:[this.classicLayerMatchesArea(a)+"^"+this.LayerMatchesScale.boost,
this.classicLayerAreaIntersectionScore(a)+"^"+this.LayerAreaIntersection.boost,this.classicCenterRelevancyClause()+"^"+this.LayerMatchesCenter.boost,this.classicLayerWithinMap(a)+"^"+this.LayerWithinMap.boost],fq:[this.getIntersectionFilter()],intx:this.getIntersectionFunction(a)}};this.getIntersectionFilter=function(){return"{!frange l\x3d0 incl\x3dfalse cache\x3dfalse}$intx"};this.getIntersectionFunction=function(a){var b=function(a,b,c,d){return"max(0,sub(min("+c+","+d+"),max("+a+","+b+")))"},
c;if(a.minX>a.maxX){c=b(a.minX,"MinX",180,"MaxX");var d=b(-180,"MinX",a.maxX,"MaxX");c="sum("+c+","+d+")"}else c=b(a.minX,"MinX",a.maxX,"MaxX");a=b(a.minY,"MinY",a.maxY,"MaxY");return"product("+c+","+a+")"};this.layerNearCenterClause=function(a,b,c){return"recip(abs(sub(product(sum("+b+","+c+"),.5),"+a+")),1,1000,1000)"};this.classicCenterRelevancyClause=function(){var a=this.getCenter(),b="sum("+this.layerNearCenterClause(a.centerX,"MinX","MaxX")+",";return b+=this.layerNearCenterClause(a.centerY,
"MinY","MaxY")+")"};this.classicLayerMatchesArea=function(a){var b=Math.abs(a.maxX-a.minX);a=Math.abs(a.maxY-a.minY);return"recip(sum(abs(sub(Area,"+b*a+")),.01),1,1000,1000)"};this.classicLayerAreaIntersectionScore=function(a){var b=a.minX,c=a.minY,d=a.maxY;a=Math.abs(a.maxX-b)/4;for(var d=Math.abs(d-c)/4,e="sum(",g=0;3>g;g++)for(var h=0;3>h;h++){var k=b+(g+1)*a,l=c+(h+1)*d,f="map(sum(map(sub("+k+",MinX),0,400,1,0),",f=f+("map(sub("+k+",MaxX),-400,0,1,0),"),f=f+("map(sub("+l+",MinY),0,400,1,0),"),
f=f+("map(sub("+l+",MaxY),-400,0,1,0)),"),f=f+"4,4,1,0)";if(0<g||0<h)e+=",";e+=f}return e="product("+(e+")")+","+1/9+")"};this.classicLayerWithinMap=function(a){var b=a.minX,c=a.maxX,d=a.minY;a=a.maxY;var e;e="if(and(exists(MinX),exists(MaxX),exists(MinY),exists(MaxY)),map(sum("+("map(MinX,"+b+","+c+",1,0),");e+="map(MaxX,"+b+","+c+",1,0),";e+="map(MinY,"+d+","+a+",1,0),";e+="map(MaxY,"+d+","+a+",1,0))";return e+=",4,4,1,0),0)"};this.setBoundingBox=function(a){this.bounds={minX:Math.max(a.minX,-180),
minY:Math.max(a.minY,-90),maxX:Math.min(a.maxX,180),maxY:Math.min(a.maxY,90)}};this.clearBoundingBox=function(){this.bounds={}};this.center={};this.setCenter=function(a){this.center=a};this.getCenter=function(){return this.center};this.getBoundsArea=function(a){var b=Math.abs(a.maxX-a.minX);return Math.abs(a.maxY-a.minY)*b};this.sendToSolr=function(a,b,c){var d={type:"GET",url:a,dataType:"jsonp",jsonp:"json.wrf",timeout:5E3,crossDomain:!0,success:function(a){b(a)},error:function(a){c(a)}};if(3<arguments.length){var e=
arguments[3];d.context=e;d.success=function(a){b.apply(e,arguments)}}jQuery.ajax(d)};this.getArbitraryParams=function(a,b){return{q:this.createFilter("LayerId",a),fl:this.getReturnedColumns(b),wt:"json"}};this.getMetadataParams=function(a){return this.getArbitraryParams(a,this.MetadataRequest)};this.getTermParams=function(a,b){return{"terms.fl":a,"terms.regex":".*"+b+".*","terms.regex.flag":"case_insensitive","terms.limit":-1,omitHeader:!0,wt:"json"}};this.getInfoFromLayerIdParams=function(a){return{q:this.createFilter("LayerId",
a),wt:"json",fl:this.getReturnedColumns(this.SearchRequest),rows:1E4}};this.getLayerInfoFromSolr=function(a,b,c){var d=this.getServerName();a=jQuery.param(this.getInfoFromLayerIdParams(a),!0);this.sendToSolr(d+"?"+a,b,c)};this.termQuery=function(a,b,c,d){var e=this.getServerName().substring(0,this.getServerName().indexOf("select"))+"terms";a=jQuery.param(this.getTermParams(a,b),!0);this.sendToSolr(e+"?"+a,c,d)};this.getNewOgpSpatialQueryParams=function(a){var b=this.getCenter(a.minX,a.maxX),c=this.getCenter(a.minY,
a.maxY);console.log(b);console.log(c);var d=this.getBoundsArea(a);return{bf:[this.getBoundsAreaRelevancyClause()+"^"+this.LayerMatchesScale.boost,this.getCenterRelevancyClause(c,b)+"^"+this.LayerMatchesCenter.boost],boost:this.getLayerWithinMapClause(),fq:[this.getIntersectionFilter()],intx:this.getIntersectionFunction(a),union:d,debug:!0}};this.getCenterRelevancyClause=function(a,b){return"if(and(exists(CenterX),exists(CenterY)),"+("recip(dist(2,CenterX,CenterY,"+b+","+a+"),1,1000,1000),0)")};this.getBoundsAreaRelevancyClause=
function(){return"if(exists(Area),recip(abs(sub(Area,$union)),1,1000,1000),0)"};this.getIntersectionAreaRelevancyClause=function(a){return"if(not(sub($union,$intx)),div($intx,$union),0)"};this.getLayerWithinMapClause=function(){return"{!frange u\x3d15 l\x3d0 incu\x3dfalse incl\x3dfalse cache\x3dfalse} product(15,div($intx,$union))"}};if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!=typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.ResultItem=Backbone.Model.extend({});OpenGeoportal.ResultCollection=Backbone.Collection.extend({model:OpenGeoportal.Models.ResultItem});
OpenGeoportal.ResultsCollection=Backbone.Collection.extend({model:OpenGeoportal.Models.ResultItem,initialize:function(){null===this.searcher&&(this.searcher=OpenGeoportal.ogp.appState.get("queryTerms"))},fetchOn:!1,searcher:null,url:function(){return this.searcher.getSearchRequest()},totalResults:0,parse:function(a){return this.solrToCollection(a)},solrToCollection:function(a){this.totalResults=a.response.numFound;var b=a.response.start;a=a.response.docs;var c=[];OpenGeoportal.ogp.appState.get("previewed").each(function(a){"on"===
a.get("preview")&&c.push(a.get("LayerId"))});var d=[];_.each(a,function(a){a.resultNum=b;b++;_.contains(c,a.LayerId)&&(a.hidden=!0);var e={};try{var f=a.Location;2<f.length&&(e=jQuery.parseJSON(f))}catch(g){console.log([a.LayerId,g])}a.Location=e;d.push(a)});return d},enableFetch:function(){this.fetchOn=!0},disableFetch:function(){this.fetchOn=!1},extraParams:{},pageParams:{start:0,rows:50},fetchStatus:null,newSearch:function(){!this.fetchOn&&("undefined"!==typeof this.fetchStatus&&null!==this.fetchStatus)&&
(console.log("abort called"),this.fetchStatus.abort());this.disableFetch();this.pageParams.start=0;var a=this,b=this.fetch({dataType:"jsonp",jsonp:"json.wrf",complete:function(){a.fetchComplete.apply(a,arguments);jQuery(document).trigger("newResults")},reset:!0,data:$.extend(this.pageParams,this.extraParams)});return this.fetchStatus=b},nextPage:function(){if(this.fetchOn&&(this.disableFetch(),this.pageParams.start=this.last().get("resultNum")+1,!(this.pageParams.start>this.totalResults))){var a=
this;this.fetchStatus=this.fetch({dataType:"jsonp",jsonp:"json.wrf",complete:function(){a.fetchComplete.apply(a,arguments)},remove:!1,data:$.extend(this.pageParams,this.extraParams)})}},fetchComplete:function(){this.enableFetch()}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.Basemap=Backbone.Model.extend({initialize:function(){this.listenTo(this,"change:selected",this.changeSelection)},changeSelection:function(){this.get("selected")?this.showBasemap():this.hideBasemap()},showBasemap:function(){this.has("showOperations")&&this.get("showOperations").call(this)},hideBasemap:function(){this.has("hideOperations")&&this.get("hideOperations").call(this)},checkPrimaryZoomMap:function(a){if(this.has("isSecondaryTo")){var b=this.collection.findWhere({name:this.get("isSecondaryTo")});
if(a<=b.get("zoomLevels"))return this.set({selected:!1}),this.unset("isSecondaryTo"),b.set({selected:!0}),!0}return!1},checkSecondaryZoomMap:function(a){return a>=this.get("zoomLevels")+1&&this.has("secondaryZoomMap")?(this.set({selected:!1}),this.collection.findWhere({name:this.get("secondaryZoomMap")}).set({selected:!0,isSecondaryTo:this.get("name")}),!0):!1}});
OpenGeoportal.BasemapCollection=Backbone.Collection.extend({model:OpenGeoportal.Models.Basemap,checkZoom:function(a){var b=this.findWhere({selected:!0}),c=b.checkPrimaryZoomMap(a);c||(c=b.checkSecondaryZoomMap(a));return c}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!=typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.ColumnInfo=Backbone.Model.extend({idAttribute:"columnName"});
OpenGeoportal.TableConfig=Backbone.Collection.extend({model:OpenGeoportal.Models.ColumnInfo,comparator:function(a){return a.get("order")}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!=typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.RowSetting=Backbone.Model.extend({defaults:{expanded:!1},validate:function(a){if(!a.changed.has("LayerId")||!a.changed.has("expanded"))return"Both 'layerId' and 'expanded' parameters required";if("boolean"!=typeof a.changed.expanded)return"'expanded' must be a boolean value"}});
OpenGeoportal.TableRowSettings=Backbone.Collection.extend({model:OpenGeoportal.Models.RowSetting,setExpandState:function(a,c){var b=this.findWhere({LayerId:a});"undefined"===typeof b?c&&this.add({LayerId:a,expanded:!0}):c?b.set({expanded:!0}):this.remove(b)},isExpanded:function(a){return"undefined"===typeof this.findWhere({LayerId:a})?!1:!0}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.TableSortSettings=Backbone.Model.extend({defaults:{column:"score",type:"numeric",direction:"desc"},setColumn:function(a){"score"==a?this.set({column:"score",direction:"desc"}):this.get("column")!==a?this.set({column:a,direction:"asc"}):this.toggleDirection()},toggleDirection:function(){var a="desc";"desc"==this.get("direction")&&(a="asc");this.set({direction:a})}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.ProtocolAware=OpenGeoportal.Models.ResultItem.extend({initialize:function(){this.assignAttributes()},assignAttributes:function(){console.log("subclass me!")},supportedAttributesByType:[],getAttributesByType:function(b){var c=this.supportedAttributesByType,a={},d;for(d in c)c[d].type===b&&(a=c[d]);if(_.isEmpty(a))return a;b={};if(_.has(a,"discriminator")&&"none"!==a.discriminator){if(!this.has(a.discriminator))throw Error("Model does not contain the attribute : "+a.discriminator);
c=this.get(a.discriminator).toLowerCase();_.has(a.attributes,c)?b=a.attributes[c]:console.log("attributes Object does not contain the property : "+c)}else b=a.attributes;return b},missingAttribute:function(b){throw Error("Model does not contain the attribute '"+b+"'");},isPublic:function(){return"public"!==this.get("Access").toLowerCase()?!1:!0},attributeIsOneOf:function(b,c){if(this.has(b)){var a=this.get(b);return OpenGeoportal.Utility.arrayContainsIgnoreCase(c,a)}this.missingAttribute(att)},isVector:function(){return this.attributeIsOneOf("DataType",
["point","line","polygon","undefined"])},isRaster:function(){return this.attributeIsOneOf("DataType",["raster","paper map","scanned map"])},hasOGCEndpoint:function(b){if(this.has("Location")){var c=this.get("Location");return OpenGeoportal.Utility.hasLocationValueIgnoreCase(c,[b])}this.missingAttribute(att)}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.PreviewLayer=OpenGeoportal.Models.ProtocolAware.extend({defaults:{preview:"off",resourceName:"",previewType:"",showControls:!1},supportedAttributesByType:[{type:"wms",discriminator:"DataType",attributes:{raster:{getFeature:!1,opacity:100,sld:""},"paper map":{opacity:100},point:{getFeature:!1,opacity:100,colorPickerOn:!1,sld:"",color:"#ff0000",graphicWidth:2},line:{getFeature:!1,opacity:100,colorPickerOn:!1,sld:"",color:"#0000ff",graphicWidth:1},polygon:{getFeature:!1,opacity:100,
colorPickerOn:!1,sld:"",opacity:80,color:"#aaaaaa",graphicWidth:1},undefined:{getFeature:!1,opacity:100,colorPickerOn:!1,sld:"",color:"#aaaaaa",graphicWidth:1}}},{type:"tilecache",attributes:{opacity:100}},{type:"arcgisrest",attributes:{opacity:100}}],setPreviewType:function(){if(!this.has("Location"))return"noPreview";var a=this.get("Location");if(_.isEmpty(a))return"noPreview";var b="default";OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,["wms"])?b="wms":OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,
["arcgisrest"])?b="arcgisrest":OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,["tilecache"])?b="tilecache":OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,["imagecollection"])?b="imagecollection":OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,["arcgisrest"])?b="arcgisrest":OpenGeoportal.Utility.hasLocationValueIgnoreCase(a,["externalLink"])&&(b="externalLink");this.set({previewType:b});return b},assignAttributes:function(){var a=this.setPreviewType(),a=this.getAttributesByType(a);this.set(a)}});
OpenGeoportal.Models.Attribute=Backbone.Model.extend({});OpenGeoportal.Attributes=Backbone.Collection.extend({model:OpenGeoportal.Models.Attribute});
OpenGeoportal.PreviewedLayers=Backbone.Collection.extend({model:OpenGeoportal.Models.PreviewLayer,initialize:function(){this.listenTo(this,"change:preview add",this.changePreview);this.listenTo(this,"change:graphicWidth change:color",this.changeLayerStyle);this.listenTo(this,"change:opacity",this.changeLayerOpacity);this.listenTo(this,"change:getFeature",this.changeGetFeatureState)},changeLayerStyle:function(a,b,c){a=a.get("LayerId");jQuery(document).trigger("map.styleChange",{LayerId:a})},changeLayerOpacity:function(a,
b,c){b=a.get("opacity");a=a.get("LayerId");jQuery(document).trigger("map.opacityChange",{LayerId:a,opacity:b})},changeGetFeatureState:function(a,b,c){b=a.get("getFeature");c=a.get("LayerId");var d=null;b?(d="map.getFeatureInfoOn",this.clearGetFeature(a)):d="map.getFeatureInfoOff";jQuery(document).trigger(d,{LayerId:c})},changePreview:function(a,b,c){b=a.get("preview");c=a.get("LayerId");"on"===b?jQuery(document).trigger("previewLayerOn",{LayerId:c}):(jQuery(document).trigger("previewLayerOff",{LayerId:c}),
a.has("getFeature")&&a.set({getFeature:!1}))},isPreviewed:function(a){a=this.findWhere({LayerId:a});var b=!1;"undefined"!==typeof a&&"on"===a.get("preview")&&(b=!0);return b},getLayerModel:function(a){var b=a.get("LayerId"),c=this.where({LayerId:b});if(1<c.length)throw Error("There are "+c.length+" layers in the previewed layers collection.  This should never happen.");0<c.length?a=c[0]:(this.add(a.attributes),a=this.findWhere({LayerId:b}));return a},clearGetFeature:function(a){var b="dummy";"undefined"!==
typeof a&&(b=a.get("LayerId"));this.each(function(a){a.get("LayerId")!==b&&a.get("getFeature")&&a.set({getFeature:!1})})}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.CartLayer=OpenGeoportal.Models.ProtocolAware.extend({defaults:{},intersectsBounds:function(a){var b=this.get("MinX"),d=this.get("MinY"),e=this.get("MaxX"),c=this.get("MaxY");if(!(0<Math.min(a[3],c)-Math.max(a[1],d)))return!1;d=!1;b>e&&(d=!0);if(!d)return 0<Math.min(a[2],e)-Math.max(a[0],b);e=0<Math.min(a[2],e)-Math.max(a[0],-180);a=0<Math.min(a[2],180)-Math.max(a[0],b);return e||a},assignAttributes:function(){}});
OpenGeoportal.CartCollection=Backbone.Collection.extend({model:OpenGeoportal.Models.CartLayer,initialize:function(){this.listenTo(this,"invalid",function(a,b){console.log(b)});this.listenTo(this,"add remove",this.notifyExternal)},notifyExternal:function(a){jQuery(document).trigger("cartUpdated",{LayerId:a.get("LayerId")})},addLayer:function(a,b){OpenGeoportal.ogp.appState.get("login").model.hasAccess(a)?this.add(a):this.addWithWarning(a)},toggleCartState:function(a){var b=a.get("LayerId"),b=this.findWhere({LayerId:b});
"undefined"===typeof b?(a=a.clone(),this.addLayer(new OpenGeoportal.Models.CartLayer(a.attributes))):this.remove(b)},ignoreAuthenticationWarning:{local:!1,external:!1},addWithWarning:function(a){var b=OpenGeoportal.ogp.appState.get("login").model.canLogin(a),d=a.get("Institution"),e,c="\x3cspan\x3eThis layer is restricted by licensing agreement to the "+d+" community. \x3c/span\x3e",g=this;b?(e="local",c+='\x3cspan class\x3d"notice"\x3eRestricted layers can be added to the Cart, but you must login before you can preview or download restricted layers.\x3c/span\x3e'):
(e="external",c=c+('\x3cspan class\x3d"notice"\x3eRestricted layers can be added to the Cart here, but you must use '+d)+"'s site and login to preview or download restricted layers.\x3c/span\x3e");c+="\x3cbr /\x3e";c+='\x3cspan class\x3d"ignoreWarning"\x3e\x3cinput id\x3d"ignoreAuthenticationWarning" type\x3d"checkbox" /\x3e\x3clabel for\x3d"ignoreAuthenticationWarning"\x3eDon\'t show this message again.\x3c/span\x3e';if(this.ignoreAuthenticationWarning[e])this.add(a);else{jQuery(document).on("change",
"#ignoreAuthenticationWarning",function(){g.ignoreAuthenticationWarning[e]=jQuery(this).is(":checked")});var h=OpenGeoportal.ogp.widgets.genericModalDialog(c,"Restricted Layer"),d=function(){g.add(a);jQuery(this).dialog("close")},c=function(){var b=OpenGeoportal.ogp.appState.get("login");b.promptLogin();jQuery(this).dialog("disable");var c=function(b){b.hasAccess(a)&&g.add(a);h.dialog("close")};b.listenToOnce(b.model,"change:authenticated",c);jQuery(document).on("loginCancel",function(){h.dialog("enable");
b.stopListening(b.model,"change:authenticated",c)})},f={};b?(f["Login \x26 Add"]=c,f["Add Only"]=d):f.Add=d;f.Cancel=function(){jQuery(this).dialog("close")};h.dialog({width:535,buttons:f}).siblings(".ui-dialog-buttonpane").find(".ui-dialog-buttonset \x3e button").first().focus()}}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.AbstractQueueItem=Backbone.Model.extend({initialize:function(){this.listenTo(this,"change:status",this.handleStatusChange);this.listenTo(this,"add",this.submitRequest);this.widgets=OpenGeoportal.ogp.widgets;this.subClassInit()},subClassInit:function(){},getRequestParams:function(){throw Error("Implement me!");},submitRequest:function(){var a=this,b={url:this.get("requestUrl"),data:this.getRequestParams(),dataType:"json",type:"POST",success:function(b){a.set({requestId:b.requestId,
status:"PROCESSING"})},error:function(){a.set({status:"COMPLETE_FAILED"})}};jQuery.ajax(b)},handleStatusChange:function(){var a=this.get("status");if("COMPLETE_SUCCEEDED"==a||"COMPLETE_PARTIAL"==a){try{this.handleDownload()}catch(b){console.log(b),console.log("Download handler failed.")}try{this.createNotice()}catch(c){console.log("Download notice creation failed.")}}else"COMPLETE_FAILED"==a&&this.createNotice();this.collection.checkPoll()},handleDownload:function(){var a=this.get("layerStatuses"),
b=!1,c=null;if("undefined"!==typeof a)for(c in a){if("download"===a[c].responseType){b=!0;break}}else b=!0;b&&this.retrieve()},retrieve:function(){var a=this.get("retrieveUrl"),a=a+("?requestId\x3d"+this.get("requestId"));jQuery("body").append('\x3ciframe class\x3d"download" src\x3d"'+a+'"\x3e\x3c/iframe\x3e')},createNotice:function(){throw Error("Implement me!");}});
OpenGeoportal.Models.DownloadRequest=OpenGeoportal.Models.AbstractQueueItem.extend({defaults:{requestId:"",layers:[],bbox:new OpenLayers.Bounds(-180,-90,180,90),email:"",status:"REQUESTING",requestUrl:"requestDownload",retrieveUrl:"getDownload"},subClassInit:function(){this.listenTo(this,"invalid",function(a,b){"email"===b?jQuery("#emailValidationError").html("You must provide a valid email address."):console.log("validation error for property: "+b)})},getRequestParams:function(){try{var a=this.attributes,
b=this.get("layers"),c=[];_.each(b,function(a){c.push({layerId:a.get("LayerId"),format:a.get("requestedFormat")})});a.layers=c;a.bbox=a.bbox.toBBOX();return JSON.stringify(a)}catch(d){throw console.log(d),Error("Error creating params for request.");}},createNotice:function(){var a=this.get("layerStatuses"),b=[],c=[],d=null;for(d in a){var e=a[d];"success"!=e.status.toLowerCase()?b.push(e):c.push(e)}a="";this.has("email")&&(a=this.get("email"));this.noticeDialog(c,b,a)},noticeDialog:function(a,b,c){var d=
"",e=[];0<b.length&&(_.each(b,function(a){e.push(a.id)}),d+="The following layers failed to download: "+e.join(", "));var f=[];0<a.length&&(_.each(a,function(a){"email"===a.responseType&&f.push(a.id)}),0<f.length&&(d+="The following layers have been emailed to "+c+": "+f.join()));0<d.length&&this.widgets.genericModalDialog(d,"Download Notice").dialog("option","buttons",[{text:"OK",click:function(){jQuery(this).dialog("close")}}])},validate:function(a,b){var c=a.email;if(null!==c&&!OpenGeoportal.Utility.checkAddress(c))return"email"}});
OpenGeoportal.Models.GeoCommonsRequest=OpenGeoportal.Models.AbstractQueueItem.extend({defaults:{requestId:"",layerIds:[],basemap:null,username:null,password:null,title:null,description:null,bbox:"",status:"REQUESTING",requestUrl:"geocommons/requestExport",retrieveUrl:"geocommons/getExport"},retrieve:function(){var a=this.get("retrieveUrl"),a=a+("?requestId\x3d"+this.get("requestId"));jQuery.ajax({url:a,dataType:"json",success:this.retrievalSuccess,error:this.retrievalFailure})},retrievalSuccess:function(a,
b,c){200===b?window.open(a.location):this.retrievalFailure(c,b,"unknown")},retrievalFailure:function(a,b,c){this.widgets.genericModalDialog("OGP failed to export your layers.  Reason: "+c,"Request Failed").dialog("option","buttons",[{text:"OK",click:function(){jQuery(this).dialog("close")}}])},getRequestParams:function(){try{var a={};a.basemap=this.get("basemap");a.username=this.get("username");a.password=this.get("password");a.extent=this.get("bbox");a.title=this.get("title");a.description=this.get("description");
a.OGPIDS=this.get("layerIds").join();return JSON.stringify(a)}catch(b){throw console.log(b),Error("Error creating params");}},createNotice:function(){alert("failed to export layers to GeoCommons!")}});
OpenGeoportal.Models.ImageRequest=OpenGeoportal.Models.AbstractQueueItem.extend({defaults:{requestId:"",layers:[],bbox:"",format:"image/png",width:null,height:null,srs:null,status:"REQUESTING",requestUrl:"requestImage",retrieveUrl:"getImage"},getRequestParams:function(){try{var a={};a.format=this.get("format");a.width=this.get("width");a.height=this.get("height");a.bbox=this.get("bbox");a.srs=this.get("srs");var b=this.get("layers");a.layers=b;return JSON.stringify(a)}catch(c){throw console.log(c),
Error("Error creating params");}},createNotice:function(){}});
OpenGeoportal.RequestQueue=Backbone.Collection.extend({model:OpenGeoportal.Models.QueueItem,poll:{id:"",isRunning:!1,interval:3E3},checkPoll:function(){var a=this.where({status:"PROCESSING"});"undefined"==typeof a||0===a.length?this.stopPoll():this.startPoll()},stopPoll:function(){this.poll.isRunning&&(clearInterval(this.poll.id),this.poll.isRunning=!1)},startPoll:function(){var a=this;this.poll.isRunning||(this.poll.id=setInterval(function(){var b=a.where({status:"PROCESSING"});a.checkStatus(b)},
a.poll.interval),this.poll.isRunning=!0);this.getLayerCount()},getLayerCount:function(){var a=this.where({status:"PROCESSING"}),b=0,c=null;for(c in a)b+=a[c].get("layers").length;return b},checkStatus:function(a){var b=[];_.each(a,function(a){b.push(a.get("requestId"))});var c=this,d={url:"requestStatus",data:{requestIds:b.join()},success:function(a){c.updateRequestQueue(a.requestStatus)},error:function(){console.log("error callback called");console.log(a);_.each(a,function(a){console.log(a.get("status"));
a.set({status:"FAILED"})})}};jQuery.ajax(d)},updateRequestQueue:function(a){var b=null;for(b in a){var c=a[b].status,d=a[b].requestedLayerStatuses;this.findWhere({requestId:a[b].requestId}).set({status:c,layerStatuses:d})}}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.LoadIndicator=Backbone.Model.extend({defaults:{actionId:"unspecified",actionType:"generic"}});
OpenGeoportal.LoadIndicatorCollection=Backbone.Collection.extend({model:OpenGeoportal.Models.LoadIndicator});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!=typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");Backbone.sync=_.wrap(Backbone.sync,function(a,b,c,d){d.xhrFields||(d.xhrFields={withCredentials:!0});d.headers=d.headers||{};a(b,c,d)});
OpenGeoportal.Models.User=Backbone.Model.extend({defaults:{repository:"",username:"anonymous",authenticated:!1,authorities:[],message:""},initialize:function(){var a=OpenGeoportal.Config.General.get("loginConfig"),b=a.repositoryId,c="";0<a.secureDomain.length&&this.set({secureDomain:a.secureDomain});this.set({repository:b});b=a.type;a=this.getUrl()+a.url;0<c.length&&(c+=" ");var d=c+"Username:",c=c+"Password:";this.set({type:b});this.set({authUrl:a});this.set({userNameLabel:d});this.set({passwordLabel:c})},
url:function(){return this.getUrl()+"loginStatus"},getUrl:function(){var a;if(this.has("secureDomain"))a=this.get("secureDomain"),a.indexOf("/");else{a=window.location.hostname;var b=window.location.port;a="https://"+a+(""==b||null==b?"":":"+b)}var b=window.location.pathname.split("/"),c="";2<b.length&&(c=b[1]+"/");return a+"/"+c},logout:function(){var a=this,b={url:this.getUrl()+"logout",crossDomain:!0,xhrFields:{withCredentials:!0},context:a,dataType:"json"};jQuery.ajax(b).always(function(){a.fetch()})},
canLogin:function(a){a=a.get("Institution");return this.canLoginLogic(a)},canLoginLogic:function(a){return a.toLowerCase()===this.get("repository").toLowerCase()?!0:!1},hasAccess:function(a){var b=a.get("Institution");a=a.get("Access");return this.hasAccessLogic(a,b)},hasAccessLogic:function(a,b){a=a.toLowerCase();b=b.toLowerCase();var c=this.get("authenticated"),d=this.get("repository").toLowerCase();return"public"===a?!0:c&&d===b?!0:!1}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!=typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.Login=Backbone.View.extend({model:OpenGeoportal.Models.User,initialize:function(){this.model.fetch();var a=this;jQuery(document).on("click",".loginButton",function(){a.promptLogin.apply(a,arguments)});jQuery("#headerLogin").on("click.login",function(){a.headerLogin.apply(a,arguments)});this.listenTo(this.model,"change:authenticated",this.processLoginState)},headerLogin:function(a){this.model.get("authenticated")?this.model.logout():this.promptLogin(a)},promptLogin:function(){var a=
jQuery.Deferred(),b=this.getLoginContent(),d=this.model.get("type");"iframe"===d&&this.processIframeLogin(a);var e=this,c=jQuery("#loginDialog");if(0===c.length){b='\x3cdiv id\x3d"loginDialog" class\x3d"dialog"\x3e \n'+b+"\x3c/div\x3e \n";jQuery("body").append(b);var c=jQuery("#loginDialog"),f;"form"===d?f={Cancel:function(){jQuery(this).dialog("close")},Login:function(){e.processFormLogin(a)}}:"iframe"===d&&(f={Cancel:function(){jQuery(this).dialog("close")}});c.dialog({autoOpen:!1,width:"auto",
title:"Login",context:e,resizable:!1,zIndex:3E3,stack:!0,buttons:f})}else c.html(b);"form"===d&&(c.off("keypress"),c.on("keypress",function(b){13===b.keyCode&&e.processFormLogin(a)}));c.dialog("open");c.find("input:text").first().focus();return a.promise()},getLoginContent:function(){var a="",b=this.model.get("type");"form"==b?a="\x3cform\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e"+this.model.get("userNameLabel")+'\x3c/td\x3e\x3ctd\x3e\x3cinput type\x3d"text" id\x3d"loginFormUsername" name\x3d"loginFormUsername"/\x3e\x3c/td\x3e\x3c/tr\x3e\x3ctr\x3e\x3ctd\x3e'+
this.model.get("passwordLabel")+'\x3c/td\x3e\x3ctd\x3e\x3cinput type\x3d"password" id\x3d"loginFormPassword" name\x3d"loginFormUsername"/\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/form\x3e':"iframe"==b&&(a='\x3cform\x3e\x3ctable\x3e\x3ciframe  id\x3d"loginIframe"  frameborder\x3d"0"  vspace\x3d"0"  hspace\x3d"0"  marginwidth\x3d"2"  marginheight\x3d"2" width\x3d"700"  height\x3d"600"  src\x3d"'+this.model.get("authUrl")+'"\x3e\x3c/iframe\x3e\x3c/table\x3e\x3c/form\x3e');return a+'\x3cbr/\x3e\x3cspan class\x3d"warning"\x3e\x3c/span\x3e'},
processFormLogin:function(a){var b=this,d=this.model.get("authUrl"),e=jQuery("#loginFormUsername").val(),c=jQuery("#loginFormPassword").val();return jQuery.ajax({type:"POST",url:d,context:b,crossDomain:!0,xhrFields:{withCredentials:!0},data:{username:e,password:c},dataType:"json",success:function(c){b.model.set(c);b.model.get("authenticated")&&a.resolve();"undefined"!==typeof c.message&&null!==c.message&&b.showLoginMessage(c.message)},error:b.loginResponseError})},showLoginMessage:function(a){0<a.length&&
jQuery("#loginDialog .warning").text(a)},processIframeLogin:function(a){var b=this,d="attachEvent"==(window.addEventListener?"addEventListener":"attachEvent")?"onmessage":"message";jQuery(window).on(d,function(d){b.model.set(jQuery.parseJSON(d.originalEvent.data));b.model.get("authenticated")?a.resolve():a.fail()})},loginResponseError:function(a){this.showLoginMessage("Error communicating with login server.")},processLoginState:function(a){a.get("authenticated")?(jQuery("#headerLogin").text("Logout"),
jQuery("#loginDialog").dialog("close"),jQuery(".loginButton").trigger("loginSucceeded")):(jQuery("#headerLogin").text("Login"),jQuery(".previewControl").trigger("logoutSucceeded"))}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.OgpSettings=Backbone.Model.extend({});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!=typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.QueryTerms=Backbone.Model.extend({defaults:{what:"",where:"",keyword:"",originator:"",dataType:[],repository:[],dateFrom:null,dateTo:null,isoTopic:"",facets:"",sortBy:"score",sortDir:"asc",mapExtent:{minX:-180,maxX:180,minY:-90,maxY:90},mapCenter:{centerX:0,centerY:0},ignoreSpatial:!1,displayRestrictedAdvanced:[],isoTopicList:null,dataTypeList:null,repositoryList:null,displayRestrictedBasic:[],whatExample:"(Example: buildings)",whereExample:"(Example: Boston, MA)",searchType:"basic",
history:[]},initialize:function(){var a=OpenGeoportal.Config.General.get("loginConfig").repositoryId;this.set({displayRestrictedBasic:[a],displayRestrictedAdvanced:[a],isoTopicList:OpenGeoportal.Config.IsoTopics,dataTypeList:OpenGeoportal.Config.DataTypes,repositoryList:OpenGeoportal.Config.Repositories})},setMapExtent:function(a,b){var c=a.left,d=a.right,e=a.bottom,f=a.top,g=Math.abs(d-c),h=Math.abs(f-e);350<g&&(c=-180,d=180);165<h&&(e=-90,f=90);this.set({mapExtent:{minX:c,maxX:d,minY:e,maxY:f},
mapCenter:{centerX:b.lon,centerY:b.lat}},{silent:!0});("undefined"!==typeof this.changed.mapCenter||"undefined"!==typeof this.changed.mapExtent)&&this.trigger("change:mapExtent")},getSearchRequest:function(){var a=null,a=this.get("searchType"),a="basic"===a?this.getBasicSearchQuery():"advanced"===a?this.getAdvancedSearchQuery():this.getBasicSearchQuery();this.addToHistory(a);return a.getURL()},getSortInfo:function(){return OpenGeoportal.ogp.resultsTableObj.tableOrganize},getBasicSearchQuery:function(){var a=
new OpenGeoportal.Solr;a.setSearchType(this.get("searchType"));var b=this.getSortInfo();a.setSort(b.get("column"),b.get("direction"));a.setBoundingBox(this.get("mapExtent"));a.setCenter(this.get("mapCenter"));b=this.get("what");null!=b&&""!=b&&a.setWhat(b);a.addFilter(a.createAccessFilter(this.get("displayRestrictedBasic")));return a},getAdvancedSearchQuery:function(){var a=new OpenGeoportal.Solr;a.setSearchType(this.get("searchType"));var b=this.getSortInfo();a.setSort(b.get("column"),b.get("direction"));
b=this.get("ignoreSpatial");a.setIgnoreSpatial(b);b||(a.setBoundingBox(this.get("mapExtent")),a.setCenter(this.get("mapCenter")));b=this.get("keyword");null!==b&&""!==b&&a.setAdvancedKeywords(b);var b=this.get("dateFrom"),c=this.get("dateTo");a.addFilter(a.createDateRangeFilter("ContentDate",b,c));b=this.get("dataType");a.addFilter(a.createFilter("DataType",b,"{!tag\x3ddt}"));b=this.get("repository");a.addFilter(a.createFilter("Institution",b,"{!tag\x3dinsf}"));a.addFilter(a.createAccessFilter(this.get("displayRestrictedAdvanced")));
b=this.get("originator");a.addFilter(a.createFilter("Originator",b,null,"AND"));b=this.get("isoTopic");a.addFilter(a.createFilter("ThemeKeywordsSynonymsIso",b));return a},addToHistory:function(a){var b=this.get("history");for(b.push(a);5<b.length;)b.shift()},rerunLastSearch:function(){var a=this.get("history").pop();null!=a&&a.executeSearchQuery(this.searchRequestJsonpSuccess,this.searchRequestJsonpError)},addSpatialToEmptySearchMessage:function(){var a=this.get("history").pop();null!=a&&(a.clearBoundingBox(),
a.executeSearchQuery(this.emptySearchMessageHandler,this.searchRequestJsonpError))}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");OpenGeoportal.Models.LeftPanel=Backbone.Model.extend({defaults:{mode:"closed",openWidth:500,panelMinWidth:390,mapMinWidth:550}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!=typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");var originalVal=$.fn.val;
$.fn.val=function(a){if("undefined"==typeof a)return $(this).attr("ogpSelectMenu")?$(this).attr("ogpValue"):originalVal.call(this);$(this).attr("ogpSelectMenu")&&$(this).attr("ogpValue",a);return originalVal.call(this,a)};
OpenGeoportal.Views.AbstractSelectMenu=Backbone.View.extend({constructor:function(a){this.options=a;Backbone.View.apply(this,arguments)},events:{"click .select":"toggleMenu","blur .ui-menu":"hideMenu"},uiInit:function(a){var b=this;this.$el.addClass("dropdown").attr("ogpSelectMenu",!0);this.$el.find(".select").first().button({icons:{secondary:"ui-icon-triangle-1-s"}}).parent().buttonset().next("ul").hide().menu({select:function(a,d){b.selectCallback(a,d,b)},position:{my:"left top",at:"left bottom",
of:this}})},hideMenu:function(){this.$el.find(".ui-menu").slideUp({duration:100})},showMenu:function(){var a=this.$el.find(".ui-menu");a.slideDown({duration:100,done:function(){a.menu("focus",null,a.find(".ui-menu-item:first"));a.find(".ui-menu-item \x3e a:first").focus()}})},toggleMenu:function(a){a.preventDefault;"none"!=this.$el.find(".select").first().parent().next().css("display")?this.hideMenu():this.showMenu()},getButtonLabel:function(){return this.getAttributeName(this.options.buttonLabel,
"Select one")},getSelectionAttribute:function(){return this.getAttributeName(this.options.selectionAttribute,"selected")},getValueAttribute:function(){return this.getAttributeName(this.options.valueAttribute,"value")},getDisplayAttribute:function(){return this.getAttributeName(this.options.displayAttribute,this.getValueAttribute())},getItemClass:function(){return this.getAttributeName(this.options.itemClass,"menuItem")},getAttributeName:function(a,b){return"undefined"==typeof a?b:a},getValue:function(){return this.$el.attr("ogpValue")},
selectCallback:function(a,b,c){console.log("selected "+b.item.text())},uiItemSelected:function(a){jQuery(a).addClass("selected")},uiItemDeselected:function(a){jQuery(a).removeClass("selected")},setValue:function(){throw Error("no function for setValue defined.");},initRender:function(){this.template=OpenGeoportal.ogp.template;this.$el.html(this.template.styledSelectBody(this.getTemplateParams()));this.uiInit();this.setValue();return this}});
OpenGeoportal.Views.CollectionSelect=OpenGeoportal.Views.AbstractSelectMenu.extend({initialize:function(){var a="change:"+this.getSelectionAttribute();this.listenTo(this.collection,a,this.setValue);this.listenTo(this.collection,a,this.render);this.initRender();this.render()},getTemplateParams:function(){var a="",b=this.getButtonLabel(),c=this.getValueAttribute(),d=this.getDisplayAttribute(),e=this.getItemClass();that=this;this.collection.each(function(b){var h=b.get(c);b=b.get(d);a+=that.template.simpleMenuItem({name:b,
value:h,className:e})});return{menuHtml:a,buttonLabel:b}},setValue:function(){var a=this.getSelectionAttribute(),b=this.collection.filter(function(b){return b.get(a)});0!==b.length&&(this.$el.attr("ogpValue",b[0].get(this.getValueAttribute())),this.$el.trigger("change"))},changeSelected:function(a){var b=this.getValueAttribute(),c=this.getSelectionAttribute();this.collection.find(function(a){return!0==a.get(c)}).set(c,!1);this.collection.find(function(c){return c.get(b)===a}).set(c,!0);this.setValue();
this.$el.find("ul.ui-menu").hide()},selectCallback:function(a,b,c){a=b.item.find("input[type\x3dhidden]").first().val();this.changeSelected(a)},render:function(){var a=this.getSelectionAttribute(),b=this.collection.filter(function(b){return b.get(a)})[0],c="",d=this.getButtonLabel();"undefined"!=typeof b&&(c=b.get(this.getValueAttribute()),0!==c.length&&(d=b.get(this.getDisplayAttribute())));var e=this;this.$el.find("li \x3e a").each(function(){jQuery(this).next().val()===c?e.uiItemSelected(this):
e.uiItemDeselected(this)});this.$el.find(".ui-button-text").text(d);return this}});
OpenGeoportal.Views.CollectionMultiSelect=OpenGeoportal.Views.AbstractSelectMenu.extend({events:{"click .select":"toggleMenu","blur .ui-menu":"hideMenu","click .showOnly":"showOnly","click .showAll":"selectAll"},initialize:function(){var a="change:"+this.getSelectionAttribute();this.listenTo(this.collection,a,this.setValue);this.listenTo(this.collection,a,this.render);this.initRender();this.render()},getTemplateParams:function(){var a="",b=this.getButtonLabel(),c=this.getValueAttribute(),d=this.getDisplayAttribute(),
e=this.getItemClass(),f=this;this.collection.each(function(b){var g=b.get(c);b=b.get(d);a+=f.template.simpleMenuItem({name:b,value:g,className:e})});return{menuHtml:a,buttonLabel:b}},lastFocus:null,selectCallback:function(a,b,c){var d=this.getValueAttribute();this.lastFocus=b.item;var e=b.item.find("input[type\x3dhidden]").first().val();a=this.collection.find(function(a){return a.get(d)===e});this.toggleSelected(a)},toggleSelected:function(a){var b=this.getSelectionAttribute(),c=!0;a.has(b)&&(c=!a.get(b));
a.set(b,c);return c},showOnly:function(a){this.unselectAll();a=jQuery(a.target).closest(".ui-menu-item").find("input[type\x3dhidden]").first().val();this.selectItem(a)},selectItem:function(a){var b=this.getValueAttribute(),c=this.getSelectionAttribute();this.collection.find(function(c){return c.get(b)===a}).set(c,!0)},unselectItem:function(a){var b=this.getValueAttribute();a=this.getSelectionAttribute();this.collection.find(function(a){return a.get(b)===itemVal}).set(a,!1)},setValue:function(){var a=
this.getSelectionAttribute(),b=this.getValueAttribute(),c=[];this.collection.each(function(d){d.get(a)&&c.push(d.get(b))});this.$el.attr("ogpValue",c);this.$el.trigger("change")},getValueAsArray:function(){return this.getValue().split(",")},render:function(){var a=this.getSelectionAttribute(),b=this.getValueAttribute(),c=this;this.$el.find("li \x3e a").each(function(){var d=jQuery(this);c.collection.each(function(e){var f=e.get(b);d.next().val()===f&&(e.get(a)?c.uiItemSelected(d[0]):c.uiItemDeselected(d[0]))})});
null!==this.lastFocus&&$(".ui-menu").menu("focus",null,this.lastFocus);return this}});
OpenGeoportal.Views.CollectionMultiSelectWithCheckbox=OpenGeoportal.Views.CollectionMultiSelect.extend({getTemplateParams:function(){var a="",b=this.getButtonLabel(),c=this.getValueAttribute(),d=this.getDisplayAttribute(),e=this.getItemClass(),f=this.options.iconRenderer,h=this.options.controlClass,g=this.getSelectionAttribute(),k=this.options.collectionFilter,l="";"undefined"!==typeof this.options.showOnly&&this.options.showOnly&&(l=this.template.showOnlyControl(),this.checkSelected(),this.listenTo(this.collection,
"change:"+g,this.checkSelected));var m=this;this.collection.each(function(b){if(!("undefined"!=typeof k&&b.get(k.attr)!==k.val)){var n=b.get(c),q=b.get(d),r=f(n),p="checkOff";b.get(g)&&(p="checkOn");b=l+m.template.genericControl({displayClass:p,controlClass:h,text:"",tooltip:""});a+=m.template.controlMenuItem({icon:r,control:b,name:q,value:n,className:e})}});b={menuHtml:a,buttonLabel:b};"undefined"!==typeof this.options.showOnly&&this.options.showOnly&&(b.caption=this.template.selectAllCaption());
return b},selectAll:function(){var a=this.getSelectionAttribute(),b=this.options.collectionFilter;this.collection.each(function(c){"undefined"!=typeof b&&c.get(b.attr)!==b.val||c.set(a,!0)})},unselectAll:function(){var a=this.getSelectionAttribute(),b=this.options.collectionFilter;this.collection.each(function(c){"undefined"!=typeof b&&c.get(b.attr)!==b.val||c.set(a,!1)})},allSelected:function(){var a=this.getSelectionAttribute(),b=this.options.collectionFilter,c=!0;this.collection.each(function(d){"undefined"!=
typeof b&&d.get(b.attr)!==b.val||d.get(a)||(c=!1)});return c},noneSelected:function(){var a=this.getSelectionAttribute(),b=this.options.collectionFilter,c=!0;this.collection.each(function(d){"undefined"!=typeof b&&d.get(b.attr)!==b.val||d.get(a)&&(c=!1)});return c},checkSelected:function(){this.allSelected()?(this.$el.find(".showAll").css("visibility","hidden"),this.$el.prev("label").addClass("offsetColor")):(this.$el.find(".showAll").css("visibility","visible"),this.$el.prev("label").removeClass("offsetColor"))},
uiItemSelected:function(a){jQuery(a).addClass("selected");jQuery(a).find(".checkOff").removeClass("checkOff").addClass("checkOn")},uiItemDeselected:function(a){jQuery(a).removeClass("selected");jQuery(a).find(".checkOn").removeClass("checkOn").addClass("checkOff")}});
OpenGeoportal.Views.Sort=OpenGeoportal.Views.AbstractSelectMenu.extend({initialize:function(){this.headings=this.options.headings;this.listenTo(this.model,"change",this.setValue);this.listenTo(this.model,"change",this.render);this.initRender();this.render()},getTemplateParams:function(){var a="",b=this.model.get("column");that=this;this.headings.each(function(c){if(c.get("organize")){var d=c.get("columnName");c=c.get("displayName")+'\x3cdiv class\x3d"sortArrows"\x3e\x3c/div\x3e';var e="";b.toLowerCase()==
d.toLowerCase()&&(e="selected");a+=that.template.simpleMenuItem({name:c,value:d,className:e})}});return{menuHtml:a,buttonLabel:"Sort Results"}},selectCallback:function(a,b,c){this.model.setColumn(b.item.find("input[type\x3dhidden]").first().val())},setValue:function(){this.$el.attr("ogpValue",this.model.get("column"));this.$el.trigger("change")},render:function(){var a=this,b=this.model.get("column"),c=this.model.get("direction"),d=this.headings.findWhere({columnName:b});d.has("displayName")?d.get("displayName"):
d.get("header");this.$el.find("li \x3e a").each(function(){var d=jQuery(this).find(".sortArrows");d.removeClass("sortDown sortUp");jQuery(this).next().val()==b?(a.uiItemSelected(this),"asc"===c?d.addClass("sortUp"):"desc"===c&&d.addClass("sortDown")):a.uiItemDeselected(this)});return this}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.LoadIndicatorView=Backbone.View.extend({constructor:function(a){this.options=a;Backbone.View.apply(this,arguments)},initialize:function(){this.listenTo(this.collection,"add",this.showSpinner);this.listenTo(this.collection,"remove",this.hideSpinner)},showSpinner:function(){0===jQuery("#"+this.id).length&&this.render();this.startSpinner();this.refreshText();this.$el.is(":visible")||this.$el.show()},refreshText:function(a){0<this.$el.find(".loadInfo").length&&(a="undefined"!==typeof a?
a:this.getDefaultText(),this.$el.find(".loadInfo").html(a))},getDefaultText:function(){return""},hideSpinner:function(){0===this.collection.length&&this.$el.is(":visible")&&(this.$el.hide(),this.stopSpinner())},spinner:null,startSpinner:function(){if(null===this.spinner){var a;a=this.$el.hasClass("loadIndicator")?this.el:this.$el.find(".loadIndicator").first()[0];this.spinner=Spinners.create(a,this.spinnerParams)}this.spinner.play()},stopSpinner:function(){"undefined"!==typeof this.spinner&&this.spinner.stop()}});
OpenGeoportal.Views.MapLoadIndicatorView=OpenGeoportal.Views.LoadIndicatorView.extend({id:"mapLoadIndicator",render:function(){var a=this.options.template.loadIndicator();this.$el.html(a).appendTo(".olControlPanel");return this},spinnerParams:{radius:5,height:5,width:5,dashes:8,color:"#4E4E4F"}});
OpenGeoportal.Views.RequestQueueLoadIndicatorView=OpenGeoportal.Views.LoadIndicatorView.extend({id:"requestTickerContainer",initialize:function(){this.listenTo(this.collection,"add",this.showSpinner);this.listenTo(this.collection,"change:status",this.hideSpinner)},render:function(){var a=this.options.template.requestIndicator();this.$el.html(a).appendTo("body");return this},spinnerParams:{radius:5,height:5,width:5,dashes:8,color:"#000000"},hideSpinner:function(){0!==this.collection.where({status:"PROCESSING"}).length?
this.refreshText():(0===this.collection.length||0===this.collection.where({status:"PROCESSING"}).length)&&this.$el.is(":visible")&&this.$el.fadeOut(400,this.stopSpinner)},getDefaultText:function(){var a="Sending Request...",b=this.collection.getLayerCount();0<b&&(a="Processing "+b,a=1<b?a+" layers...":a+" layer...");jQuery(document).trigger("requestTickerRendered");return a}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.LayerRow=Backbone.View.extend({tagName:"div",className:"tableRow",events:{"click .viewMetadataControl":"viewMetadata","click .previewControl":"togglePreview","click .previewLink":"handlePreviewLink","click .colExpand":"toggleExpand","click .colTitle":"toggleExpand",mouseover:"doMouseoverOn",mouseout:"doMouseoverOff"},constructor:function(a){this.options=a;Backbone.View.apply(this,arguments)},initialize:function(){this.template=OpenGeoportal.ogp.template;this.metadataViewer=new OpenGeoportal.MetadataViewer;
this.previewed=OpenGeoportal.ogp.appState.get("previewed");this.login=OpenGeoportal.ogp.appState.get("login").model;var a=this;this.login.listenTo(this.login,"change:authenticated",function(){a.removeOnLogout.apply(a,arguments);a.render.apply(a,arguments)});this.listenTo(this.model,"change:showControls change:hidden",this.render);this.subClassInit();this.addSubClassEvents();this.subviewStorage();this.render()},subClassInit:function(){},subClassEvents:{},addSubClassEvents:function(){jQuery.extend(this.events,
this.subClassEvents)},subviewStorage:function(){this.subviews=[]},removeOnLogout:function(a){this.login.hasAccess(this.model)||this.model.set({preview:"off"})},viewMetadata:function(){this.metadataViewer.viewMetadata(this.model)},handlePreviewLink:function(){var a=this.getPreviewLink();null===a&&(a=this.getRepositoryLink());window.open(a,"_blank")},getPreviewLink:function(){var a=null;this.model.has("Location")&&"undefined"!==typeof this.model.get("Location").previewLink&&(a=this.model.get("Location").previewLink);
return a},getRepositoryLink:function(){var a=null,b=this.model,a=OpenGeoportal.Config.Repositories.findWhere({id:b.get("Institution").toLowerCase()});if("undefined"==typeof a)throw Error("Repository could not be found");if(a.has("nodeType")){var c=a.get("nodeType");if(a.has("url"))a=a.get("url");else throw Error("Repository definition must have the parameter 'url'");"ogp1"==c?(b={layer:b.get("LayerId"),minX:b.get("MinX"),minY:b.get("MinY"),maxX:b.get("MaxX"),maxY:b.get("MaxY")},a+="/openGeoPortalHome.jsp?"+
jQuery.param(b)):"ogp2"==c?(c=[b.get("MinX"),b.get("MinY"),b.get("MaxX"),b.get("MaxY")].join(),b={ogpids:b.get("LayerId"),bbox:c},a+="/?"+jQuery.param(b)):"geoweb"==c&&(a+="/layer/"+b.get("LayerId"))}else throw Error("Repository type is not defined.");return a},updateView:function(a,b){this.model.get("LayerId")===b.LayerId&&("previewLayerOff"===a.type&&this.model.has("hidden")?this.model.set({hidden:!1}):this.render())},togglePreview:function(a){a=this.model.get("LayerId");a=this.previewed.findWhere({LayerId:a});
if("undefined"===typeof a){a=null;try{a=this.model.attributes,a.preview="on"}catch(b){console.log(b)}this.previewed.add(_.clone(a))}else{var c="",c="on"===a.get("preview")?"off":"on";a.set({preview:c})}},getModelFromPreviewed:function(){var a=this.model.get("LayerId"),b=this.previewed.findWhere({LayerId:a});if("undefined"===typeof b){b=null;try{b=this.model.attributes}catch(c){console.log(c)}this.previewed.add(_.clone(b));return this.previewed.findWhere({LayerId:a})}return b},toggleExpand:function(){var a=
this.model.get("showControls");this.model.set({showControls:!a})},skipLayer:function(){return!1},close:function(){this.closeSubviews&&this.closeSubviews();this.remove();this.stopListening();if(this.onClose)this.onClose()},closeSubviews:function(){_.each(this.subviews,function(a){a.close?a.close():(a.remove(),a.stopListening())});this.subviews=[]},render:function(){if(this.skipLayer())return this.$el.html(""),this.$el.addClass("hiddenRow"),this;this.$el.removeClass("hiddenRow");var a="",b=this,c=this.model,
e=this.options.tableConfig.where({visible:!0});_.each(e,function(d){var f="";d.has("modelRender")?(f=d.get("modelRender")(c),a+=b.template.cartCell({colClass:d.get("columnClass"),contents:f})):(f=c.get(d.get("columnName")),a+=b.template.textCartCell({colClass:d.get("columnClass"),contents:f}))});e=this.renderExpand();""!==e?this.$el.html(a).append(e):this.$el.html(a);this.options.tableConfig.each(function(a){var c=a.get("width");a=a.get("columnClass");b.$el.find("."+a).width(c)});return this},renderExpand:function(){var a=
"";this.closeSubviews();if(this.model.get("showControls")){var a=jQuery(this.template.cartPreviewToolsContainer()),b=a.find(".previewTools").first(),c=this.getModelFromPreviewed(),b=new OpenGeoportal.Views.PreviewTools({model:c,el:b});this.subviews.push(b)}return a},doMouseoverOn:function(){this.highlightRow();this.showBounds()},doMouseoverOff:function(){this.unHighlightRow();this.hideBounds()},highlightRow:function(){jQuery(".tableRow").removeClass("rowHover");this.$el.addClass("rowHover")},unHighlightRow:function(){this.$el.removeClass("rowHover")},
showBounds:function(){var a=this.model,b={};b.south=a.get("MinY");b.north=a.get("MaxY");b.west=a.get("MinX");b.east=a.get("MaxX");jQuery(document).trigger("map.showBBox",b)},hideBounds:function(){jQuery(document).trigger("map.hideBBox")}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.LayerTable=Backbone.View.extend({initialize:function(){this.template=OpenGeoportal.ogp.template;this.tableControls=OpenGeoportal.ogp.tableControls;this.tableConfig=this.createTableConfig();this.previewed=OpenGeoportal.ogp.appState.get("previewed");this.adjustColumnsHandler();this.initSubClass();this.subviewStorage();this.render();this.afterRender()},initSubClass:function(){},afterRender:function(){},emptyTableMessage:"No data layers have been added to the collection.",adjustColumnsHandler:function(){var c=
this;jQuery(document).on("panelResizing adjustContents","#left_col",function(){c.adjustColumnSizes()})},createNewRow:function(c){c=new OpenGeoportal.Views.LayerRow({model:c,tableConfig:this.tableConfig});this.appendSubview(c);return c},getTable:function(){return jQuery(this.template.tableView({tableHeader:this.template.tableHeader(this.getHeaderInfo()),tableFooter:this.template.divNoId({elClass:"bottomSpacer"})}))},subviewStorage:function(){this.subviews={rows:[]}},appendSubview:function(c){this.subviews.rows.push(c)},
prependSubview:function(c){this.subviews.rows.unshift(c)},closeFirstSubview:function(){this.subviews.rows.shift().close()},closeLastSubview:function(){this.subviews.rows.pop().close()},closeAllSubview:function(){_.each(this.subviews.rows,function(c){c.close()});this.subviews.rows=[]},updateSubviews:function(){_.each(this.subviews.rows,function(c){c.render()})},renderHeaders:function(){this.$el.children(".tableWrapper").children(".tableHeaders").html(this.template.tableHeader(this.getHeaderInfo()))},
handleEmptyTable:function(c){c.append(this.template.emptyTable({message:this.emptyTableMessage}))},shouldProcessRow:function(c){return!0},render:function(){var c=this,b=this.getTable(),a=0,h=[];this.collection.each(function(b){c.shouldProcessRow(b)&&(b=c.createNewRow(b),h.push(b.el),a++)});0===a?this.handleEmptyTable(b):b.find(".rowContainer").first().prepend(h);this.$el.html(b);this.updateColWidths();this.resizeColumns();this.$el.trigger("render");return this},getHeaderInfo:function(){var c=this.tableConfig.where({visible:!0}),
b=[];_.each(c,function(a){a={header:a.get("header"),columnClass:a.get("columnClass")};b.push(a)});return{headers:b}},updateColWidths:function(){var c=this;this.tableConfig.each(function(b){var a=b.get("width");b=b.get("columnClass");c.$el.find("."+b).width(a)})},adjustColumnSizes:function(){var c=this.tableConfig.where({visible:!0,resizable:!0}),b=this.tableConfig.where({visible:!0,resizable:!1}),a=jQuery(".tableHeaders ."+c[0].get("columnClass")),h=parseInt(a.css("padding-left"))+parseInt(a.css("padding-right"))+
parseInt(a.css("border-right-width"))+parseInt(a.css("border-left-width")),a=c.length;if(0===a)throw Error("No resizable columns!");var d=0;_.each(b,function(a){d+=a.get("width")+h});b=this.$el.parent().width()-d-OpenGeoportal.Utility.getScrollbarWidth();if(!(0>b)){var e=0,n=0;_.each(c,function(a){e+=a.get("width");n+=a.get("minWidth")});if(b!==e){for(;0>b-n;)console.log("should remove a column");a=c.length;if(0!==a){var b=b-e,m=Math.floor(b/a)-h,f=b%a,k=[],g=0;_.each(c,function(a){var b={};b.oldWidth=
a.get("width");b.newWidth=b.oldWidth+m+f;f=0;b.minWidth=a.get("minWidth");k.push(b);b.newWidth<b.minWidth&&(g+=b.minWidth-b.newWidth,b.newWidth=b.minWidth-h)});for(var p in c){var a=c[p],b=k[p],l=b.newWidth-g;l>=b.minWidth?(a.set({width:l}),g=0):(a.set({width:b.minWidth}),g=b.minWidth-b.newWidth+g)}this.updateColWidths()}}}},resizeColumns:function(){var c=this.tableConfig.where({resizable:!0,visible:!0});if(!(2>c.length))for(var b=0;b<c.length-1;b++)if(c.hasOwnProperty(b)){var a=c[b],h=c.slice(b);
if(a.has("resizableApplied")&&a.get("resizableApplied"))try{jQuery(sel).resizable("destroy"),a.set({resizableApplied:!1})}catch(d){}this.addResizableColumn(a,h)}},addResizableColumn:function(c,b){var a=this,h=c.get("columnClass"),d=".rowContainer ."+h,e=a.$el.find(".tableHeaders ."+h);e.resizable({create:function(a,b){c.set({resizableApplied:!0})},alsoResize:d,handles:"e",minWidth:c.get("minWidth"),start:function(h,d){var f=0,k=0,g;for(g in b)var p=b[g],l=a.$el.find(".tableHeaders ."+p.get("columnClass")).width(),
f=f+l,k=k+p.get("minWidth");f-=k-c.get("minWidth");e.resizable("option","maxWidth",f)},resize:function(h,d){var f=d.size.width-d.originalSize.width,k;for(k in b)if(b[k]!==c){if(0===f)break;var g=b[k],e=g.get("width"),l=g.get("minWidth"),q=0,q=e-f;q<=l?(f-=e-l,q=l):f=0;e=a.$el.find(".rowContainer ."+g.get("columnClass"));a.$el.find(".tableHeaders ."+g.get("columnClass")).add(e).width(q)}},stop:function(h,d){c.set({width:e.width()});for(var f in b){var k=b[f],g=a.$el.find(".tableHeaders ."+k.get("columnClass")).width();
k.set({width:g})}a.updateColWidths()}})},solrToCollection:function(c){var b=[];_.each(c.response.docs,function(a){var c={};try{var d=a.Location;2<d.length&&(c=jQuery.parseJSON(d))}catch(e){console.log([a.LayerId,e])}a.Location=c;b.push(a)});return b},addColumns:function(c){var b=this;c.add([{order:0,columnName:"expandControls",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"",columnClass:"colExpand",width:10,modelRender:function(a){a=a.get("showControls");return b.tableControls.renderExpandControl(a)}},
{order:1,columnName:"checkBox",resizable:!1,organize:!1,visible:!0,hidable:!1,header:'\x3cinput type\x3d"checkbox" id\x3d"downloadHeaderCheck" checked /\x3e',columnClass:"colChkBoxes",width:21,modelRender:function(a){return b.tableControls.renderDownloadControl(a.get("isChecked"))}},{order:2,columnName:"DataType",resizable:!1,organize:"group",visible:!0,hidable:!0,displayName:"Data Type",header:"Type",columnClass:"colType",width:30,modelRender:function(a){a=a.get("DataType");return b.tableControls.renderTypeIcon(a)}},
{order:3,columnName:"score",resizable:!0,minWidth:27,width:27,organize:"numeric",visible:!1,hidable:!1,displayName:"Relevancy",header:"Relev",columnClass:"colScore"},{order:4,columnName:"LayerDisplayName",resizable:!0,minWidth:35,width:200,organize:"alpha",visible:!0,hidable:!1,displayName:"Name",header:"Name",columnClass:"colTitle"},{order:5,columnName:"Originator",resizable:!0,minWidth:62,width:86,organize:"group",visible:!0,hidable:!0,displayName:"Originator",header:"Originator",columnClass:"colOriginator"},
{order:6,columnName:"Publisher",resizable:!0,minWidth:58,width:80,organize:"group",visible:!1,hidable:!0,displayName:"Publisher",header:"Publisher",columnClass:"colPublisher"},{order:7,columnName:"ContentDate",organize:"numeric",visible:!1,displayName:"Date",resizable:!0,minWidth:30,width:30,hidable:!0,header:"Date",columnClass:"colDate",modelRender:function(a){a=a.get("ContentDate");return b.tableControls.renderDate(a)}},{order:8,columnName:"Institution",organize:"alpha",visible:!0,hidable:!0,resizable:!1,
displayName:"Repository",header:"Rep",columnClass:"colSource",width:24,modelRender:function(a){a=a.get("Institution");return b.tableControls.renderRepositoryIcon(a)}},{order:9,columnName:"Access",resizable:!1,organize:!1,visible:!1,hidable:!1,header:"Access"},{order:10,columnName:"Metadata",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"Meta",columnClass:"colMetadata",width:30,modelRender:function(a){return b.tableControls.renderMetadataControl()}},{order:11,columnName:"View",resizable:!1,
organize:!1,visible:!0,hidable:!1,header:"View",columnClass:"colPreview",width:39,modelRender:function(a){var c=a.get("LayerId"),d=a.get("Location"),e=a.get("Access").toLowerCase();a=a.get("Institution").toLowerCase();var n=!1,c=b.previewed.findWhere({LayerId:c});"undefined"!==typeof c&&"on"===c.get("preview")&&(n=!0);var m=c=!0;if(d=OpenGeoportal.Utility.hasLocationValueIgnoreCase(d,["wms","arcgisrest","imagecollection"]))m=OpenGeoportal.ogp.appState.get("login").model,c=m.hasAccessLogic(e,a),m=
m.canLoginLogic(a);return b.tableControls.renderPreviewControl(d,c,m,n)}}])},createTableConfig:function(){var c=new OpenGeoportal.TableConfig;this.addColumns(c);return c}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.CartHeader=Backbone.View.extend({initialize:function(){this.template=OpenGeoportal.ogp.template;this.widgets=OpenGeoportal.ogp.widgets;this.render();this.createCartButtons()},render:function(){this.$el.html(this.template.cartHeader())},displayOptionText:function(a,d,b){a=jQuery(a.target);a.hasClass(".button")||(a=a.closest(".button"));b=jQuery("#optionDetails");b.html("\x3cdiv\x3e"+d+"\x3c/div\x3e");"none"===b.css("display")&&(b.show(),jQuery(".arrow_buttons").hide());a.parent().find(".button").removeClass("detailsBottom");
a.addClass("detailsBottom")},getCheckedRows:function(){return this.collection.where({isChecked:!0})},removeRows:function(){this.collection.remove(this.getCheckedRows())},addCartHeaderButton:function(a,d,b,e,c,g){var f=this;this.widgets.appendButton(this.$el,a,d,c).on("mouseover",function(a){f.displayOptionText(a,b,e);g.call(f)})},createCartButtons:function(){var a=this,d=function(c){a.collection.each(function(a){a.set({actionAvailable:"unset"})});a.collection.each(function(a){var b=!1;_.each(c,function(c){a.get("LayerId")===
c.get("LayerId")&&(a.set({actionAvailable:"yes"}),b=!0)});b||a.set({actionAvailable:"no"})})},b=function(a){var b=a.getApplicableLayers();d(b);a.remove()};this.addCartHeaderButton("removeFromCartButton","Remove","Remove selected layers from Cart.","removeFromCart",function(){a.removeRows()},function(){var b=a.getCheckedRows();d(b)});this.addCartHeaderButton("downloadButton","Download","Download highlighted layers to your computer.","download",function(){(new OpenGeoportal.Views.Download({collection:a.collection})).cartAction()},
function(){var c=new OpenGeoportal.Views.Download({collection:a.collection});b(c)});this.addCartHeaderButton("webServiceButton","Web Service","Stream highlighted layers into an application.","webService",function(){(new OpenGeoportal.Views.WebServices({collection:a.collection})).cartAction()},function(){var c=new OpenGeoportal.Views.WebServices({collection:a.collection});b(c)});this.addCartHeaderButton("shareButton","Share","Create a link to share this Cart.","shareLink",function(){(new OpenGeoportal.Views.ShareCart({collection:a.collection})).cartAction()},
function(){var c=new OpenGeoportal.Views.ShareCart({collection:a.collection});b(c)});this.addCartHeaderButton("mapItButton","MapIt","Open highlighted layers in GeoCommons to create maps.","mapIt",function(b){(new OpenGeoportal.Views.MapIt({collection:a.collection})).cartAction()},function(){var c=new OpenGeoportal.Views.MapIt({collection:a.collection});b(c)});var e=function(){jQuery(".arrow_buttons").show();jQuery("#optionDetails").hide();jQuery(".button").removeClass("detailsBottom");jQuery(".cartSelected, .cartAction").removeClass("cartSelected cartAction")};
jQuery("#cartHeader.tableHeader").on("mouseleave",e);jQuery("#optionDetails").on("mouseenter",e)}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.CartRow=OpenGeoportal.Views.LayerRow.extend({subClassEvents:{"click .cartCheckBox":"toggleCheck"},subClassInit:function(){this.listenTo(this.model,"change:isChecked",this.checkedView);this.listenTo(this.model,"change:actionAvailable",this.showActionAvailable);var a=this;jQuery(document).on("previewLayerOn previewLayerOff",this.$el,function(){a.updateView.apply(a,arguments)})},cleanUp:function(){console.log("row view destroyed");jQuery(document).off("previewLayerOn previewLayerOff",
this.$el)},toggleCheck:function(){this.model.set({isChecked:!this.model.get("isChecked")})},checkedView:function(){var a=this.model.get("isChecked");this.$el.find("input.cartCheckBox").prop("checked",a)},showActionAvailable:function(){this.$el.removeClass("cartAction cartSelected");this.model.has("actionAvailable")&&("yes"===this.model.get("actionAvailable")?this.$el.addClass("cartAction cartSelected"):"no"===this.model.get("actionAvailable")&&this.$el.addClass("cartAction"))}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.CartTable=OpenGeoportal.Views.LayerTable.extend({events:{"click #downloadHeaderCheck":"setChecks"},emptyTableMessage:"No data layers have been added to the cart.",initSubClass:function(){this.listenTo(this.collection,"add",this.addedToCart);this.listenTo(this.collection,"remove",this.removedFromCart)},setChecks:function(a){var c=jQuery(a.target).is(":checked");this.collection.each(function(b){b.set({isChecked:c})})},addedToCart:function(a){a.get("LayerId");a.set({isChecked:!0});
this.updateSavedLayersNumber();this.render()},removedFromCart:function(a){a.get("LayerId");this.updateSavedLayersNumber();this.render()},updateSavedLayersNumber:function(){var a=jQuery(".savedLayersNumber");a.text("("+this.collection.length+")");OpenGeoportal.Utility.elementFlash(a.parent())},createNewRow:function(a){return new OpenGeoportal.Views.CartRow({model:a,tableConfig:this.tableConfig})},addSharedLayers:function(){if(0<OpenGeoportal.Config.shareIds.length){var a=this;(new OpenGeoportal.Solr).getLayerInfoFromSolr(OpenGeoportal.Config.shareIds,
function(){a.getLayerInfoSuccess.apply(a,arguments)},function(){a.getLayerInfoError.apply(a,arguments)});return!0}return!1},getLayerInfoSuccess:function(a){a=this.solrToCollection(a);this.collection.add(a);this.previewed.add(a);this.previewed.each(function(a){a.set({previewed:"on"})});jQuery(document).trigger("map.zoomToLayerExtent",{bbox:OpenGeoportal.Config.shareBbox})},getLayerInfoJsonpError:function(){throw Error("The attempt to retrieve layer information from layerIds failed.");},addColumns:function(a){var c=
this;a.add([{order:0,columnName:"expandControls",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"",columnClass:"colExpand",width:10,modelRender:function(b){b=b.get("showControls");return c.tableControls.renderExpandControl(b)}},{order:1,columnName:"checkBox",resizable:!1,organize:!1,visible:!0,hidable:!1,header:'\x3cinput type\x3d"checkbox" id\x3d"downloadHeaderCheck" checked /\x3e',columnClass:"colChkBoxes",width:21,modelRender:function(b){return c.tableControls.renderDownloadControl(b.get("isChecked"))}},
{order:2,columnName:"DataType",resizable:!1,organize:"group",visible:!0,hidable:!0,displayName:"Data Type",header:"Type",columnClass:"colType",width:30,modelRender:function(b){b=b.get("DataType");return c.tableControls.renderTypeIcon(b)}},{order:3,columnName:"score",resizable:!0,minWidth:27,width:27,organize:"numeric",visible:!1,hidable:!1,displayName:"Relevancy",header:"Relev",columnClass:"colScore"},{order:4,columnName:"LayerDisplayName",resizable:!0,minWidth:35,width:200,organize:"alpha",visible:!0,
hidable:!1,displayName:"Name",header:"Name",columnClass:"colTitle"},{order:5,columnName:"Originator",resizable:!0,minWidth:62,width:86,organize:"group",visible:!0,hidable:!0,displayName:"Originator",header:"Originator",columnClass:"colOriginator"},{order:6,columnName:"Publisher",resizable:!0,minWidth:58,width:80,organize:"group",visible:!1,hidable:!0,displayName:"Publisher",header:"Publisher",columnClass:"colPublisher"},{order:7,columnName:"ContentDate",organize:"numeric",visible:!1,displayName:"Date",
resizable:!0,minWidth:30,width:30,hidable:!0,header:"Date",columnClass:"colDate",modelRender:function(b){b=b.get("ContentDate");return c.tableControls.renderDate(b)}},{order:8,columnName:"Institution",organize:"alpha",visible:!0,hidable:!0,resizable:!1,displayName:"Repository",header:"Rep",columnClass:"colSource",width:24,modelRender:function(b){b=b.get("Institution");return c.tableControls.renderRepositoryIcon(b)}},{order:9,columnName:"Access",resizable:!1,organize:!1,visible:!1,hidable:!1,header:"Access"},
{order:10,columnName:"Metadata",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"Meta",columnClass:"colMetadata",width:30,modelRender:function(b){return c.tableControls.renderMetadataControl()}},{order:11,columnName:"View",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"View",columnClass:"colPreview",width:39,modelRender:function(b){var a=b.get("LayerId"),e=b.get("Location"),g=b.get("Access").toLowerCase();b=b.get("Institution").toLowerCase();var f=!1,a=c.previewed.findWhere({LayerId:a});
"undefined"!==typeof a&&"on"===a.get("preview")&&(f=!0);var d=a=!0;if(e=OpenGeoportal.Utility.hasLocationValueIgnoreCase(e,["wms","arcgisrest","imagecollection"]))d=OpenGeoportal.ogp.appState.get("login").model,a=d.hasAccessLogic(g,b),d=d.canLoginLogic(b);return c.tableControls.renderPreviewControl(e,a,d,f)}}])}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!=typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.LeftPanel=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:mode",this.showPanel);var a=this.model.get("openWidth"),c=a-jQuery("#roll_right").width();jQuery("#left_col").show().width(a).css({"margin-left":"-"+c+"px"})},events:{"click .arrow_right":"goRight","click .arrow_left":"goLeft"},goRight:function(){var a=this.model.get("mode");"closed"===a?this.model.set({mode:"open"}):"open"===a&&this.model.set({mode:"fullscreen"})},goLeft:function(){var a=this.model.get("mode");
"fullscreen"===a?this.model.set({mode:"open"}):"open"===a&&this.model.set({mode:"closed"})},setAlsoMoves:function(){jQuery(".olControlPanel,.olControlModPanZoomBar,.olControlMousePosition,.googleLogo").hasClass("slideHorizontal")||jQuery(".olControlPanel,.olControlModPanZoomBar,.olControlMousePosition,.googleLogo").addClass("slideHorizontal")},showPanel:function(){this.setAlsoMoves();var a=this.model.get("mode");"open"===a?"closed"===this.model.previous("mode")?this.showPanelMidRight():this.showPanelMidLeft():
"closed"===a?this.showPanelClosed():"fullscreen"===a&&this.showPanelFullScreen()},showPanelMidRight:function(){jQuery(".slideHorizontal").is(":hidden")&&jQuery(".slideHorizontal").not(".corner").show();jQuery("#roll_right").is(":visible")&&jQuery("#roll_right").hide();var a=this.model.get("openWidth"),c=a-jQuery("#roll_right").width();this.$el.show().width(a).css({"margin-left":-1*c});var b=this;this.$el.add(".slideHorizontal").animate({"margin-left":"+\x3d"+c},{queue:!1,duration:500,complete:function(){jQuery(this).trigger("adjustContents");
b.resizablePanel();jQuery(document).trigger("panelOpen")}});try{this.$el.resizable("enable")}catch(d){}},showPanelMidLeft:function(){var a=this.model.get("openWidth"),c=a-jQuery("#roll_right").width(),b=this;this.$el.show().animate({width:a},{queue:!1,duration:500,complete:function(){jQuery(".slideHorizontal").css({"margin-left":c}).not(".corner").fadeIn();jQuery(this).trigger("adjustContents");b.resizablePanel()}})},showPanelClosed:function(){jQuery(".slideHorizontal").is(":hidden")&&jQuery(".slideHorizontal").not(".corner").show();
var a=this.model.get("openWidth")-jQuery("#roll_right").width();this.$el.add(".slideHorizontal").animate({"margin-left":"-\x3d"+a},{queue:!1,duration:500,complete:function(){jQuery("#roll_right").show()}});this.$el.resizable("disable")},showPanelFullScreen:function(){jQuery("#roll_right").is(":visible")&&jQuery("#roll_right").hide();this.$el.is(":hidden")&&this.$el.show();jQuery(".slideHorizontal").fadeOut();this.$el.animate({width:jQuery("#container").width()-2},{queue:!1,duration:500,complete:function(){jQuery(this).trigger("adjustContents")}})},
resizablePanel:function(){this.setAlsoMoves();var a=this;this.$el.resizable({handles:"se",start:function(c,b){var d=parseInt(jQuery(".slideHorizontal").css("margin-left"));a.model.set({alsoMovesMargin:d});this.prevWidth=b.originalSize.width;b.element.resizable("option","minWidth",a.model.get("panelMinWidth"));d=jQuery("#container").width()-a.model.get("mapMinWidth");b.element.resizable("option","maxWidth",d);b.element.resizable("option","minHeight",jQuery("#container").height());b.element.resizable("option",
"maxHeight",jQuery("#container").height())},prevWidth:null,resize:function(a,b){var d=b.size.width-this.prevWidth;this.prevWidth=b.size.width;jQuery(".slideHorizontal").css({"margin-left":"+\x3d"+d});jQuery(this).trigger("panelResizing")},stop:function(c,b){a.model.set({openWidth:b.size.width});jQuery(this).trigger("adjustContents")}})}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Models)OpenGeoportal.Models={};else if("object"!==typeof OpenGeoportal.Models)throw Error("OpenGeoportal.Models already exists and is not an object");
OpenGeoportal.Models.ImageCollectionUnGeoreferenced=Backbone.Model.extend({defaults:{baseURL:null,layers:null,CQL:null,collectionurl:null,gssUrl:null,windowUrl:"ungeoreferenced",windowTarget:"_blank",windowOptions:"width\x3d800,height\x3d800,status\x3dyes,resizable\x3dyes"},initialize:function(){var a=this.get("parsedLocation"),d=this.get("workspaceName"),b=this.get("CollectionId");if("undefined"!==typeof a.imageCollection)console.log("This layer requires the property 'imageCollection' in the Location field.");
else{var c=null;"undefined"!==typeof a.imageCollection.gssUrl?c=a.imageCollection.gssUrl:"berkeley"===this.get("Institution").toLowerCase()&&(c="http://linuxdev.lib.berkeley.edu:8080/newOGP/gss");var e=null;"undefined"!==typeof a.imageCollection.url&&(e=a.imageCollection.url);var f=null;"undefined"!==typeof a.imageCollection.path&&(f=a.imageCollection.path);var g=null;"undefined"!==typeof a.imageCollection.collectionurl&&(g=a.imageCollection.collectionurl);this.set({gssURL:c,layers:d+":"+b,baseURL:e,
CQL:"PATH\x3d'"+f+"'",collectionurl:g})}}});
OpenGeoportal.ExternalPreviewWindows=Backbone.Collection.extend({initialize:function(){this.listenTo(this,"add",this.openWindow);this.listenTo(this,"remove",this.closeWindow)},openWindow:function(a,d,b){if(a.has("windowUrl")){d=a.get("windowUrl");var c=null;a.has("windowTarget")&&(c=a.get("windowTarget"));b=null;a.has("windowOptions")&&(b=a.get("windowOptions"));b=window.open(d,c,b);a.set({windowReference:b});"undefined"===typeof b.OpenGeoportal&&(b.OpenGeoportal={});b.OpenGeoportal.externalWindowAttr=
a.attributes;var e=this;jQuery(b).unload(function(){e.remove(a)})}else console.log("No url specified for new window.")},closeWindow:function(a,d,b){a.has("windowReference")&&a.get("windowReference").close()}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.CartActionView=Backbone.View.extend({initialize:function(){this.template=OpenGeoportal.ogp.template;this.initView()},initView:function(){},cartFilter:function(a){return a.get("isChecked")},getApplicableLayers:function(){var a=this;return this.collection.filter(function(b){return a.cartFilter(b)})},cartAction:function(){alert("Please implement an override for 'cartAction'")}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Models.DownloadPreferences=Backbone.Model.extend({defaults:{availableFormats:{vectorFormats:[{formatType:"shp",formatDisplay:"ShapeFile (or native)"},{formatType:"kmz",formatDisplay:"KMZ (KML)"}],rasterFormats:[{formatType:"geotiff",formatDisplay:"GeoTIFF (or native)"},{formatType:"kmz",formatDisplay:"KMZ (KML)"}]},vectorChoice:"",rasterChoice:"",isClipped:!0}});
OpenGeoportal.Views.Download=OpenGeoportal.Views.CartActionView.extend({downloadKeys:["wfs","wcs","wms","filedownload","download"],isDownloadAvailable:function(a){var b=a.isPublic();b||(b=OpenGeoportal.ogp.appState.get("login").model.hasAccess(a));b&&(b=OpenGeoportal.Utility.hasLocationValueIgnoreCase(a.get("Location"),this.downloadKeys));return b},cartFilter:function(a){return this.isDownloadAvailable(a)&&a.get("isChecked")},cartAction:function(){var a=this.sortLayersByDownloadType(),b=_.has(a,"ogpServer")&&
0<a.ogpServer.length;b&&(this.downloadRequest=new OpenGeoportal.Models.DownloadRequest,this.downloadRequest.set({layers:a.ogpServer}),this.preferences=new OpenGeoportal.Models.DownloadPreferences,this.setPreferences().then(this.finalizeRequest,this.failHandler1).then(this.sendDownloadRequest,this.failHandler2));var c=_.has(a,"ogpClient")&&0<a.ogpClient.length;c&&this.clientSideDownload(a.ogpClient);if(!b&&!c)if(0===this.collection.length)console.log("cart collection is empty.");else throw Error("No valid layers in the cart collection!");
},failHandler1:function(){alert("finalize request failed")},failHandler2:function(){alert("sendDownloadRequest failed")},clientSideDownload:function(a){throw Error("clientSideDownload needs to be implemented.");},setDownloadAttributes:function(a){var b=a.get("Location"),c=[];OpenGeoportal.Utility.hasLocationValueIgnoreCase(b,["wfs"])&&c.push("shapefile");OpenGeoportal.Utility.hasLocationValueIgnoreCase(b,["wms"])&&c.push("kmz");OpenGeoportal.Utility.hasLocationValueIgnoreCase(b,["wcs"])&&c.push("geotiff");
a.set({downloadType:"ogpServer",downloadFormats:c})},sortLayersByDownloadType:function(){var a=this.getApplicableLayers(),b=this;_.each(a,function(a){b.setDownloadAttributes(a)});var c={};_.each(a,function(a){var b=a.get("downloadType");_.has(c,b)||(c[b]=[]);c[b].push(a)});return c},getPreferencesSelectionContent:function(){var a=this.downloadRequest.get("layers"),b=this.preferences.get("availableFormats"),c=this;if(_.isEmpty(a))return"No layers have been selected.";var d=!1,e=!1;_.each(a,function(a){d=
d||a.isVector();e=e||a.isRaster()});a="\x3cspan\x3eSelect format for:\x3c/span\x3e\x3cbr /\x3e";if(d){var a=a+this.template.formatSelectionControl({controlId:"vectorControl",controlClass:"downloadSelect",controlLabel:"Vector files",formats:b.vectorFormats}),f=b.vectorFormats[0].formatType;this.preferences.set({vectorChoice:f});jQuery(document).on("change","#vectorControl",function(){var a=jQuery(this).val();c.preferences.set({vectorChoice:a})})}e&&(a+=this.template.formatSelectionControl({controlId:"rasterControl",
controlClass:"downloadSelect",controlLabel:"Raster files",formats:b.rasterFormats}),f=b.rasterFormats[0].formatType,this.preferences.set({rasterChoice:f}),jQuery(document).on("change","#rasterControl",function(){var a=jQuery(this).val();this.preferences.set({rasterChoice:a})}));0===a.length?a="The selected layers have an invalid data type and can not be downloaded.":(a+=this.template.clipControl({id:"downloadClipControl",isClipped:this.preferences.get("isClipped")}),jQuery(document).on("change","#downloadClipControl",
function(){this.preferences.set({isClipped:jQuery(this).is(":checked")})}));return a},setPreferences:function(){var a=jQuery.Deferred(),b=this.getPreferencesSelectionContent(),c=this;this.openPreferencesDialog(b).done(function(){try{c.updateModelsWithPreferences(),a.resolveWith(c)}catch(b){a.rejectWith(c)}});return a.promise()},openPreferencesDialog:function(a){var b=jQuery.Deferred();if(0===jQuery("#downloadSettingsDialog").length){var c=this.template.genericDialogShell({elId:"downloadSettingsDialog"});
jQuery("#dialogs").append(c)}c=jQuery("#downloadSettingsDialog");c.html(a);c.addClass("downloadDialog");c.dialog({zIndex:3E3,autoOpen:!1,minHeight:"30px",width:300,title:"Download Settings",resizable:!1,modal:!0,show:"fade",hide:"fade"});c.dialog("option","disabled",!1);a=function(){jQuery(this).dialog("close");jQuery("#optionDetails").html("");jQuery(".downloadSelection, .downloadUnselection").removeClass("downloadSelection downloadUnselection");b.reject()};a=0===this.downloadRequest.get("layers").length?
{Cancel:a}:{Cancel:a,Continue:function(){jQuery(this).dialog("close");b.resolve()}};c.dialog("option","buttons",a);c.dialog("open");return b.promise()},updateModelsWithPreferences:function(){var a="";this.preferences.has("vectorChoice")&&(a=this.preferences.get("vectorChoice"));var b="";this.preferences.has("rasterChoice")&&(b=this.preferences.get("rasterChoice"));var c=this.downloadRequest.get("layers");_.each(c,function(c){c.isVector()?c.set({requestedFormat:a}):c.isRaster()&&c.set({requestedFormat:b})});
this.preferences.get("isClipped")&&(c=OpenGeoportal.ogp.map.getGeodeticExtent(),this.downloadRequest.set({bbox:c}))},finalizeRequest:function(){var a=jQuery.Deferred(),b=this;this.openFinalizeRequestDialog().done(function(){try{b.updateRequestFromFinalize(),a.resolveWith(b,arguments)}catch(c){a.rejectWith(b,arguments)}});return a.promise()},shouldUseHGLOpenDelivery:function(a,b){var c="harvard"===a.get("Institution").toLowerCase(),d=a.isRaster(),e=OpenGeoportal.Utility.arrayContainsIgnoreCase(["geotiff"],
a.get("requestedFormat"));return c&&d&&e},requiresEmailAddress:function(a,b){return this.shouldUseHGLOpenDelivery(a,b)},getEmailAddressElement:function(){var a=this.downloadRequest.get("layers"),b="",c=this,d=!1;_.each(a,function(a){var b=a.get("requestedFormat"),b=c.requiresEmailAddress(a,b);d=d||b;a.set({requiresEmail:b})});d&&(b=this.template.requireEmailAddress());return b},getLayerDownloadNotice:function(){var a=this.downloadRequest.get("layers"),b="",c=0,d=0,e=this;_.each(a,function(a){var b=
a.get("requestedFormat");e.requiresEmailAddress(a,b)?d++:c++});a=d+c;return b=this.template.layerDownloadNotice({emailCount:d,downloadCount:c,total:a,plural:1<a})},openFinalizeRequestDialog:function(){var a=jQuery.Deferred();if(0===jQuery("#downloadFinalizeDialog").length){var b=this.template.genericDialogShell({elId:"downloadFinalizeDialog"});jQuery("#dialogs").append(b)}var b=this.getFinalizeRequestDialogContent(),c=jQuery("#downloadFinalizeDialog");c.html(b);c.addClass("downloadDialog");var d=
this;c.dialog({title:"Download",width:350,show:"fade",hide:"fade",modal:!0,buttons:{Cancel:function(){jQuery(this).dialog("close");jQuery("#optionDetails").html("");jQuery(".downloadSelection, .downloadUnselection").removeClass("downloadSelection downloadUnselection");a.rejectWith(d)},Download:function(){a.resolveWith(d,[c])}}});c.dialog("open");b=jQuery("#emailAddress");0<b.length?b.focus():c.siblings(".ui-dialog-buttonpane").find(".ui-dialog-buttonset \x3e button").last().focus();a.fail(function(){c.dialog("close")});
return a.promise()},showTransferAnimation:function(a){a.parent().delay().effect("transfer",{to:"#requestTickerContainer"},500,function(){a.dialog("close")})},getFinalizeRequestDialogContent:function(){var a=this.getLayerDownloadNotice();return a+=this.getEmailAddressElement()},updateRequestFromFinalize:function(){var a=jQuery("#emailAddress");0<a.length&&(a=a.val().trim(),this.downloadRequest.set({email:a},{validate:!0}))},sendDownloadRequest:function(a){var b=this.downloadRequest.get("layers"),c=
[],d=[],e=OpenGeoportal.ogp.appState.get("requestQueue");_.each(b,function(a){a.has("requiresEmail")&&a.get("requiresEmail")?c.push(a):d.push(a)});var f=this;jQuery(document).one("requestTickerRendered",function(){f.showTransferAnimation(a)});0<c.length?(b=this.downloadRequest.clone(),b.set({layers:c}),e.add(b),0<d.length&&(this.downloadRequest.set({layers:d}),e.add(this.downloadRequest.clone()))):e.add(this.downloadRequest.clone())}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.ShareCart=OpenGeoportal.Views.CartActionView.extend({cartAction:function(){var a=this.getApplicableLayers(),b=[];_.each(a,function(a){b.push(a.get("LayerId"))});var c="";if(0===b.length)c="No layers have been selected.";else{var a=top.location.href.substring(0,top.location.href.lastIndexOf("/"))+"/",c=OpenGeoportal.ogp.map.getGeodeticExtent().toBBOX(),d="?"+jQuery.param({ogpids:b.join(),bbox:c}),c='\x3ctextarea id\x3d"shareText" class\x3d"linkText" \x3e\x3c/textarea\x3e \n\x3cp\x3eUse this link to share this Cart\x3c/p\x3e';
this.getShortLink(a+d)}this.createShareDialog(c)},getShortenLinkPromise:function(a){var b=new jQuery.Deferred;a={url:"shortenLink",data:jQuery.param({link:a}),type:"GET",dataType:"json",success:function(a){b.resolve(a)}};jQuery.ajax(a);return b.promise()},getShortLink:function(a){this.getShortenLinkPromise(a).done(function(a){jQuery("#shareText").attr("rows",OpenGeoportal.Utility.calculateTextAreaRows(a.shortLink));jQuery("#shareDialog").dialog("open");jQuery("#shareText").text(a.shortLink).focus()})},
createShareDialog:function(a){"undefined"==typeof jQuery("#shareDialog")[0]?(a='\x3cdiv id\x3d"shareDialog" class\x3d"dialog"\x3e \n'+a+"\x3c/div\x3e \n",jQuery("#dialogs").append(a),jQuery("#shareDialog").dialog({zIndex:3E3,autoOpen:!1,width:495,height:"auto",title:"Share Cart",resizable:!1,buttons:{Close:function(){jQuery(this).dialog("close");jQuery("#optionDetails").html("");jQuery(".downloadSelection, .downloadUnselection").removeClass("downloadSelection downloadUnselection")}}})):jQuery("#shareDialog").html(a);
jQuery("#shareText").focus(function(){this.select()});return jQuery("#shareDialog")}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.MapIt=OpenGeoportal.Views.CartActionView.extend({cartFilter:function(a){return this.isMapItAvailable(a)},isMapItAvailable:function(a){var b=!1;a.isPublic()&&(a.isVector()&&a.hasOGCEndpoint("wms"))&&(b=!0);return b},cartAction:function(){var a=this.getApplicableLayers(),a=this.createExportParams(a);(new OpenGeoportal.Export.GeoCommons(a)).exportDialog(this)},setMapItAttributes:function(){var a={};this.isMapItAvailable()&&(a={mapit:["GeoCommons"]});this.set(a)},createExportParams:function(a){var b=
{};b.layers=a;b.extent={};a=OpenGeoportal.ogp.map;b.extent.global=a.getSpecifiedExtent("global");b.extent.current=a.getSpecifiedExtent("current");b.extent.maxForLayers=a.getSpecifiedExtent("maxForLayers",b.layers);return b}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.WebServices=OpenGeoportal.Views.CartActionView.extend({cartFilter:function(a){var b=!1;a.has("dynamicWebService")&&a.get("isChecked")&&0<a.get("dynamicWebService").length&&(b=!0);return b},initView:function(){var a=this;this.collection.each(function(b){a.setDynamicWebServiceAttributes(b)})},cartAction:function(){var a=this.getApplicableLayers(),b="",b=_.isEmpty(a)?"No layers have been selected.":this.generateContent(a);this.createDialog(b)},webserviceKeys:["wms","wfs","wcs"],setDynamicWebServiceAttributes:function(a){if(a.isPublic()){var b=
[],c=this.webserviceKeys,f;for(f in c){var d=c[f];a.hasOGCEndpoint(d)&&b.push(d)}c={};c={dynamicWebService:b};a.set(c)}},getWfsUrl:function(a){var b=top.location.href.substring(0,top.location.href.lastIndexOf("/"));return b+="/dynamic/wfs?ogpids\x3d"+a.join()+"\x26request\x3dGetCapabilities"},getWmsUrl:function(a){var b=top.location.href.substring(0,top.location.href.lastIndexOf("/"));return b+="/dynamic/wms?ogpids\x3d"+a.join()+"\x26request\x3dGetCapabilities"},generateWmc:function(a,b,c){a="wmc?ogpids\x3d"+
a.join();a=a+("\x26type\x3d"+b)+("\x26minx\x3d"+c.left+"\x26miny\x3d"+c.bottom+"\x26maxx\x3d"+c.right+"\x26maxy\x3d"+c.top);OpenGeoportal.ogp.widgets.iframeDownload("wmcDownloadIframe",a)},generateContent:function(a){var b=[],c=[];_.each(a,function(a){_.each(a.get("dynamicWebService"),function(d){var e=a.get("LayerId");"wms"===d?_.contains(b,e)||b.push(e):"wfs"===d?_.contains(c,e)||c.push(e):"wcs"===d&&(_.contains(b,e)||b.push(e))})});a={webservices:[],wmc:{title:"Web Map Context (WMC):",caption:"OGC standard for sharing web services. Press the button to generate a WMC file.",
preferenceText:"Choose how the web service will be used: ",preference:[{label:"Analysis",value:"data"},{label:"Display",value:"display"}],preferenceElId:"wmcPreferredType",generateButtonId:"wmcGenerateButton"}};var f=this;jQuery(document).on("click","#wmcGenerateButton",function(){var a=new OpenLayers.Bounds(-180,-90,180,90),c=jQuery("#wmcPreferredType").val();f.generateWmc(b,c,a)});if(0<c.length){var d={url:this.getWfsUrl(c),title:"Web Feature Service (WFS):",caption:"Suitable for analysis. Creates a vector web service. Only available for vector data. Paste the selected link into your desktop mapping software."};
a.webservices.push(d)}0<b.length&&(d={url:this.getWmsUrl(b),title:"Web Mapping Service (WMS):",caption:"Suitable for base maps. Creates a raster web service for all your data. Vector data will be converted to raster format. Paste the selected link into your desktop mapping software."},a.webservices.push(d));d="";return d=0<a.webservices.length?this.template.webServicesDialogContent(a):"No Web Services are available for the selected layers."},createDialog:function(a){var b=jQuery("#shareServicesDialog");
0===b.length&&(b=this.template.genericDialogShell({elId:"shareServicesDialog"}),jQuery("#dialogs").append(b),b=jQuery("#shareServicesDialog"),b.dialog({zIndex:3E3,autoOpen:!1,height:"auto",title:"Web Services",width:495,close:function(a,b){},buttons:{Close:function(){jQuery(this).dialog("close");jQuery("#optionDetails").html("");jQuery(".downloadSelection, .downloadUnselection").removeClass("downloadSelection downloadUnselection")}}}));b.html(a);b.find(".button").button();jQuery(".shareServicesText").each(function(){jQuery(this).attr("rows",
OpenGeoportal.Utility.calculateTextAreaRows(jQuery(this).text()))});b.dialog("open");jQuery(".shareServicesText").bind("focus",function(){this.select()});jQuery(".shareServicesText").first().focus()}});if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"==typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!=typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.Query=Backbone.View.extend({initialize:function(){jQuery("#whereField").attr("placeholder",this.model.get("whereExample"));jQuery("#whatField").attr("placeholder",this.model.get("whatExample"));this.widgets=OpenGeoportal.ogp.widgets;this.tableControls=OpenGeoportal.ogp.tableControls;this.geocoder=new OpenGeoportal.Geocoder;var a=this;this.geocoder.geocodeAutocomplete(jQuery("#whereField"));this.widgets.prependButton(jQuery(".basicSearchButtons"),"basicSearchSubmit","Search",function(){a.fireSearchWithZoom()}).addClass("searchButton");
this.solrAutocomplete(jQuery("#advancedOriginatorText"),"OriginatorSort");this.createInstitutionsMenu();this.createDataTypesMenu();this.createTopicsMenu();this.mapInputsToModel();var b=jQuery(".advancedSearchButtons").first();this.widgets.prependButton(b,"advancedSearchSubmit","Search",function(){a.fireSearchWithZoom()}).addClass("searchButton");this.widgets.prependButton(b,"advancedSearchClear","Clear",function(){a.clearForm()});this.listenTo(this.model,"change:mapExtent",this.extentChanged);this.mapFilterHandler();
this.searchTypeHandler();this.showRestrictedHandler();this.searchBoxKeypressHandler();jQuery(document).on("map.extentChanged",function(b,d){a.model.setMapExtent(d.mapExtent,d.mapCenter)})},events:{"blur input":"setTextValue"},mapInputsToModel:function(){jQuery("#whatField").data({queryAttr:"what"});jQuery("#whereField").data({queryAttr:"where"});jQuery("#advancedKeywordText").data({queryAttr:"keyword"});jQuery("#advancedOriginatorText").data({queryAttr:"originator"});jQuery("#advancedDateFromText").data({queryAttr:"dateFrom"});
jQuery("#advancedDateToText").data({queryAttr:"dateTo"})},setTextValue:function(a){var b=jQuery(a.currentTarget);a=b.data().queryAttr;b=b.val().trim();this.model.set(a,b)},geocodeBbox:null,handleGeocodeResults:function(a,b){var c=a.bbox;if("undefined"!==typeof c)if(c==this.geocodeBbox)this.fireSearch();else{this.geocodeBbox=c;this.stopListening(this.model,"change:mapExtent",this.clearWhere);b.val(a.name);var d=this;this.listenToOnce(this.model,"change:mapExtent",function(){d.listenToOnce(d.model,
"change:mapExtent",d.clearWhere)});jQuery(document).trigger("map.zoomToLayerExtent",{bbox:c});b.data().geocode={}}else this.fireSearch()},zoomToWhere:function(){var a=jQuery("#whereField"),b=a.data().geocode;if("undefined"!==typeof b&&0<_.size(b))this.handleGeocodeResults(b,a);else if(0<a.val().trim().length){var b=this.geocoder.getGeocodePromise(a.val().trim()),c=this;jQuery.when(b).done(function(b){0<b.values.length?c.handleGeocodeResults(b.values[0],a):c.fireSearch()})}else this.fireSearch()},
clearWhere:function(){var a=jQuery("#whereField");a.data().geocode={};this.geocodeBbox=null;if(0<a.val().trim().length){var b=a.css("color");a.animate({color:"#0755AC"},125).animate({color:b},125).animate({color:"#0755AC"},125).animate({color:b},125).delay(300).animate({color:"#FFFFFF"},300,function(){a.val("").css({color:b})})}},fireSearchWithZoom:function(){"advanced"===this.model.get("searchType")&&this.model.get("ignoreSpatial")?this.fireSearch():this.zoomToWhere()},extentChangeQueue:[],extentChanged:function(){var a=
setTimeout(this.fireSearch,100),b;for(b in this.extentChangeQueue)clearTimeout(this.extentChangeQueue[b]);this.extentChangeQueue.push(a)},fireSearch:function(){jQuery(document).trigger("fireSearch")},searchTypeHandler:function(){var a=this;jQuery(document).on("search.setBasic",function(){a.model.set({searchType:"basic"})});jQuery(document).on("search.setAdvanced",function(){a.model.set({searchType:"advanced"})})},mapFilterHandler:function(){var a=this;jQuery("#mapFilterCheck").on("change",function(b){a.model.set({ignoreSpatial:this.checked})})},
showRestrictedHandler:function(){var a=this;jQuery("#restrictedCheck").on("change",function(b){b=[];b=this.checked?a.model.get("repositoryList").pluck("shortName"):a.model.get("displayRestrictedBasic");a.model.set({displayRestrictedAdvanced:b})})},searchBoxKeypressHandler:function(){var a=this;jQuery(".searchBox").keypress(function(b){"13"==b.keyCode&&(b.preventDefault(),jQuery(b.target).blur(),a.fireSearchWithZoom(),jQuery(b.target).focus())})},createInstitutionsMenu:function(){var a=this.model.get("repositoryList"),
b=this,c=this.tableControls.renderRepositoryIcon,d=function(){var d=new OpenGeoportal.Views.CollectionMultiSelectWithCheckbox({collection:a,el:"div#repositoryDropdown",valueAttribute:"shortName",displayAttribute:"shortName",buttonLabel:"Select repositories",itemClass:"repositoryMenuItem",iconRenderer:c,controlClass:"repositoryCheck",showOnly:!0});b.repositories=d;b.model.set({repository:b.repositories.getValueAsArray()});b.repositories.$el.on("change",function(){b.model.set({repository:b.repositories.getValueAsArray()})})};
if(0===a.length)a.once("sync",d);else d()},createDataTypesMenu:function(){var a=this,b=this.tableControls.renderTypeIcon,c=this.model.get("dataTypeList");this.dataTypes=new OpenGeoportal.Views.CollectionMultiSelectWithCheckbox({collection:c,el:"div#dataTypeDropdown",valueAttribute:"value",displayAttribute:"displayName",buttonLabel:"Select data types",itemClass:"dataTypeMenuItem",iconRenderer:b,controlClass:"dataTypeCheck",showOnly:!0});this.model.set({dataType:this.dataTypes.getValueAsArray()});this.dataTypes.$el.on("change",
function(){a.model.set({dataType:a.dataTypes.getValueAsArray()})})},createTopicsMenu:function(){var a=this.model.get("isoTopicList");this.topics=new OpenGeoportal.Views.CollectionSelect({collection:a,el:"div#topicDropdown",valueAttribute:"topic",displayAttribute:"label",buttonLabel:"Select a topic",itemClass:"isoTopicMenuItem"});this.model.set({isoTopic:this.topics.getValue()});var b=this;this.topics.$el.on("change",function(){b.model.set({isoTopic:b.topics.getValue()})})},clearForm:function(a){this.clearInput("restrictedCheck");
this.clearInput("mapFilterCheck");this.clearInput("advancedKeywordText");this.clearInput("advancedOriginatorText");this.clearInput("advancedDateFromText");this.clearInput("advancedDateToText");this.topics.changeSelected("");this.dataTypes.selectAll();this.repositories.selectAll()},clearInput:function(a){jQuery("#"+a+":input").each(function(){var b=this.type,a=this.tagName.toLowerCase();"text"==b||"password"==b||"search"==b||"textarea"==a?this.value="":"checkbox"==b||"radio"==b?this.checked&&(this.checked=
!1,jQuery(this).trigger("change")):"select"==a&&(this.selectedIndex=0);jQuery(this).trigger("blur")})},solrAutocomplete:function(a,b){a.autocomplete({source:function(a,d){(new OpenGeoportal.Solr).termQuery(b,a.term,function(a){var c=[];a=a.terms[b];for(var e in a)0==e%2&&(c.push({label:a[e],value:'"'+a[e]+'"'}),e++,e++);d(c)},function(){},this)},minLength:2,select:function(a,b){},open:function(){jQuery(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){jQuery(this).removeClass("ui-corner-top").addClass("ui-corner-all")}})}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.PreviewTools=Backbone.View.extend({events:{"click .zoomToLayerControl":"zoomToLayerExtent","click .colorControl":"colorPickerToggle","click .attributeInfoControl":"toggleFeatureInfo","click .sliderArrow":"toggleSlider","mouseleave .controlContainer":"closeSlider"},initialize:function(){this.listenTo(this.model,"change:colorPickerOn",this.colorPicker);this.listenTo(this.model,"change:color",this.updateColorControl);this.listenTo(this.model,"change:getFeature",this.featureInfoButtonState);
this.listenTo(this.model,"change:opacity",this.changeOpacity);this.listenTo(this.model,"change:graphicWidth",this.changeGraphicWidth);this.render()},close:function(){this.stopListening();this.destroyWidgets();this.remove()},destroyWidgets:function(){var a=this.$el.find(".sizeControlCell");this.destroySlider(a);a=this.$el.find(".opacityControlCell");this.destroySlider(a)},setGetFeatureTitle:function(a){a.get("getFeature")&&(this.getFeatureTitle=a.get("LayerDisplayName"))},changeOpacity:function(a,
b,c){a=a.get("opacity");this.updateSlider("opacityControlCell",a)},changeGraphicWidth:function(a,b,c){a=a.get("graphicWidth");this.updateSlider("sizeControlCell",a)},updateSlider:function(a,b){this.$el.find("."+a).find(".sliderValue").text(b)},render:function(){var a="",b=OpenGeoportal.ogp.template;if(this.model.has("opacity"))var c="Adjust layer transparency",a=a+b.sliderControl({controlClass:"opacityControlCell",label:"Opacity",value:this.model.get("opacity"),units:"%",tooltip:c});if(this.model.has("graphicWidth"))var d=
this.model.get("DataType").toLowerCase(),c="Adjust size",a=a+b.sliderControl({controlClass:"sizeControlCell",label:"point"===d?"Pt size":"line"===d?"Ln width":"polygon"===d?"Border":"Width",value:this.model.get("graphicWidth"),units:"px",tooltip:c});this.model.has("color")&&(a+=b.colorControl({color:this.model.get("color")}));a+=b.zoomControl();this.model.has("getFeature")&&(c="attributeInfoControl",c=this.model.get("getFeature")?c+"On":c+"Off",a+=b.getFeatureControl({toolClass:c}));this.$el.html(b.previewTools({toolsMarkup:a}));
return this},createOpacitySlider:function(){var a=this.$el.find(".opacityControlCell");this.destroySlider(a);var b=this.model.get("opacity"),c=this;return this.opacitySlider=a=a.find(".previewToolsSlider").slider({min:0,max:100,step:5,value:b,slide:function(a,b){c.model.set({opacity:b.value})},stop:function(a,b){c.model.set({opacity:b.value})}})},createSizeSlider:function(){var a=this.$el.find(".sizeControlCell");this.destroySlider(a);var b=1,c=6;"polygon"==this.model.get("DataType").toLowerCase()&&
(b=0,c=5);var d=this,e=this.model.get("graphicWidth");return this.sizeSlider=a=a.find(".previewToolsSlider").slider({min:b,max:c,step:1,value:e,slide:function(a,b){},stop:function(a,b){d.model.set({graphicWidth:b.value})}})},createSlider:function(a){a.hasClass("sizeControlCell")?this.createSizeSlider():a.hasClass("opacityControlCell")&&this.createOpacitySlider()},destroySlider:function(a){if(a.hasClass("sizeControlCell"))try{"undefined"!==typeof this.sizeSlider&&null!==this.sizeSlider&&(this.sizeSlider.slider("destroy"),
this.sizeSlider=null)}catch(b){console.log(b)}else if(a.hasClass("opacityControlCell"))try{"undefined"!==typeof this.opacitySlider&&null!==this.opacitySlider&&(this.opacitySlider.slider("destroy"),this.opacitySlider=null)}catch(c){console.log(c)}},toggleSlider:function(a){"none"==jQuery(a.target).siblings(".controlContainer").css("display")?this.openSlider(a):this.closeSlider(a)},openSlider:function(a){var b=jQuery(a.target).parent().parent();this.createSlider(b);jQuery(a.target).siblings(".controlContainer").css("display",
"block")},closeSlider:function(a){var b,c=jQuery(a.target);c.hasClass(".controlContainer")?b=c:(b=c.closest(".controlContainer"),0==b.length&&(b=c.siblings(".controlContainer")));b.css("display","none");a=jQuery(a.target).parent().parent();this.destroySlider(a)},zoomToLayerExtent:function(){var a=[];a.push(this.model.get("MinX"));a.push(this.model.get("MinY"));a.push(this.model.get("MaxX"));a.push(this.model.get("MaxY"));a=a.join();jQuery(document).trigger("map.zoomToLayerExtent",{bbox:a})},colorPickerToggle:function(a){a=
this.model.get("colorPickerOn");this.model.set({colorPickerOn:!a})},colorPicker:function(a){var b=null;a.has("colorDialog")?b=a.get("colorDialog").$el:(b=jQuery('\x3cdiv class\x3d"dialog colorDialog"\x3e\x3c/div\x3e'),b.appendTo("#dialogs").dialog({zIndex:9999,autoOpen:!1,width:"auto",height:"auto",title:"Colors",resizable:!1,close:function(b,d){a.set({colorPickerOn:!1})}}),a.set({colorDialog:new OpenGeoportal.Views.ColorPicker({model:a,el:b})}));a.changed.colorPickerOn?b.dialog("open"):b.dialog("close")},
updateColorControl:function(){var a=this.model.get("color");this.$el.find(".colorControl").css("background-color",a)},toggleFeatureInfo:function(a){this.model.get("getFeature")?this.model.set({getFeature:!1}):this.model.set({getFeature:!0})},featureInfoButtonState:function(a){var b=this.$el.find(".attributeInfoControl");a.get("getFeature")?(b.removeClass("attributeInfoControlOff").addClass("attributeInfoControlOn"),jQuery(".olMap").trigger("attributeInfoOn")):b.removeClass("attributeInfoControlOn").addClass("attributeInfoControlOff");
this.setGetFeatureTitle(a)}});
OpenGeoportal.Views.ColorPicker=Backbone.View.extend({tagName:"div",events:{"click .colorCell":"selectColorCell"},initialize:function(){this.render()},render:function(){var a={grey:"#828282 #aaaaaa #b2b2b2 #cccccc #e1e1e1 #ffffff".split(" "),red:"#730000 #a80000 #e80000 #ff0000 #ff7f7f #ffbebe".split(" "),darkOrange:"#732600 #a83800 #e64c00 #ff5500 #ffa77f #ffebbe".split(" "),orange:"#734c00 #a87000 #e69800 #ffaa00 #ffd37f #ffebaf".split(" "),yellow:"#737300 #a8a800 #e6e600 #ffff00 #ffff73 #ffffbe".split(" "),grassGreen:"#426e00 #6da800 #98e600 #aaff00 #d1ff73 #e9ffbe".split(" "),
green:"#267300 #38a800 #4ce600 #55ff00 #a3ff73 #d3ffbe".split(" "),cyan:"#00734c #00a884 #00e6a9 #00ffc5 #73ffdf #beffe8".split(" "),blue:"#004c73 #0084a8 #00a9e6 #00c5ff #73dfff #bee8ff".split(" "),indigo:"#002673 #0049a9 #005ce6 #0070ff #73b2ff #bed2ff".split(" "),violet:"#4c0073 #8400a8 #a900e6 #c500ff #df73ff #e8beff".split(" "),pink:"#780f52 #a80084 #e00fa7 #ff00c5 #ff73df #ffbee8".split(" ")},b=this.model.get("color"),c="\x3ctable\x3e\x3ctbody\x3e",d=null;for(d in a){var c=c+"\x3ctr\x3e",e=
null;for(e in a[d])c+='\x3ctd class\x3d"colorCellParent"\x3e',c+='\x3cdiv class\x3d"colorCell'+(a[d][e]==b?" colorCellSelected":"")+'" style\x3d"background-color:'+a[d][e]+'"\x3e\x3c/div\x3e',c+="\x3c/td\x3e";c+="\x3c/tr\x3e"}this.$el.html(c+"\x3c/tbody\x3e\x3c/table\x3e");return this},selectColorCell:function(a){a=jQuery(a.target);var b=a.css("background-color");-1<b.indexOf("rgb")&&(b=OpenGeoportal.Utility.rgb2hex(b));this.model.set({color:b});this.$el.find(".colorCell").removeClass("colorCellSelected");
a.addClass("colorCellSelected")}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.PreviewedLayersRow=OpenGeoportal.Views.LayerRow.extend({subClassEvents:{"click .saveControl":"toggleSave"},subClassInit:function(){this.cart=OpenGeoportal.ogp.appState.get("cart");this.listenTo(this.model,"change:preview",this.render);var a=this;jQuery(document).on("cartUpdated",this.$el,function(){a.updateView.apply(a,arguments)})},toggleSave:function(a){if("undefined"===typeof this.cart.findWhere({LayerId:this.model.get("LayerId")})){var b=this;jQuery(a.currentTarget).effect("transfer",
{to:".shoppingCartIcon",easing:"swing",className:"ui-effects-transfer-to-cart inCart"},400,function(){b.cart.toggleCartState(b.model)})}else this.cart.toggleCartState(this.model)},skipLayer:function(){return"off"===this.model.get("preview")?!0:!1}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.PreviewedLayersTable=OpenGeoportal.Views.LayerTable.extend({constructor:function(a){this.options=a;Backbone.View.apply(this,arguments)},initSubClass:function(){this.tableConfig=this.options.tableConfig;this.listenTo(this.collection,"add remove change:preview",this.render);var a=this;this.tableConfig.listenTo(this.collection,"change:visible",function(b){a.updateSubviews.call(a)});this.listenTo(this.collection,"change:showControls",function(){jQuery(document).trigger("previewRow.expand")})},
handleEmptyTable:function(a){a.addClass("hiddenTable")},renderHeaders:function(){},createNewRow:function(a){return new OpenGeoportal.Views.PreviewedLayersRow({model:a,tableConfig:this.tableConfig})},getTable:function(){return jQuery(this.template.tableView({tableHeader:"",tableFooter:""}))},shouldProcessRow:function(a){return"on"===a.get("preview")},createTableConfig:function(){return null}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.SearchResultsRow=OpenGeoportal.Views.LayerRow.extend({subClassEvents:{"click .saveControl":"toggleSave",istop:"broadcastModel"},subClassInit:function(){this.cart=OpenGeoportal.ogp.appState.get("cart");this.expandState=OpenGeoportal.ogp.appState.get("layerState");var b=this.expandState.findWhere({LayerId:this.model.get("LayerId")});"undefined"!==typeof b&&this.model.set({showControls:b.get("expanded")});var a=this;jQuery(document).on("previewLayerOn previewLayerOff cartUpdated",
this.$el,function(){a.updateView.apply(a,arguments)})},onClose:function(){jQuery(document).off("previewLayerOn previewLayerOff cartUpdated",this.$el)},togglePreview:function(b){var a=this.model.get("LayerId"),e=this.previewed.findWhere({LayerId:a});if("undefined"===typeof e){var f=null;try{f=this.model.attributes,f.preview="on",f.showControls=!0}catch(g){console.log(g)}var c=this;this.$el.css("opacity",".5");a=jQuery(".previewedLayers").find(".tableRow").last();0===a.length&&(a=jQuery(".previewedLayers"));
jQuery(b.delegateTarget).effect("transfer",{to:a,easing:"swing",className:"ui-effects-transfer"},400,function(){c.previewed.add(_.clone(f));c.$el.css("opacity","1");c.model.set({hidden:!0})})}else{var d={};"on"===e.get("preview")?(d.preview="off",e.set(d)):(d.preview="on",d.showControls=!0,c=this,this.$el.css("opacity",".5"),a=jQuery(".previewedLayers").find(".tableRow").last(),0===a.length&&(a=jQuery(".previewedLayers")),jQuery(b.delegateTarget).effect("transfer",{to:a,easing:"swing",className:"ui-effects-transfer"},
400,function(){e.set(d);c.$el.css("opacity","1");c.model.set({hidden:!0})}))}},toggleExpand:function(){var b=this.model.get("showControls");this.model.set({showControls:!b});this.expandState.setExpandState(this.model.get("LayerId"),!b)},broadcastModel:function(){this.$el.closest(".rowContainer").trigger("topmodel",[this.model])},skipLayer:function(){return this.model.has("hidden")&&this.model.get("hidden")?!0:!1},toggleSave:function(b){if("undefined"===typeof this.cart.findWhere({LayerId:this.model.get("LayerId")})){var a=
this;jQuery(b.currentTarget).effect("transfer",{to:".shoppingCartIcon",easing:"swing",className:"ui-effects-transfer-to-cart inCart"},400,function(){a.cart.toggleCartState(a.model)})}else this.cart.toggleCartState(this.model)}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Views)OpenGeoportal.Views={};else if("object"!==typeof OpenGeoportal.Views)throw Error("OpenGeoportal.Views already exists and is not an object");
OpenGeoportal.Views.SearchResultsTable=OpenGeoportal.Views.LayerTable.extend({events:{render:"attachEvents",topmodel:"renderPrevPage"},initSubClass:function(){this.cart=OpenGeoportal.ogp.appState.get("cart");this.tableOrganize=new OpenGeoportal.TableSortSettings;this.sortView=new OpenGeoportal.Views.Sort({model:this.tableOrganize,el:$("#sortDropdown"),headings:this.tableConfig});var a=this;this.sortView.listenTo(this.sortView.model,"change",function(){a.collection.newSearch()});this.columnMenu=new OpenGeoportal.Views.CollectionMultiSelectWithCheckbox({collection:this.tableConfig,
el:"div#columnDropdown",collectionFilter:{attr:"hidable",val:!0},valueAttribute:"columnName",displayAttribute:"displayName",selectionAttribute:"visible",buttonLabel:"Columns",itemClass:"columnMenuItem",iconRenderer:function(){return""},controlClass:"columnCheck"});this.listenTo(this.collection,"add",this.appendRender);this.listenTo(this.collection,"reset",this.closeAllSubview);this.listenTo(this.collection,"reset",this.render);this.listenTo(this.collection,"reset",this.updateResultsNumber);jQuery(document).on("search.resize previewRow.expand",
function(){a.setFrameHeight.apply(a,arguments)});this.fireSearchHandler()},afterRender:function(){var a=this,c=this.$(".previewedLayers");this.previewedLayersTable=new OpenGeoportal.Views.PreviewedLayersTable({el:c[0],collection:this.previewed,tableConfig:this.tableConfig});this.tableConfig.listenTo(this.tableConfig,"change:visible",function(b){a.renderHeaders.apply(a,arguments);a.updateSubviews.call(a);a.previewedLayersTable.render();a.adjustColumnSizes()})},scrollOffset:200,attachEvents:function(){this.collection.enableFetch();
var a=this;this.setFrameHeight();this.$el.children(".tableWrapper").children(".rowContainer").off("scroll").on("scroll",function(){a.watchScroll.apply(a,arguments)})},prevScrollY:0,watchScroll:function(a){var c=$(a.target);a=c.scrollTop()+c.height();(c=c[0].scrollHeight)||(c=$(document).height());a>=c-this.scrollOffset&&this.prevScrollY<=a?this.collection.nextPage():a<this.prevScrollY&&0<jQuery(".topSpacer").length&&jQuery(".topSpacer").position().top+jQuery(".topSpacer").height()>-this.scrollOffset&&
this.$el.children(".tableWrapper").children(".rowContainer").children(".tableRow").first().trigger("istop");this.prevScrollY=a},setFrameHeight:function(){var a=this.$el.children(".tableWrapper").children(".rowContainer");if(0!==a.length){var c=0;0<this.$("previewedLayers").length&&(c=this.$("previewedLayers").height());c=Math.ceil(jQuery(document).height()-a.offset().top-c-jQuery("#footer").height());a.height(c)}},fireSearchHandler:function(){var a=this;jQuery(document).on("fireSearch",function(){a.$el.fadeTo("fast",
0.5);a.collection.newSearch();jQuery(document).one("newResults",function(){a.$el.fadeTo("fast",1)})})},emptyTableMessage:"No matching layers.",renderPrevPage:function(a,c){var b=this,h=this.collection.pageParams.rows,d=c.get("resultNum"),f=this.collection.filter(function(b){b=b.get("resultNum");return b<d&&b>=Math.max(d-h,0)}),g=this.$(".topSpacer").first();g.css("min-height",0);var e=this.$el.children(".tableWrapper").children(".rowContainer"),f=f.reverse();_.each(f,function(a){a=b.createNewRow(a,
!0);var c=e.children(".tableRow").first();a=jQuery(a.el).insertBefore(c).height();g.css("height","-\x3d"+a);b.closeLastSubview();a=b.collection.last();b.collection.remove(a)})},appendRender:function(a){var c=this.createNewRow(a),b=this.$el.children(".tableWrapper").children(".rowContainer");b.children(".tableRow").last().after(c.el);200<a.get("resultNum")&&(a=b.children(".tableRow").first(),0===b.children(".topSpacer").length&&b.first().prepend('\x3cdiv class\x3d"topSpacer"\x3e\x3c/div\x3e'),b.children(".topSpacer").first().css("height",
"+\x3d"+a.height()),this.closeFirstSubview())},createNewRow:function(a,c){var b=new OpenGeoportal.Views.SearchResultsRow({model:a,tableConfig:this.tableConfig});"undefined"!==typeof c&&c?this.prependSubview(b):this.appendSubview(b);return b},getTable:function(){return jQuery(this.template.tableView({tableHeader:this.template.tableHeader(this.getHeaderInfo()),tableFooter:""}))},render:function(){var a=this,c=null;0<this.$(".previewedLayers").length&&(c=this.$(".previewedLayers").detach());var b=this.getTable(),
h=0,d=[];this.collection.each(function(b){b=a.createNewRow(b);d.push(b.el);h++});0===h?b.append(this.template.emptyTable({message:this.emptyTableMessage})):b.children(".rowContainer").append(d);null===c&&(c=jQuery('\x3cdiv class\x3d"previewedLayers"\x3e\x3c/div\x3e'));b.children(".tableHeaders").after(c);this.$el.html(b);this.updateColWidths();this.resizeColumns();this.$el.trigger("render");return this},updateResultsNumber:function(){jQuery(".resultsNumber").text(this.collection.totalResults)},addColumns:function(a){var c=
this;a.add([{order:0,columnName:"expandControls",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"",columnClass:"colExpand",width:10,modelRender:function(b){b=b.get("showControls");return c.tableControls.renderExpandControl(b)}},{order:1,columnName:"Save",resizable:!1,organize:!1,visible:!0,hidable:!1,header:'\x3cdiv class\x3d"cartIconTable" title\x3d"Add layers to your cart for download." \x3e\x3c/div\x3e',columnClass:"colSave",width:19,modelRender:function(b){b=b.get("LayerId");var a=!1;"undefined"!==
typeof c.cart.findWhere({LayerId:b})&&(a=!0);return c.tableControls.renderSaveControl(a)}},{order:2,columnName:"DataType",resizable:!1,organize:"group",visible:!0,hidable:!0,displayName:"Data Type",header:"Type",columnClass:"colType",width:30,modelRender:function(b){b=b.get("DataType");return c.tableControls.renderTypeIcon(b)}},{order:3,columnName:"score",resizable:!0,minWidth:27,width:27,organize:"numeric",visible:!1,hidable:!1,displayName:"Relevancy",header:"Relev",columnClass:"colScore"},{order:4,
columnName:"LayerDisplayName",resizable:!0,minWidth:35,width:200,organize:"alpha",visible:!0,hidable:!1,displayName:"Name",header:"Name",columnClass:"colTitle"},{order:5,columnName:"Originator",resizable:!0,minWidth:62,width:86,organize:"group",visible:!0,hidable:!0,displayName:"Originator",header:"Originator",columnClass:"colOriginator"},{order:6,columnName:"Publisher",resizable:!0,minWidth:58,width:80,organize:"group",visible:!1,hidable:!0,displayName:"Publisher",header:"Publisher",columnClass:"colPublisher"},
{order:7,columnName:"ContentDate",organize:"numeric",visible:!1,displayName:"Date",resizable:!0,minWidth:30,width:30,hidable:!0,header:"Date",columnClass:"colDate",modelRender:function(b){b=b.get("ContentDate");return c.tableControls.renderDate(b)}},{order:8,columnName:"Institution",organize:"alpha",visible:!0,hidable:!0,resizable:!1,displayName:"Repository",header:"Rep",columnClass:"colSource",width:24,modelRender:function(b){b=b.get("Institution");return c.tableControls.renderRepositoryIcon(b)}},
{order:9,columnName:"Access",resizable:!1,organize:!1,visible:!1,hidable:!1,header:"Access"},{order:10,columnName:"Metadata",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"Meta",columnClass:"colMetadata",width:30,modelRender:function(b){return c.tableControls.renderMetadataControl()}},{order:11,columnName:"View",resizable:!1,organize:!1,visible:!0,hidable:!1,header:"View",columnClass:"colPreview",width:39,modelRender:function(b){var a=b.get("LayerId"),d=b.get("Location"),f=b.get("Access").toLowerCase();
b=b.get("Institution").toLowerCase();var g=!1,a=c.previewed.findWhere({LayerId:a});"undefined"!==typeof a&&"on"===a.get("preview")&&(g=!0);var e=a=!0;if(d=OpenGeoportal.Utility.hasLocationValueIgnoreCase(d,["wms","arcgisrest","imagecollection"]))e=OpenGeoportal.ogp.appState.get("login").model,a=e.hasAccessLogic(f,b),e=e.canLoginLogic(b);return c.tableControls.renderPreviewControl(d,a,e,g)}}])}});if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");if("undefined"===typeof OpenGeoportal.Export)OpenGeoportal.Export={};else if("object"!==typeof OpenGeoportal.Export)throw Error("OpenGeoportal.Export already exists and is not an object");
OpenGeoportal.Export.GeoCommons=function(d){this.requestQueue=OpenGeoportal.ogp.appState.get("requestQueue");this.template=OpenGeoportal.ogp.template;this.widgets=OpenGeoportal.ogp.widgets;this.layerModels=d.layers;this.descriptor="geoCommonsExport";this.extentOptions={"Layer Max":d.extent.maxForLayers,"Current Map":d.extent.current,Global:d.extent.global};this.exportBasemapOptions={"Acetate (GeoCommons default)":"acetate","Acetate Terrain":"acetateterrain","Google Hybrid":"googlehybrid","Google Satellite":"googleaerial",
"Google Street":"googleroad",OpenStreetMap:"openstreetmap"};this.init=function(){};this.exportDialog=function(){var a=this.getGeoCommonsExportDialogContent(),b=this,c=this.descriptor+"Dialog";this.widgets.dialogTemplate(c,a,"Export Layers to GeoCommons",{Cancel:function(){jQuery(this).dialog("close")},Export:function(){b.exportLayers.call(b);jQuery(this).dialog("close")}});jQuery("#"+c).dialog({width:"375"});jQuery("#"+c).dialog("open");jQuery("#"+c).dialog("moveToTop");jQuery("#"+c).unbind("keypress");
jQuery("#"+c).bind("keypress",function(a){"13"==a.keyCode&&(b.exportLayers(),jQuery("#"+c).dialog("close"))});jQuery("#createGeoCommonsAccountControl").click(function(){window.open("http://geocommons.com/register","geocommons","toolbar\x3d0,menubar\x3d0,status\x3d0,location\x3d0,height\x3d500,width\x3d400")});return jQuery("#"+c)};this.getInputElement=function(a){if("undefined"===typeof a.id)throw Error("id must be defined.");var b=a.id,c=a.type||"text",d=a.value||"",e=a.label||a.name+":"||"",g;g=
jQuery.isArray(a.classes)?a.classes.join(" "):a.classes||"";var h=a.elementType||"textbox",h=h.toLowerCase(),e='\x3clabel for\x3d"'+b+'"\x3e'+e+"\x3c/label\x3e",f;switch(h){case "textbox":f=e+'\x3cinput type\x3d"'+c+'" class\x3d"'+g+'" id\x3d"'+b+'" value\x3d"'+d+'" /\x3e\x3c/br\x3e';break;case "selectbox":f=e+'\x3cselect class\x3d"'+g+'" id\x3d"'+b+'" \x3e';for(var k in a.options)f+='\x3coption value\x3d"'+a.options[k]+'" \x3e'+k+"\x3c/option\x3e";f+="\x3c/select\x3e\x3c/br\x3e"}return f};this.getGeoCommonsExportDialogContent=
function(){var a=this.descriptor,b='\x3cform id\x3d"'+a+'Form"\x3e',c=new Date,c=[c.getMonth(),c.getDate(),c.getFullYear()].join("."),c={elementType:"textbox",id:a+"Title",name:"Title",value:"OGP Export "+c,classes:["dialog",a+"Form"]},b=b+this.getInputElement(c);c.id=a+"Description";c.name="Description";var d=this.layerModels,e=[],g;for(g in d)e.push(d[g].get("LayerDisplayName"));c.value=e.join(", ");b+=this.getInputElement(c);b+=this.getInputElement({elementType:"selectbox",id:a+"Basemap",name:"Basemap",
options:this.exportBasemapOptions,classes:["dialog",a+"Form"]});b+="\x3cfieldset\x3e\x3clegend\x3eGeoCommons Account Info\x3c/legend\x3e";c.id=a+"Username";c.name="Username";c.value=null;b+=this.getInputElement(c);c.id=a+"Password";c.name="Password";c.type="password";b+=this.getInputElement(c);b+='\x3cdiv class\x3d"button linkButton" id\x3d"createGeoCommonsAccountControl"\x3eCreate GeoCommons Account\x3c/div\x3e';b+="\x3c/fieldset\x3e";return b+="\x3c/form\x3e"};this.getBasemapId=function(a){a=a.toLowerCase();
var b=this.exportBasemapOptions;if("undefined"!==b[a])return b[a];throw Error('Basemap "'+a+'" is undefined.');};this.createExportRequest=function(){var a=this.descriptor,b={};b.basemap=jQuery("#"+a+"Basemap").val();b.username=jQuery("#"+a+"Username").val();b.password=jQuery("#"+a+"Password").val();b.bbox=this.extentOptions["Layer Max"];b.title=jQuery("#"+a+"Title").val();b.description=jQuery("#"+a+"Description").val();this.ogpids=[];for(var c in this.layerModels)this.ogpids.push(this.layerModels[c].get("LayerId"));
b.layerIds=this.ogpids;return new OpenGeoportal.Models.GeoCommonsRequest(b)};this.exportLayers=function(){var a=this.createExportRequest();this.requestQueue.add(a)}};if("undefined"===typeof OpenGeoportal)OpenGeoportal={};else if("object"!==typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.MapController=function(){this.previewed=OpenGeoportal.ogp.appState.get("previewed");this.requestQueue=OpenGeoportal.ogp.appState.get("requestQueue");this.template=OpenGeoportal.ogp.template;var k=new OpenGeoportal.Analytics;this.initMap=function(a,b){if("undefined"===typeof a||0===a.length)throw Error("The id of the map div must be specified.");this.containerDiv=a;this.createMapHtml(a);try{this.createOLMap(b)}catch(c){console.log("problem creating ol map"),console.log(c)}this.initBasemaps();
this.addMapToolbarElements();var d=this.WGS84ToMercator(0,0);this.setCenter(d);try{this.registerMapEvents()}catch(e){console.log("problem registering map events"),console.log(e)}};this.createMapHtml=function(a){var b=jQuery("#"+a);if(0===b.length)throw Error("The DIV ["+a+"] does not exist!");a=this.template.map({mapId:a});b.html(a)};this.createOLControls=function(){var a=new OpenLayers.Control.NavigationHistory({nextOptions:{title:"Zoom to next geographic extent"},previousOptions:{title:"Zoom to previous geographic extent"}}),
b=new OpenLayers.Control.ZoomBox({title:"Click or draw rectangle on map to zoom in"}),c=this;b.events.register("activate",this,function(){jQuery(".olMap").css("cursor","-moz-zoom-in");c.previewed.clearGetFeature()});var d=new OpenLayers.Control.Navigation({title:"Pan by dragging the map"});d.events.register("activate",this,function(){jQuery(".olMap").css("cursor","-moz-grab");c.previewed.clearGetFeature()});var e=new OpenLayers.Control.ZoomToMaxExtent({title:"Zoom to global extent"}),f=new OpenLayers.Control.Panel({defaultControl:d}),
g=new OpenLayers.Control.MousePosition({displayProjection:new OpenLayers.Projection("EPSG:4326")});f.addControls([e,a.previous,a.next,b,d]);b=new OpenLayers.Control.ModPanZoomBar;d=new OpenLayers.Control.ScaleLine;e=new OpenLayers.Control.Attribution;return[b,d,g,a,f,e]};this.getInitialZoomLevel=function(){var a=1;810<jQuery("#"+this.containerDiv).parent().height()&&(a=2);return a};this.createOLMap=function(a){this.mapDiv=this.containerDiv+"OLMap";var b=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,
2.003750834E7,2.003750834E7),c=this.createOLControls(),d=this.getInitialZoomLevel(),b={allOverlays:!0,projection:new OpenLayers.Projection("EPSG:3857"),maxResolution:2.8125,maxExtent:b,numZoomLevels:19,units:"m",zoom:d,controls:c};jQuery.extend(a,b);a=1===d?512:jQuery("#"+this.containerDiv).parent().height();jQuery("#"+this.mapDiv).height(a).width(jQuery("#"+this.containerDiv).parent().width());OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.ImgPath="resources/media/";OpenLayers.DOTS_PER_INCH=90.71428571428572;
OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.Map.call(this,"ogpMap",b)};this.initBasemaps=function(){this.basemaps=this.createBaseMaps();var a=this.basemaps.findWhere({name:"googlePhysical"});a.set({selected:!0});a.get("initialRenderCallback").apply(this,[a.get("type")])};this.addMapToolbarElements=function(){this.addMapToolbarButton({displayClass:"saveImageButton",title:"Save map image",buttonText:"Save Image"},this.saveImage);this.addMapToolbarButton({displayClass:"printButton",
title:"Print map",buttonText:"Print"},OpenGeoportal.Utility.doPrint);this.addToMapToolbar(this.template.basemapMenu());this.basemapMenu=new OpenGeoportal.Views.CollectionSelect({collection:this.basemaps,el:"div#basemapMenu",valueAttribute:"name",displayAttribute:"displayName",buttonLabel:"Basemap",itemClass:"baseMapMenuItem"})};this.moveEventId=null;this.registerMapEvents=function(){var a=this;jQuery(document).on("container.resize",function(b,c){jQuery(".olMap").height(Math.max(c.ht,c.minHt));jQuery(".olMap").width(Math.max(c.wd,
c.minWd));a.updateSize()});this.events.register("zoomend",this,function(){var b=a.getZoom();a.basemaps.checkZoom(b);var c=256*(Math.pow(b+1,2)/2),d=jQuery("#"+a.mapDiv).parent().parent().height();c>d&&(c=d);jQuery("#"+a.mapDiv).height()!=c&&(jQuery("#"+a.mapDiv).height(c),a.updateSize());1==b&&a.setCenter(a.WGS84ToMercator(a.getSearchCenter().lon,0))});this.events.register("moveend",this,function(){var b=a.getSearchExtent(),c=a.getSearchCenter();clearTimeout(this.moveEventId);this.moveEventId=setTimeout(function(){jQuery(document).trigger("map.extentChanged",
{mapExtent:b,mapCenter:c})},100)});this.bboxHandler();this.styleChangeHandler();this.opacityHandler();this.zoomToLayerExtentHandler();this.previewLayerHandler();this.getFeatureInfoHandler();this.clearLayersHandler();this.attributeDescriptionHandler();this.mouseCursorHandler();this.loadIndicatorHandler()};this.addToMapToolbar=function(a){jQuery("#ogpMapButtons").append(a)};this.addMapToolbarButton=function(a,b){this.addToMapToolbar(this.template.mapButton(a));var c=this;jQuery("."+a.displayClass).button().on("click",
function(){b.call(c)})};this.googleMapsRenderCallback=function(a){var b=this.getLayersBy("basemapType",a)[0],c=this;this.render(this.mapDiv);google.maps.event.addListener(b.mapObject,"tilesloaded",function(){jQuery(document).trigger("mapReady");google.maps.event.clearListeners(b.mapObject,"tilesloaded");jQuery("div.olLayerGooglePoweredBy").children().css("display","block");jQuery("[id$\x3dGMapContainer]").find('[title*\x3d"Click to see this area"]').parent().addClass("googleLogo");jQuery("#"+c.containerDiv).fadeTo("slow",
1)})};this.initialRenderCallback=function(a){var b=this;this.render(this.mapDiv);var c=this.getLayersBy("basemapType",a)[0];c.events.register(c.mapObject,"loadend",function(){jQuery(document).trigger("mapReady");c.events.unregister(c.mapObject,"loadend");jQuery("#"+b.containerDiv).fadeTo("slow",1)})};this.googleMapsLayerDefinition=function(){return new OpenLayers.Layer.Google(this.get("displayName"),{type:this.get("subType"),basemapType:this.get("type"),layerRole:"basemap"},{animationEnabled:!0})};
this.bingMapsLayerDefinition=function(){var a=new OpenLayers.Layer.Bing({name:this.get("displayName"),type:this.get("subType"),key:"getYourOwnKeyFromMicrosoft"});a.basemapType=this.get("type");a.layerRole="basemap";a.wrapDateLine=!0;return a};this.googleMapsShow=function(a){if(0===this.getLayersBy("basemapType",a.get("type")).length)this.addLayer(a.get("getLayerDefinition").call(a));else{var b=this.getLayersBy("basemapType",a.get("type"))[0];b.mapObject.setMapTypeId(a.get("subType"));b.type=a.get("subType");
b.setVisibility(!0)}jQuery("div.olLayerGooglePoweredBy").children().css("display","block");a.has("secondaryZoomMap")&&a.collection.checkZoom(this.getZoom())};this.bingMapsShow=function(a){0===this.getLayersBy("basemapType",a.get("type")).length?this.addLayer(a.get("getLayerDefinition").call(a)):this.getLayersBy("basemapType",a.get("type"))[0].setVisibility(!0)};this.baseMapHide=function(a){this.getLayersBy("basemapType",a.get("type"))[0].setVisibility(!1)};this.createBaseMaps=function(){var a=this;
return new OpenGeoportal.BasemapCollection([{displayName:"Google Physical",name:"googlePhysical",selected:!1,subType:google.maps.MapTypeId.TERRAIN,type:"Google",zoomLevels:15,secondaryZoomMap:"googleStreets",getLayerDefinition:a.googleMapsLayerDefinition,showOperations:function(){a.googleMapsShow(this)},hideOperations:function(){a.baseMapHide(this);jQuery("div.olLayerGooglePoweredBy").children().css("display","none")},initialRenderCallback:a.googleMapsRenderCallback},{displayName:"Google Hybrid",
name:"googleHybrid",selected:!1,subType:google.maps.MapTypeId.HYBRID,type:"Google",zoomLevels:21,getLayerDefinition:a.googleMapsLayerDefinition,showOperations:function(){a.googleMapsShow(this)},hideOperations:function(){a.baseMapHide(this);jQuery("div.olLayerGooglePoweredBy").children().css("display","none")},initialRenderCallback:a.googleMapsRenderCallback},{displayName:"Google Streets",name:"googleStreets",selected:!1,subType:google.maps.MapTypeId.ROADMAP,type:"Google",zoomLevels:21,getLayerDefinition:a.googleMapsLayerDefinition,
showOperations:function(){a.googleMapsShow(this)},hideOperations:function(){a.baseMapHide(this);jQuery("div.olLayerGooglePoweredBy").children().css("display","none")},initialRenderCallback:a.googleMapsRenderCallback},{displayName:"Google Satellite",name:"googleSatellite",selected:!1,subType:google.maps.MapTypeId.SATELLITE,type:"Google",zoomLevels:21,getLayerDefinition:a.googleMapsLayerDefinition,showOperations:function(){a.googleMapsShow(this)},hideOperations:function(){a.baseMapHide(this);jQuery("div.olLayerGooglePoweredBy").children().css("display",
"none")},initialRenderCallback:a.googleMapsRenderCallback},{displayName:"OpenStreetMap",name:"osm",selected:!1,type:"osm",subType:"osm",zoomLevels:19,getLayerDefinition:function(){var a;a="Tiles \x26copy; \x3ca href\x3d'http://openstreetmap.org/'\x3eOpenStreetMap\x3c/a\x3e contributors, CC BY-SA \x26nbsp;Data \x26copy; \x3ca href\x3d'http://openstreetmap.org/'\x3eOpenStreetMap\x3c/a\x3e contributors, ODbL";return new OpenLayers.Layer.OSM(this.get("displayName"),null,{attribution:a,basemapType:this.get("type"),
layerRole:"basemap"})},showOperations:function(){if(0===a.getLayersBy("basemapType",this.get("type")).length){var b=this.get("getLayerDefinition").call(this),c=a.layers,d=0,e;for(e in c)if("basemap"!=c[e].layerRole){var f=a.getLayerIndex(c[e]);a.setLayerIndex(c[e],f+1)}else d=Math.max(d,a.getLayerIndex(c[e]));a.addLayer(b);a.setLayerIndex(b,d+1)}else a.getLayersBy("basemapType",this.get("type"))[0].setVisibility(!0)},hideOperations:function(){a.baseMapHide(this)},initialRenderCallback:a.initialRenderCallback}])};
this.opacityHandler=function(){var a=this;jQuery(document).on("map.opacityChange",function(b,c){for(var d in a.getLayersBy("ogpLayerId",c.LayerId))a.getLayersBy("ogpLayerId",c.LayerId)[0].setOpacity(0.01*c.opacity)})};this.previewLayerHandler=function(){var a=this;jQuery(document).on("previewLayerOn",function(b,c){a.previewLayerOn(c.LayerId)});jQuery(document).on("previewLayerOff",function(b,c){a.previewLayerOff(c.LayerId)})};this.styleChangeHandler=function(){var a=this;jQuery(document).on("map.styleChange",
function(b,c){a.changeStyle(c.LayerId)})};this.bboxHandler=function(){var a=this;jQuery(document).on("map.showBBox",function(b,c){a.showLayerBBox(c)});jQuery(document).on("map.hideBBox",function(b){a.hideLayerBBox()})};this.getFeatureInfoHandler=function(){var a=this;jQuery(document).on("map.getFeatureInfoOn",function(b,c){var d=a.getLayersBy("ogpLayerId",c.LayerId);if(0==d.length)throw Error("This layer has not yet been previewed.  Please preview it first.");a.events.register("click",d[0],a.getFeatureAttributes)});
jQuery(document).on("map.getFeatureInfoOff",function(b,c){var d=a.getLayersBy("ogpLayerId",c.LayerId);0!=d.length&&a.events.unregister("click",d[0],a.getFeatureAttributes)})};this.zoomToLayerExtentHandler=function(){var a=this;jQuery(document).on("map.zoomToLayerExtent",function(b,c){a.zoomToLayerExtent(c.bbox)})};this.mouseCursorHandler=function(){var a=this;jQuery(document).on("attributeInfoOn",".olMap",function(){jQuery(this).css("cursor","crosshair");var b=a.getControlsByClass("OpenLayers.Control.ZoomBox")[0];
b.active&&b.deactivate();b=a.getControlsByClass("OpenLayers.Control.Navigation")[0];b.active&&b.deactivate()})};this.clearLayersHandler=function(){var a=this,b=jQuery("#mapClearButton");b.button();b.on("click",function(b){a.clearMap()})};this.loadIndicatorHandler=function(){this.indicatorCollection=new OpenGeoportal.LoadIndicatorCollection;this.indicatorView=new OpenGeoportal.Views.MapLoadIndicatorView({collection:this.indicatorCollection,template:this.template});var a=function(a){var b={};b.actionType=
"undefined"===typeof a.loadType?"generic":a.loadType;b.actionId="undefined"===typeof a.layerId?"unspecified":a.layerId;return b},b=this;jQuery(document).on("showLoadIndicator",function(c){b.indicatorCollection.add([a(c)])});jQuery(document).on("hideLoadIndicator",function(c){c=b.indicatorCollection.findWhere(a(c));"undefined"!==typeof c&&b.indicatorCollection.remove(c)})};this.WGS84ToMercator=function(a,b){b=parseFloat(b);a=parseFloat(a);90<=b&&(b=89.99);-90>=b&&(b=-89.99);180<=a&&(a=179.99);-180>=
a&&(a=-179.99);return OpenLayers.Layer.SphericalMercator.forwardMercator(a,b)};this.MercatorToWGS84=function(a,b){b=parseFloat(b);a=parseFloat(a);var c=OpenLayers.Layer.SphericalMercator.inverseMercator(a,b),d=c.lat,c=c.lon;90<d&&(d=90);-90>d&&(d=-90);180<c&&(c=180);-180>c&&(c=-180);return new OpenLayers.LonLat(c,d)};this.getAspectRatio=function(a){return a.getWidth()/a.getHeight()};this.hasMultipleWorlds=function(){var a=this.getZoom()+8,a=Math.pow(2,a);return this.getSize().w-this.getMapOffset().x>
a?!0:!1};this.getMapOffset=function(){var a=jQuery("#"+this.containerDiv).offset(),b=0,c=jQuery("#left_col"),d=c.offset();c.is(":visible")&&(b=c.width()+d.left-a.left);a=jQuery("#tabs").offset().top-a.top;return new OpenLayers.Pixel(b,a)};this.getVisibleExtent=function(){var a=this.getLonLatFromViewPortPx(this.getMapOffset()),b=this.getExtent();b.top=a.lat;4.007501568E7<=b.getWidth()?(b.left=-2.003750834E7,b.right=2.003750834E7):b.left=a.lon;return b};this.adjustExtent=function(){var a=this.getMapOffset(),
b=jQuery("#"+this.mapDiv).height(),c=jQuery("#"+this.mapDiv).width(),d={};d.x=(c-a.x)/c;d.y=(b-a.y)/b;return d};this.getCombinedBounds=function(a){var b=new OpenLayers.Bounds,c;for(c in a)b.extend(a[c]);return b};this.getMaxLayerExtent=function(a){a=this.previewed.get(a).get("bbox").split(",");var b=new OpenLayers.Bounds;b.left=a[0];b.right=a[2];b.top=a[3];b.bottom=a[1];return b};this.boundsToOLObject=function(a){var b=new OpenLayers.Bounds;b.left=a.get("MinX");b.right=a.get("MaxX");b.top=a.get("MaxY");
b.bottom=a.get("MinY");return b};this.getSpecifiedExtent=function(a,b){var c=[],d=null;if("maxForLayers"===a){for(var e in b)d=this.boundsToOLObject(b[e]),c.push(d);d=1<c.length?this.getCombinedBounds(c).toBBOX():c[0].toBBOX()}c={global:"-180,-85,180,85",current:this.getGeodeticExtent().toBBOX(),maxForLayers:d};if("undefined"!==typeof c[a])return c[a];throw Error('Extent type "'+a+'" is undefined.');};this.getBboxFromCoords=function(a,b,c,d){var e=[];e.push(a);e.push(b);e.push(c);e.push(d);return e=
e.join(",")};this.getGeodeticExtent=function(){var a=this.getVisibleExtent(),b=new OpenLayers.Projection("EPSG:900913"),c=new OpenLayers.Projection("EPSG:4326");return a.transform(b,c)};this.getSearchExtent=function(){this.updateSize();return this.getGeodeticExtent()};this.getSearchCenter=function(){var a=new OpenLayers.Projection("EPSG:900913"),b=new OpenLayers.Projection("EPSG:4326"),c=this.getMapOffset(),d=jQuery(".olMap").width(),e=jQuery(".olMap").height();c.x+=d/2;c.y-=e/2;return this.getLonLatFromViewPortPx(c).transform(a,
b)};this.clipToWorld=function(a){return this.clipExtent(a,new OpenLayers.Bounds(-180,-90,180,90))};this.clipExtent=function(a,b){if(a.intersectsBounds(b)){var c=new OpenLayers.Bounds;c.left=Math.max(a.left,b.left);c.top=Math.min(a.top,b.top);c.right=Math.min(a.right,b.right);c.bottom=Math.max(a.bottom,b.bottom);return c}throw Error("The extents don't intersect");};this.getPreviewUrlArray=function(a,b){var c=[],d=function(a){if(1==a.length)for(var b=0;1>b;b++)c[b]=a[0];else c=a},e=OpenGeoportal.Config.getWMSProxy(a.get("Institution"),
a.get("Access"));e&&a.set({wmsProxy:e});a.has("wmsProxy")?d([a.get("wmsProxy")]):"undefined"!==typeof a.get("Location").tilecache&&b?d(a.get("Location").tilecache):d(a.get("Location").wms);return c};this.clearMap=function(){this.previewed.each(function(a){a.set({preview:"off"})})};this.zoomToLayerExtent=function(a){var b=OpenLayers.Bounds.fromString(a);a=this.WGS84ToMercator(b.left,b.bottom);var b=this.WGS84ToMercator(b.right,b.top),c=new OpenLayers.Bounds;c.extend(new OpenLayers.LonLat(a.lon,a.lat));
c.extend(new OpenLayers.LonLat(b.lon,b.lat));var c=c.getSize(),d=this.adjustExtent(),e=c.w/d.x,d=c.h/d.y,c=new OpenLayers.Bounds,e=Math.max(b.lon-e,-2.003750834E7),d=Math.min(a.lat+d,2.003750834E7),b=Math.min(b.lon,2.003750834E7);a=Math.max(a.lat,-2.003750834E7);c.extend(new OpenLayers.LonLat(e,a));c.extend(new OpenLayers.LonLat(b,d));this.zoomToExtent(c)};this.hideLayerBBox=function(){0<this.getLayersByName("layerBBox").length&&this.getLayersByName("layerBBox")[0].removeAllFeatures();jQuery(".corner").hide()};
this.createBBoxLayer=function(){var a=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);a.strokeColor="#1D6EEF";a.fillColor="#DAEDFF";a.fillOpacity=0.25;a.pointRadius=10;a.strokeWidth=4;a.strokeLinecap="butt";a.zIndex=999;return new OpenLayers.Layer.Vector("layerBBox",{style:a,displayOutsideMaxExtent:!0})};this.showLayerBBox=function(a){var b=this.getLayersByName("layerBBox");0<b.length?(b=b[0],this.hideLayerBBox()):(b=this.createBBoxLayer(),this.addLayer(b));var c=this.WGS84ToMercator(a.west,
a.south);a=this.WGS84ToMercator(a.east,a.north);var d=this.getPixelFromLonLat(c),e=this.getPixelFromLonLat(a),f=!1;10>=d.distanceTo(e)&&(f=!0);d=[];if(c.lon>a.lon){var g=this.WGS84ToMercator(180,0).lon,e=(new OpenLayers.Bounds(c.lon,c.lat,g,a.lat)).toGeometry(),g=(new OpenLayers.Bounds(a.lon,a.lat,-1*g,c.lat)).toGeometry();d.push(new OpenLayers.Feature.Vector(e));d.push(new OpenLayers.Feature.Vector(g))}else e=(new OpenLayers.Bounds(c.lon,c.lat,a.lon,a.lat)).toGeometry(),g=new OpenLayers.Feature.Vector(e),
d.push(g);f&&d.push(new OpenLayers.Feature.Vector(e.getCentroid()));b.addFeatures(d);this.setLayerIndex(b,this.layers.length-1);var b=this.getVisibleExtent(),h=this.getGeodeticExtent(),f=b.top;83<h.top&&(f=238107694);d=b.bottom;-83>h.bottom&&(d=-238107694);e=b.left;-179>h.left&&(e=-20037510);g=b.right;180<h.right&&(g=20037510);var h=a.lat,l=c.lat,c=c.lon;a=a.lon;var k=!0;this.hasMultipleWorlds()&&(k=!1,e=-20037510,g=20037510,b.left=e,b.Right=g);if(c<e||a>g||h>f||l<d)h<f&&l>d?k&&(a>g&&this.showCorners(["ne",
"se"]),c<e&&this.showCorners(["sw","nw"])):a<g&&c>e?(h>f&&this.showCorners(["ne","nw"]),l<d&&this.showCorners(["se","sw"])):(h>f&&a>g&&this.showCorners(["ne"]),l<d&&a>g&&this.showCorners(["se"]),h>f&&c<e&&this.showCorners(["nw"]),l<d&&c<e&&this.showCorners(["sw"]))};this.showCorners=function(a){var b={ne:"neCorner",nw:"nwCorner",sw:"swCorner",se:"seCorner"},c;for(c in a)jQuery("#"+b[a[c]]).show()};this.saveImage=function(){var a=this.createImageRequest();this.requestQueue.add(a)};this.createImageRequest=
function(){var a={layers:[]},b;for(b in this.layers){var c=this.layers[b];if("OpenLayers.Layer.WMS"==c.CLASS_NAME&&!1!=c.visibility){var d=this.previewed.findWhere({LayerId:c.ogpLayerId});if("undefined"==typeof d)throw Error("Layer ['"+c.ogpLayerId+"'] could not be found in the PreviewedLayers collection.");var e=d.get("sld"),f=d.get("opacity");if(0!=f){var g={},h=d.get("qualifiedName");g.name=""==h?c.params.LAYERS:h;g.opacity=f;g.zIndex=this.getLayerIndex(c);"undefined"!=typeof e&&(null!==e&&""!=
e)&&(g.sld=this.createSLDFromParams([{wmsName:g.name,layerStyle:e}]));g.layerId=d.get("LayerId");a.layers.push(g)}}}c=this.getVisibleExtent();b=c.toBBOX();a.bbox=b;a.srs="EPSG:3857";b=this.getMapOffset();c=this.getAspectRatio(c);d=this.getCurrentSize();a.width=d.w-b.x;a.height=parseInt(a.width/c);return new OpenGeoportal.Models.ImageRequest(a)};this.processMetadataSolrResponse=function(a){a=a.response;var b=a.numFound;if(1!=b)throw Error("Request for Metadata returned "+b+".  Exactly 1 was expected.");
return a.docs[0]};this.getAttributeDescriptionJsonpSuccess=function(a){jQuery(".attributeName").css("cursor","default");a=this.processMetadataSolrResponse(a);a=jQuery.parseXML(a.FgdcText);var b=jQuery("td.attributeName").first().closest("table").find("caption").attr("title"),c=this.previewed.findWhere({LayerId:b}).get("layerAttributes");jQuery(a).find("attrlabl").each(function(){var a=jQuery(this);jQuery("td.attributeName").each(function(){var b=jQuery(this).text().trim();if(a.text().trim().toLowerCase()==
b.toLowerCase()){var f=a.siblings("attrdef").first(),f=OpenGeoportal.Utility.stripExtraSpaces(f.text().trim());0===f.length&&(f="No description available");jQuery(this).attr("title",f);b=c.findWhere({attributeName:b});"undefined"!=typeof b&&b.set({description:f})}})})};this.getAttributeDescriptionJsonpError=function(){jQuery(".attributeName").css("cursor","default");throw Error("The attribute description could not be retrieved.");};this.attributeDescriptionHandler=function(){var a=this;jQuery(document).on("mouseenter",
"td.attributeName",function(){var b=jQuery(this).closest("table").find("caption").attr("title"),c=a.previewed.findWhere({LayerId:b}).get("layerAttributes").findWhere({attributeName:jQuery(this).text().trim()});"undefined"!==typeof c&&c.has("description")?jQuery(this).attr("title",c.get("description")):(c=new OpenGeoportal.Solr,b=c.getServerName()+"?"+jQuery.param(c.getMetadataParams(b)),jQuery(".attributeName").css("cursor","wait"),c.sendToSolr(b,a.getAttributeDescriptionJsonpSuccess,a.getAttributeDescriptionJsonpError,
a))})};this.getFeatureAttributes=function(a){if("undefined"!==typeof this.map){var b=this.map,c=this.ogpLayerId,d="ogpid\x3d"+c,e=b.getExtent(),d=d+("\x26bbox\x3d"+e.toBBOX());a=a.xy;var d=d+("\x26x\x3d"+Math.round(a.x)+"\x26y\x3d"+Math.round(a.y)),d=d+("\x26height\x3d"+b.size.h+"\x26width\x3d"+b.size.w),d={ogpid:c,bbox:e.toBBOX(),x:Math.round(a.x),y:Math.round(a.y),height:b.size.h,width:b.size.w},e=b.previewed.findWhere({LayerId:c}),f=e.get("LayerDisplayName"),e=e.get("Institution");b.currentAttributeRequests.push({layerId:c,
featureRequest:jQuery.ajax({type:"GET",url:"featureInfo",data:d,dataType:"html",beforeSend:function(){if(0<b.currentAttributeRequests.length)for(var a in b.currentAttributeRequests)b.currentAttributeRequests.splice(a,1)[0].featureRequest.abort();jQuery(document).trigger({type:"showLoadIndicator",loadType:"getFeature",layerId:c})},success:function(a,d,e){b.getFeatureAttributesSuccessCallback(c,f,a)},error:function(a,b,c){if(401!=a.status&&"abort"!=b)throw Error("Error retrieving Feature Information.");
},complete:function(a){for(var d in b.currentAttributeRequests)b.currentAttributeRequests[d].featureRequest===a&&b.currentAttributeRequests.splice(d,1);jQuery(document).trigger({type:"hideLoadIndicator",loadType:"getFeature",layerId:c})}})});k.track("Layer Attributes Viewed",e,c)}else new OpenGeoportal.ErrorObject(Error(),"This layer has not been previewed. \x3cbr/\x3eYou must preview it before getting attribute information.")};this.currentAttributeRequests=[];this.registerAttributes=function(a,b){var c=
this.previewed.findWhere({LayerId:a});if(!c.has("layerAttributes")){var d=new OpenGeoportal.Attributes,e;for(e in b)if(b.hasOwnProperty(e)){var f=new OpenGeoportal.Models.Attribute({attributeName:b[e]});d.add(f)}c.set({layerAttributes:d})}};this.getFeatureAttributesSuccessCallback=function(a,b,c){var d=jQuery(c).filter(function(){return jQuery(this).is("table")}),e=this.template,f="";if(0===d.length||0===jQuery(c).find("tr").length)f='\x3cp\x3eThere is no data for "'+b+'" at this point.\x3c/p\x3e';
else{d=d.first();c=this.processAttributeTable(d);f=e.attributeTable({layerId:a,title:b,tableContent:c});b=[];for(var g in c)b.push(c[g].header);this.registerAttributes(a,b)}"undefined"===typeof jQuery("#featureInfo")[0]&&(a=e.genericDialogShell({elId:"featureInfo"}),jQuery("#dialogs").append(a),jQuery("#featureInfo").dialog({zIndex:2999,title:"Feature Attributes",width:"auto",autoOpen:!1}));jQuery("#featureInfo").fadeOut(200,function(){jQuery("#featureInfo").html(f);var a=jQuery("#container").height(),
b=20*jQuery("#featureInfo tr").length;jQuery("#featureInfo").dialog("option","height",b>a?a:"auto");jQuery("#featureInfo").dialog("open");jQuery("#featureInfo").fadeIn(200)})};this.processAttributeTable=function(a){var b=[];2===a.find("tr").length&&a.find("tr").each(function(){var a=[];(0<jQuery(this).find("th").length?jQuery(this).find("th"):jQuery(this).find("td")).each(function(){var b=jQuery(this).text().trim();0===b.indexOf("http")&&(b='\x3ca href\x3d"'+b+'"\x3e'+b+"\x3c/a\x3e");a.push(b)});
b.push(a)});a=[];if(0<b.length)for(var c=0;c<b[0].length;c++){for(var d={values:[]},e=0;e<b.length;e++)0===e?d.header=b[e][c]:d.values.push(b[e][c]);a.push(d)}return a};this.startService=function(a){var b={};b.AddLayer=[a.get("qualifiedName")];b.ValidationKey="OPENGEOPORTALROCKS";b={url:a.get("Location").serviceStart,dataType:"jsonp",data:b,type:"GET",traditional:!0,complete:function(){jQuery(document).trigger({type:"hideLoadIndicator",loadType:"serviceStart",layerId:a.get("LayerId")})},statusCode:{200:function(){jQuery("body").trigger(a.get("LayerId")+
"Exists")},500:function(){throw Error("layer could not be added");}}};jQuery(document).trigger({type:"showLoadIndicator",loadType:"serviceStart",layerId:a.get("LayerId")});jQuery.ajax(b)};this.setWmsLayerInfo=function(a){var b={type:"GET",url:"info/wmsInfo",data:{ogpid:a.get("LayerId")},dataType:"json",success:function(b){a.set({qualifiedName:b.infoMap.qualifiedName})},error:function(){},complete:function(){jQuery(document).trigger({type:"hideLoadIndicator",loadType:"getWmsInfo",layerId:a.get("LayerId")})}};
jQuery.ajax(b);jQuery("body").trigger(a.get("LayerId")+"Exists");jQuery(document).trigger({type:"showLoadIndicator",loadType:"getWmsInfo",layerId:a.get("LayerId")})};this.layerExists=function(a){"undefined"!==typeof a.get("Location").wms?this.setWmsLayerInfo(a):jQuery("body").trigger(a.get("LayerId")+"Exists")};this.changeStyle=function(a){var b=this.getLayersBy("ogpLayerId",a)[0];if("undefined"===typeof b)console.log("layer with id\x3d['"+a+"'] not found on map.");else{a=this.previewed.findWhere({LayerId:a});
if("undefined"===typeof a)throw Error("This layer can't be found in the PreviewedLayers collection.");var c=a.get("DataType").toLowerCase(),d={},e=a.get("qualifiedName");b.url=this.getPreviewUrlArray(a,!1);var f=a.get("color"),g=a.get("graphicWidth");switch(c){case "polygon":d.symbolizer={};d.symbolizer.Polygon={};d.symbolizer.Polygon.fill=!0;d.symbolizer.Polygon.fillColor=f;0<g&&(d.symbolizer.Polygon.stroke=!0,d.symbolizer.Polygon.strokeWidth=g,d.symbolizer.Polygon.strokeColor=this.getBorderColor(f));
break;case "point":d.symbolizer={};d.symbolizer.Point={};d.symbolizer.Point.fill=!0;d.symbolizer.Point.fillColor=f;d.symbolizer.Point.graphicName="circle";d.symbolizer.Point.pointRadius=g;d.symbolizer.Point.strokeWidth=0;d.symbolizer.Point.strokeColor=f;break;case "line":d.symbolizer={};d.symbolizer.Line={};d.symbolizer.Line.stroke=!0;d.symbolizer.Line.strokeWidth=g;d.symbolizer.Line.strokeColor=f;break;default:return}c={layers:e,sld_body:this.createSLDFromParams([{wmsName:e,layerStyle:d}])};b.mergeNewParams(c);
a.set({sld:d})}};this.getBorderColor=function(a){var b={};b.red=a.slice(1,3);b.green=a.slice(3,5);b.blue=a.slice(5);for(var c in b)a=parseInt(b[c],16)-80,a=0>a?"00":a.toString(16),b[c]=2==a.length?a:1==a.length?"0"+a:"00";return"#"+b.red+b.green+b.blue};this.createSLDFromParams=function(a){var b={namedLayers:[]},c;for(c in a){var d=new OpenLayers.Rule(a[c].layerStyle),d=new OpenLayers.Style("",{rules:[d]}),d={name:a[c].wmsName,userStyles:[d]};b.namedLayers.push(d)}return(new OpenLayers.Format.SLD).write(b)};
this.hideLayer=function(a){a=this.getLayersBy("ogpLayerId",a);for(var b in a)a[b].setVisibility(!1)};this.showLayer=function(a){a=this.getLayersBy("ogpLayerId",a);for(var b in a)a[b].setVisibility(!0)};this.addMapBBox=function(a){var b;b=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);b.strokeColor="green";b.fillColor="green";b.fillOpacity=0.05;b.strokeWidth=2;b.strokeLinecap="butt";b.zIndex=999;b=new OpenLayers.Layer.Vector(a.title,{});this.addLayer(b);var c=a.bbox.split(",");
a=this.WGS84ToMercator(c[0],c[1]);var d=this.WGS84ToMercator(c[2],c[3]);if(a.lon>d.lon){var e=this.WGS84ToMercator(180,0).lon,c=new OpenLayers.Feature.Vector((new OpenLayers.Bounds(a.lon,a.lat,e,d.lat)).toGeometry());a=new OpenLayers.Feature.Vector((new OpenLayers.Bounds(d.lon,d.lat,-1*e,a.lat)).toGeometry());b.addFeatures([c,a])}else a=new OpenLayers.Feature.Vector((new OpenLayers.Bounds(a.lon,a.lat,d.lon,d.lat)).toGeometry()),b.addFeatures([a]);this.setLayerIndex(b,this.layers.length-1)};this.getLayerName=
function(a,b){var c=a.get("Name"),d=a.get("WorkspaceName"),e=c;0<d.length&&-1==c.indexOf(":")&&(e=d+":"+c);a.set({qualifiedName:e});"Harvard"===a.get("Institution")?(d=c.substr(c.indexOf(".")+1),d=d.substr(c.indexOf(":")+1),a.set({tilecacheName:d}),c=a.get("Location").tilecache[0]===b?a.get("tilecacheName"):e):c=e;return c};this.addWMSLayer=function(a){var b=a.get("LayerId"),c=a.get("opacity"),d=this.getLayersBy("ogpLayerId",b),e;for(e in d){this.showLayer(b);d[e].setOpacity(0.01*c);return}1<d.length&&
console.log("ERROR: There should never be more than one copy of the layer on the map");var f=this.getPreviewUrlArray(a,!0),g,b=a.get("DataType");g="Raster"==b||"Paper Map"==b?"image/jpeg":"image/png";var h=this;jQuery("body").bind(a.get("LayerId")+"Exists",function(){var b=h.getLayerName(a,f[0]),b=new OpenLayers.Layer.WMS(a.get("LayerDisplayName"),f,{layers:b,format:g,tiled:!0,exceptions:"application/vnd.ogc.se_xml",transparent:!0,version:"1.3.0"},{transitionEffect:"resize",opacity:0.01*c,ogpLayerId:a.get("LayerId"),
ogpLayerRole:"LayerPreview"});b.events.register("loadstart",b,function(){jQuery(document).trigger({type:"showLoadIndicator",loadType:"layerLoad",layerId:a.get("LayerId")})});b.events.register("loadend",b,function(){jQuery(document).trigger({type:"hideLoadIndicator",loadType:"layerLoad",layerId:a.get("LayerId")})});h.addLayer(b)});this.layerExists(a)};this.addArcGISRestLayer=function(a){var b=new OpenLayers.Layer.ArcGIS93Rest(a.get("LayerDisplayName"),a.get("Location").ArcGISRest,{layers:"show:"+a.get("Name"),
transparent:!0},{buffer:0,transitionEffect:"resize",opacity:a.get("opacity"),ogpLayerId:a.get("LayerId")});b.projection=new OpenLayers.Projection("EPSG:3857");b.events.register("loadstart",b,function(){jQuery(document).trigger({type:"showLoadIndicator",loadType:"layerLoad",layerId:a.get("LayerId")})});b.events.register("loadend",b,function(){jQuery(document).trigger({type:"hideLoadIndicator",loadType:"layerLoad",layerId:a.get("LayerId")})});var c=this;jQuery("body").bind(b.ogpLayerId+"Exists",function(){c.addLayer(b)});
this.layerExists(a)};this.previewBrowseGraphic=function(a){a='\x3cimg src\x3d"'+a.get("Location").browseGraphic+'"/\x3e';"undefined"==typeof jQuery("#browseGraphic")[0]?(jQuery("body").append('\x3cdiv id\x3d"browseGraphic" class\x3d"dialog"\x3e'+a+"\x3c/div\x3e"),jQuery("#browseGraphic").dialog({zIndex:2999,title:"Thumbnail Preview",width:"auto",height:"auto",resizable:!1,autoOpen:!1})):jQuery("#browseGraphic").html(a);jQuery("#browseGraphic").dialog("open")};this.closeBrowseGraphic=function(a){jQuery("#browseGraphic").dialog("close");
jQuery("#browseGraphic").html("")};this.externalPreviewWindows=new OpenGeoportal.ExternalPreviewWindows;this.openImageCollectionUnGeoReferenced=function(a){a=new OpenGeoportal.Models.ImageCollectionUnGeoreferenced(a.attributes);this.externalPreviewWindows.add(a)};this.closeImageCollectionUnGeoReferenced=function(a){a=this.externalPreviewWindows.findWhere({LayerId:a});this.externalPreviewWindows.remove(a)};this.getPreviewMethod=function(a,b){var c=[{type:"imagecollection",onHandler:this.openImageCollectionUnGeoReferenced,
offHandler:this.closeImageCollectionUnGeoReferenced},{type:"tilecache",onHandler:this.addWMSLayer,offHandler:this.hideLayer},{type:"wms",onHandler:this.addWMSLayer,offHandler:this.hideLayer},{type:"arcgisrest",onHandler:this.addArcGISRestLayer,offHandler:this.hideLayer},{type:"browsegraphic",onHandler:this.previewBrowseGraphic,offHandler:this.closeBrowseGraphic},{type:"default",onHandler:this.addMapBBox,offHandler:this.hideLayer}],d;for(d in c)if(c[d].type===a)return c[d][b];return c["default"][b]};
this.previewLayerOn=function(a){var b=this.previewed.findWhere({LayerId:a});if("undefined"===typeof b)throw Error("Layer['"+a+"'] not found in PreviewedLayers collection.");try{var c=b.get("previewType"),d=this.getPreviewMethod(c,"onHandler");try{d.call(this,b)}catch(e){throw console.log(e),Error("error in preview on handler.");}k.track("Layer Previewed",b.get("Institution"),a)}catch(f){throw console.log("error in layer on"),console.log(f),b.set({preview:"off"}),Error('Unable to Preview layer "'+
b.get("LayerDisplayName")+'"');}};this.previewLayerOff=function(a){var b=this.previewed.findWhere({LayerId:a}),c=b.get("previewType"),c=this.getPreviewMethod(c,"offHandler");try{c.call(this,a)}catch(d){throw console.log("error in layer off"),new OpenGeoportal.ErrorObject(d,'Unable to remove Previewed layer "'+b.get("LayerDisplayName")+'"');}}};OpenGeoportal.MapController.prototype=Object.create(OpenLayers.Map.prototype);if("undefined"==typeof OpenGeoportal)OpenGeoportal={};else if("object"!=typeof OpenGeoportal)throw Error("OpenGeoportal already exists and is not an object");
OpenGeoportal.Structure=function(){this.template=OpenGeoportal.ogp.template;var e=new OpenGeoportal.Analytics;this.init=function(){this.resizeWindowHandler();this.searchToggleHandler();var a=new OpenGeoportal.Models.LeftPanel;this.panelView=new OpenGeoportal.Views.LeftPanel({model:a,el:"div#left_col"});this.initializeTabs();this.resetHandler();this.aboutHandler();this.contactHandler();this.userHelpHandler()};this.resetHandler=function(){jQuery(".reset").on("click",function(){e.track("Interface","Reset Page");
window.location=window.location})};this.introFlow=function(a){if(a)this.panelView.model.set({mode:"open"}),jQuery("#tabs").tabs({active:1});else{this.showInfoBubble();var b=this;jQuery(document).one("fireSearch",function(a){jQuery("#welcomeBubble").hide({effect:"drop",duration:250,complete:function(){b.panelView.model.set({mode:"open"});jQuery(document).one("panelOpen",function(){b.showDirectionsBubble();jQuery(document).one("click focus",function(){jQuery("#directionsBubble").hide("drop")})})}})})}};
this.initializeTabs=function(){jQuery("#tabs").tabs({active:0,activate:function(a,b){jQuery("#left_col").trigger("adjustContents");var c=b.index;e.track("Interface","Change Tab",1==c&&"Cart Tab"||0==c&&"Search Tab"||"Getting Started Tab")}})};this.aboutHandler=function(){jQuery("#about").dialog({zIndex:2999,title:"About",resizable:!1,minHeight:382,minWidth:473,autoOpen:!1});jQuery("#aboutLink").click(function(){jQuery("#about").dialog("open");e.track("Help","Show About")})};this.contactHandler=function(){jQuery("#contact").dialog({zIndex:2999,
title:"Contact Information",resizable:!1,minHeight:222,minWidth:405,autoOpen:!1});jQuery("#contactLink").click(function(){jQuery("#contact").dialog("open")})};this.userHelpHandler=function(){jQuery("#userGuide").dialog({zIndex:2999,title:"User Guide",resizable:!0,height:425,width:745,autoOpen:!1});jQuery("#userGuideLink").click(function(){0==jQuery("#userGuide").length?jQuery.get(OpenGeoportal.Utility.JspfLocation+"userGuide.jspf",function(a){jQuery("#dialogs").append(a);jQuery("#userGuide").dialog({zIndex:2999,
title:"USER GUIDE",resizable:!0,height:425,width:745,autoOpen:!1});OpenGeoportal.Utility.anchorsToNiceScroll("userGuide",{top:-10,left:-30});jQuery("#userGuide").dialog("open")}):jQuery("#userGuide").dialog("open");e.track("Help","Show User Guide")})};this.resizeWindowHandler=function(){jQuery("#roll_right").width();var a=parseInt(jQuery("#container").css("min-height")),b=parseInt(jQuery("#container").css("min-width")),c=function(){var c=jQuery("#header").height(),d=jQuery("#footer").height(),d=c+
d+4,c=Math.max(jQuery(window).width(),b),d=Math.max(jQuery(window).height()-d,a);jQuery("#container").height(d).width(c);jQuery(document).trigger("container.resize",{ht:d,wd:c,minHt:a,minWd:b})};c();jQuery(window).resize(c)};this.searchToggleHandler=function(){var a=this;jQuery(".searchToggle").on("click",function(){a.toggleSearch(this)})};this.toggleSearch=function(a){a=jQuery(a).attr("id");var b=jQuery(".searchFormRow").height();jQuery(".olControlModPanZoomBar, .olControlPanel, #mapToolBar").addClass("slideVertical");
"moreSearchOptions"===a?(jQuery("#searchForm .basicSearch").hide(),jQuery("#geosearchDiv").removeClass("basicSearch").addClass("advancedSearch"),jQuery("#searchForm .advancedSearch.searchRow1").show(),jQuery("#searchBox").animate({height:"+\x3d"+b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#searchForm .advancedSearch.searchRow2").show();jQuery("#searchBox").animate({height:"+\x3d"+b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#searchForm .advancedSearch.searchRow3").show();
jQuery("#searchBox").animate({height:"+\x3d"+b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#searchForm .advancedSearch.searchRow4").show();jQuery("#lessSearchOptions").focus();jQuery(document).trigger("search.setAdvanced")}})}})}}),jQuery(".slideVertical").animate({"margin-top":"+\x3d"+3*b},{duration:150,easing:"linear",done:function(){jQuery(document).trigger("search.resize")}})):"lessSearchOptions"===a&&(jQuery(".slideVertical").animate({"margin-top":"-\x3d"+3*b},{queue:!1,
duration:150,easing:"linear",done:function(){jQuery(document).trigger("search.resize")}}),jQuery("#searchForm .advancedSearch.searchRow4").hide(),jQuery("#searchBox").animate({height:"-\x3d"+b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#searchForm .advancedSearch.searchRow3").hide();jQuery("#searchBox").animate({height:"-\x3d"+b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#searchForm .advancedSearch.searchRow2").hide();jQuery("#searchBox").animate({height:"-\x3d"+
b},{queue:!1,duration:50,easing:"linear",complete:function(){jQuery("#geosearchDiv").removeClass("advancedSearch").addClass("basicSearch");jQuery("#searchForm .advancedSearch.searchRow1").hide();jQuery("#searchForm .basicSearch").show();jQuery("#moreSearchOptions").focus();jQuery(document).trigger("search.setBasic")}})}})}}))};this.showInfoBubble=function(){this.infoBubble("welcomeBubble",this.template.welcomeText(),{height:335,width:700,top:259,left:269,arrow:"top"})};this.showDirectionsBubble=function(){this.infoBubble("directionsBubble",
this.template.directionsText(),{height:250,width:600,top:259,left:520,arrow:"left"})};this.showDowntimeNotice=function(){jQuery("#dialogs").append('\x3cdiv id\x3d"downtimeNotice" class\x3d"dialog infoDialog"\x3e\x3cp\x3eLayers will be unavailable until later this afternoon while we perform server maintenance. We apologize for the inconvenience.\x3c/p\x3e\x3c/div\x3e');jQuery("#downtimeNotice").dialog({zIndex:2999,title:"Downtime",resizable:!1,minWidth:415,autoOpen:!1});jQuery("#downtimeNotice").dialog("open")};
this.infoBubble=function(a,b,c){var e="top-arrow";"top"==c.arrow?e="top-arrow":"left"==c.arrow&&(e="left-arrow");b=this.template.infoBubble({elId:a,arrowDirection:e,content:b});jQuery("#infoBubbles").append(b);jQuery("#"+a).height(c.height+4).width(c.width+4).css("top",c.top-2).css("left",c.left-2);jQuery("#"+a+" \x3e .infoBubbleText").height(c.height).width(c.width);var d=jQuery("#"+a);d.on("click",".closeBubble",function(){d.fadeOut("slow")}).fadeIn("slow");return d}};